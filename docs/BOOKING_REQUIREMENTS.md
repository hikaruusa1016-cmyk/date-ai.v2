# 予約導線 要件定義（プラン内スポット）

## 背景と目的
デートプラン内の対象スポット（レストラン・映画館・美術館/博物館）について、UIから予約に進める導線を提供する。  
現状は外部サイトへの遷移による予約とし、将来的にアプリ内完結の予約も視野に入れる。

## スコープ
- 対象スポット: レストラン、映画館、美術館/博物館
- 予約体験: 外部サイトへの遷移（公式サイト等）
- 既存のプラン生成、表示、代替スポット機能は維持
- アフィリエイト計測は現時点では必須ではないが、将来追加可能な前提で設計する

## 非スコープ（現時点）
- アプリ内完結予約（在庫確認/決済/予約確定）
- 外部API連携によるリアルタイム空席/チケット状況表示
- 会員登録や決済フロー

## ユーザーストーリー
- ユーザーはプラン内の対象スポットから「予約する」ボタンを押して外部予約サイトへ遷移できる
- 予約先が複数ある場合は選択できる
- 予約リンクが取得できない場合は「予約情報なし」が分かる

## UI要件
- プランの各スポットに「予約」セクションを追加
- 表示形式はボタン（外部リンク）
- 予約導線の表示条件:
  - 対象カテゴリのみ表示
  - 予約リンクがない場合は「予約情報なし」を表示
- 外部リンクは `target="_blank"` + `rel="noopener"` を必須

## データ要件（plan.schedule item）
以下のフィールドを追加（既存の `official_url` / `info_url` はフォールバックとして利用）:
- `booking_links`: Array of
  - `platform` (string): 例 `official`, `tabelog`
  - `url` (string)
  - `display_name` (string): 例 `公式サイトで予約`
  - `icon` (string, optional): 例 `🏠`
  - `type` (string, optional): `official` | `affiliate` | `search`
- `booking_status`: `"available" | "unavailable" | "unknown"`

## 予約リンク生成ルール（サーバー側）
- カテゴリに応じてリンクを生成
  - レストラン: 食べログリンク（既存の `backend/services/affiliate.js` を利用）
  - 映画館/美術館/博物館: 公式サイト（`official_url`）があれば優先
    - 公式URLがない場合は検索リンク（Google等）を作成
- リンク生成が失敗した場合は `booking_status = "unavailable"` とする
- 将来的なアフィリエイト導入を見越し、`booking_links`は複数持てる設計にする

## 既存UIへの統合ポイント
- `frontend/index.html` の `displayPlan` で schedule item を描画する箇所に追加
- 対象カテゴリ判定は `item.category` を利用（未設定の場合はフォールバック）
- 予約リンクは plan 生成時に埋め込まれるため、UIは表示のみを担当

## エラーハンドリング
- `booking_links` が空/undefinedの場合は「予約情報なし」
- 予約リンクが不正なURLの場合はボタンを表示しない
- 予約導線の有無でプラン表示自体が壊れないこと

## セキュリティ/品質
- 外部リンクに `noopener` を付与
- URL生成はサーバー側で行い、フロント側での文字列結合は最小限
- 予約リンク生成エラー時もプラン生成は成功させる

## 受け入れ条件（MVP）
- 対象カテゴリのスポットに予約ボタンが表示される
- 予約リンクがない場合に「予約情報なし」が表示される
- 既存のプラン表示が崩れない
- レストランは食べログの予約リンクが生成される

## 将来拡張（設計前提）
- アプリ内完結予約を実現する場合は、外部予約APIとの契約/連携が必要
- アフィリエイト導線は `booking_links` に追加して拡張可能
