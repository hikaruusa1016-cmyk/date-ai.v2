# スポット代替機能 要件定義

## 概要
生成されたデートプランの各スポットに対して、ユーザーが「このスポットは嫌だ」と思った場合に、別の代替スポットを提案・選択できる機能を追加する。

---

## 1. 機能要件

### 1.1 基本機能
- 生成されたデートプランの各スポット（ランチ、アクティビティ、カフェ、ディナー）に対して、代替候補を表示できる
- ユーザーがワンクリックで代替スポットに差し替えられる
- 差し替えたスポットで地図・スケジュールが自動更新される

### 1.2 代替候補の取得条件
代替候補は以下の条件でフィルタリングする：

#### 必須条件（元のスポットと同じ）
- **カテゴリ**: ランチならランチ、カフェならカフェ
- **エリア**: 同じエリア（渋谷なら渋谷）
- **予算レベル**: 同じ予算レベル（low/medium/high）
- **デートフェーズ**: 同じフェーズ（初デート/2回目/記念日/カジュアル）

#### 除外条件
- **元のスポット**: 現在選択されているスポットは除外
- **既に使用中のスポット**: 同じプラン内の他のスポットとの重複を避ける
  - 例: ランチで使ったレストランをディナーに表示しない

#### 優先順位
1. スポットデータベース内の候補を優先
2. データベースに十分な候補がない場合はGoogle Places APIを使用
3. 最低3-5件の代替候補を提示

---

## 2. UI/UX要件

### 2.1 表示形式

#### パターンA: 各スポットカードに「変更」ボタン
```
┌─────────────────────────────────────┐
│ 🍽️ ランチ                           │
│ 小割烹おはし 渋谷                    │
│ 予算: ¥1500-2500 | 60分              │
│ 理由: 初対面でも会話しやすい         │
│                                      │
│ [📍 地図で見る] [🔄 別の場所を探す]  │
└─────────────────────────────────────┘
```

#### パターンB: インライン展開
クリックで代替候補がその場に展開される
```
┌─────────────────────────────────────┐
│ 🍽️ ランチ                           │
│ ● 小割烹おはし 渋谷 [現在]          │
│                                      │
│ 他の候補:                            │
│ ○ 備中屋左衛門 (¥1500-2500)         │
│ ○ シュマッツ 渋谷神南 (¥1500-2500)  │
│ ○ 楽楽 渋谷 (¥1500-2500)            │
│                                      │
│ [× 閉じる]                           │
└─────────────────────────────────────┘
```

#### パターンC: モーダルダイアログ
別ウィンドウで詳細情報と共に選択
```
┌─────────────────────────────────────┐
│ ランチの代替候補を選択               │
│ ─────────────────────────────────── │
│                                      │
│ ┌─ 備中屋左衛門 ──────────────┐    │
│ │ 予算: ¥1500-2500            │    │
│ │ 所要時間: 60分              │    │
│ │ 理由: 落ち着いた雰囲気      │    │
│ │ [この場所にする]            │    │
│ └────────────────────────────┘    │
│                                      │
│ ┌─ シュマッツ 渋谷神南 ─────────┐  │
│ │ 予算: ¥1500-2500            │    │
│ │ 所要時間: 60分              │    │
│ │ 理由: カジュアルで気軽      │    │
│ │ [この場所にする]            │    │
│ └────────────────────────────┘    │
│                                      │
│ [キャンセル]                         │
└─────────────────────────────────────┘
```

### 2.2 推奨UI
**パターンB（インライン展開）**を推奨
- 理由:
  - ページ遷移なしで素早く選択可能
  - 全体のスケジュールを見ながら選べる
  - モバイルでもスムーズ

---

## 3. 技術要件

### 3.1 バックエンドAPI

#### エンドポイント
```
POST /api/get-alternative-spots
```

#### リクエスト
```json
{
  "category": "restaurant",
  "area": "shibuya",
  "budget": "medium",
  "datePhase": "first",
  "timeSlot": "lunch",
  "mood": "relax",
  "ngConditions": ["outdoor"],
  "excludeSpots": ["小割烹おはし 渋谷", "千鳥渋谷店"],
  "limit": 5
}
```

#### レスポンス
```json
{
  "success": true,
  "alternatives": [
    {
      "name": "備中屋左衛門",
      "place_name": "備中屋左衛門",
      "area": "shibuya",
      "lat": 35.6599,
      "lng": 139.7010,
      "address": "東京都渋谷区...",
      "price_range": "1500-2500",
      "duration": "60min",
      "reason": "落ち着いた雰囲気で会話しやすい",
      "reason_tags": ["初デート向け", "落ち着き"],
      "url": "https://www.google.com/maps/...",
      "official_url": "https://...",
      "rating": 4.2
    },
    // ... 他4件
  ]
}
```

### 3.2 フロントエンド実装

#### 状態管理
```javascript
// 現在のプラン（差し替え可能）
let currentPlan = {
  lunch: { name: "小割烹おはし 渋谷", ... },
  activity: { name: "渋谷区立松濤美術館", ... },
  cafe: { name: "茶亭 羽當 渋谷", ... },
  dinner: { name: "千鳥渋谷店", ... }
};

// 代替候補キャッシュ
let alternativesCache = {
  lunch: [],
  activity: [],
  cafe: [],
  dinner: []
};
```

#### 差し替え処理フロー
1. ユーザーが「別の場所を探す」をクリック
2. 代替候補APIを呼び出し（キャッシュがあればスキップ）
3. 代替候補リストを表示
4. ユーザーが候補を選択
5. `currentPlan`を更新
6. 地図のマーカーを更新
7. スケジュールの移動時間を再計算

---

## 4. データベース要件

### 4.1 スポットデータベース拡張
現在のCSVデータベースで十分対応可能。追加フィールドは不要。

### 4.2 検索クエリ最適化
- 同じ条件での検索を高速化するため、結果をキャッシュ
- 代替候補は最大10件程度を事前取得

---

## 5. 制約事項

### 5.1 代替候補数
- 最低3件、最大10件を表示
- 3件未満の場合: 「十分な代替候補が見つかりませんでした」と表示

### 5.2 地図の更新
- スポット差し替え時、移動時間・距離を再計算
- ルート全体の所要時間が大幅に変わる場合は警告表示
  - 例: 「移動時間が30分増えます。本当に変更しますか？」

### 5.3 パフォーマンス
- 代替候補の取得は2秒以内
- 差し替え後の地図更新は1秒以内

---

## 6. ユーザーストーリー

### ストーリー1: ランチのスポットを変更したい
```
AS ユーザー
I WANT ランチのスポットを別の場所に変更したい
SO THAT 自分の好みに合ったプランにできる

GIVEN デートプランが生成されている
WHEN ランチスポットの「別の場所を探す」ボタンをクリック
THEN 代替候補が3-5件表示される
AND 各候補に予算・理由が表示される
WHEN 候補の1つを選択
THEN ランチスポットが差し替わる
AND 地図のマーカーが更新される
AND 移動時間が再計算される
```

### ストーリー2: カフェのスポットを変更したい
```
AS ユーザー
I WANT カフェのスポットを変更したい
SO THAT もっと雰囲気の良い場所を選びたい

GIVEN デートプランが表示されている
WHEN カフェスポットの「別の場所を探す」をクリック
THEN 代替候補リストが展開される
WHEN 候補の1つをクリック
THEN カフェスポットが差し替わる
AND スケジュールが更新される
```

### ストーリー3: 代替候補が少ない場合
```
AS ユーザー
I WANT スポットを変更したい
BUT 条件に合う代替候補が少ない

GIVEN デートプランが表示されている
WHEN スポットの「別の場所を探す」をクリック
AND 代替候補が2件以下の場合
THEN 「条件に合う候補が少ないため、条件を緩和しますか？」と表示
WHEN 「緩和する」を選択
THEN 予算レベルを1段階広げた候補を表示
```

---

## 7. 実装優先度

### Phase 1: MVP（最小限の実装）
- [x] バックエンドAPI: 代替候補取得エンドポイント
- [ ] フロントエンド: インライン展開UI
- [ ] スポット差し替え機能
- [ ] 地図マーカー更新

### Phase 2: 改善
- [ ] 代替候補のキャッシュ
- [ ] 移動時間の再計算・警告
- [ ] 候補の詳細情報表示（写真、レビュー等）

### Phase 3: 拡張
- [ ] 「この候補をもっと見る」（10件以上表示）
- [ ] フィルタ機能（「もっと安く」「もっと近く」など）
- [ ] お気に入りスポットの保存

---

## 8. 成功指標

### KPI
- 代替スポット機能の使用率: 30%以上
- 1プランあたりの平均差し替え回数: 1-2回
- 差し替え後の満足度: ユーザーフィードバックで測定

### UX指標
- 代替候補表示までの時間: 2秒以内
- スポット差し替え完了までの時間: 5秒以内

---

## 9. 備考

### 考慮事項
- モバイル対応: タップしやすいボタンサイズ（最低44x44px）
- アクセシビリティ: スクリーンリーダー対応
- エラーハンドリング: API失敗時のフォールバック

### 将来的な拡張
- AIによる代替候補の理由説明（「なぜこのスポットがおすすめか」）
- ユーザーの過去の選択履歴から好みを学習
- 「似たスポット」「対照的なスポット」の提案

---

## 10. 関連ドキュメント
- [デートプラン自動生成 要件定義](../README.md)
- [スポットデータベース仕様](../data/DATABASE_INTEGRATION_README.md)
