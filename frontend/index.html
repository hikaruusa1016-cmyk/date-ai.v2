<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³è‡ªå‹•ç”Ÿæˆ | Date AI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .form-section h2 {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 25px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    select,
    input[type="text"],
    input[type="radio"],
    textarea {
      cursor: pointer;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
      resize: vertical;
      min-height: 90px;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radio-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .radio-item:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .radio-item input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    .radio-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .checkbox-item:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-right: 8px;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.05em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .toggle-section {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .toggle-header h3 {
      font-size: 1.1em;
      color: #667eea;
    }

    .toggle-icon {
      font-size: 1.2em;
      color: #667eea;
      transition: transform 0.3s;
    }

    .toggle-icon.expanded {
      transform: rotate(180deg);
    }

    .toggle-content {
      display: none;
      margin-top: 15px;
    }

    .toggle-content.active {
      display: block;
    }

    .quick-adjust {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .quick-adjust button {
      padding: 10px;
      font-size: 0.9em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .plan-section {
      min-height: 400px;
      display: none;
    }

    .plan-section.active {
      display: block;
    }

    .plan-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .plan-summary h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .cost-info {
      font-size: 1.1em;
      opacity: 0.95;
    }

    .schedule {
      margin: 25px 0;
    }

    .schedule h3 {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .schedule-item {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .schedule-item.active {
      background: #f0f4ff;
      border-left-color: #764ba2;
    }

    .time {
      font-size: 1.3em;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .place-name {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .details {
      font-size: 0.9em;
      color: #666;
      margin: 8px 0;
    }

    .reason {
      font-size: 0.9em;
      color: #764ba2;
      font-style: italic;
      margin-top: 8px;
      padding: 8px;
      background: rgba(118, 75, 162, 0.05);
      border-radius: 4px;
    }

    .reason-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .reason-tag {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-section {
      margin-top: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .info-section h3 {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 10px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .info-list {
      list-style: none;
      margin-left: 0;
    }

    .info-list li {
      padding: 8px 0;
      color: #555;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .next-step {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-size: 1.05em;
      font-weight: 600;
    }

    @media (max-width: 960px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.8em;
      }

      .checkbox-group, .quick-adjust {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <!-- Google Maps API -->
  <script>
    window.gm_authFailure = function() {
      console.error('Google Maps authentication failed');
    };

    (async function loadGoogleMaps() {
      try {
        const API_BASE_URL = window.location.hostname === 'localhost'
          ? 'http://localhost:3001'
          : window.location.origin;
        const response = await fetch(`${API_BASE_URL}/api/maps-key`);
        const data = await response.json();

        if (data.apiKey) {
          GOOGLE_MAPS_API_KEY = data.apiKey;
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&callback=Function.prototype`;
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
        }
      } catch (error) {
        console.error('Failed to fetch Maps API key:', error);
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ’˜ ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ AI</h1>
      <p class="subtitle">30ç§’ã§å®Œç’§ãªãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãŒå®Œæˆï¼</p>
    </header>

    <div class="main-content">
      <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-section">
        <h2>ğŸ“ STEP 1: åŸºæœ¬æƒ…å ±ï¼ˆå¿…é ˆï¼‰</h2>
        <form id="planForm">
          <!-- ã‚¨ãƒªã‚¢ -->
          <div class="form-group">
            <label for="area">ãƒ‡ãƒ¼ãƒˆã‚¨ãƒªã‚¢ *</label>
            <select id="area" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="shibuya">æ¸‹è°·</option>
              <option value="shinjuku">æ–°å®¿</option>
              <option value="ginza">éŠ€åº§</option>
              <option value="harajuku">åŸå®¿</option>
              <option value="odaiba">ãŠå°å ´</option>
              <option value="ueno">ä¸Šé‡</option>
              <option value="asakusa">æµ…è‰</option>
              <option value="ikebukuro">æ± è¢‹</option>
            </select>
          </div>

          <!-- ãƒ‡ãƒ¼ãƒˆãƒ•ã‚§ãƒ¼ã‚º -->
          <div class="form-group">
            <label for="phase">ãƒ‡ãƒ¼ãƒˆãƒ•ã‚§ãƒ¼ã‚º *</label>
            <select id="phase" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="first">åˆãƒ‡ãƒ¼ãƒˆ</option>
              <option value="second">2ã€œ3å›ç›®</option>
              <option value="anniversary">è¨˜å¿µæ—¥</option>
              <option value="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
            </select>
          </div>

          <!-- ãƒ‡ãƒ¼ãƒˆæ™‚é–“å¸¯ -->
          <div class="form-group">
            <label for="timeSlot">ãƒ‡ãƒ¼ãƒˆæ™‚é–“å¸¯ *</label>
            <select id="timeSlot" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="lunch">æ˜¼ï¼ˆãƒ©ãƒ³ãƒãƒ¡ã‚¤ãƒ³ï¼‰</option>
              <option value="dinner">å¤œï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ãƒ¡ã‚¤ãƒ³ï¼‰</option>
              <option value="halfday">åŠæ—¥ï¼ˆæ˜¼ã€œå¤•æ–¹ï¼‰</option>
              <option value="fullday">1æ—¥ï¼ˆæœã€œå¤œï¼‰</option>
            </select>
          </div>

          <!-- äºˆç®— -->
          <div class="form-group">
            <label for="budget">äºˆç®—æ„Ÿ *</label>
            <select id="budget" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="low">ä½ï¼ˆ3000-5000å††ï¼‰</option>
              <option value="medium">ä¸­ï¼ˆ7000-10000å††ï¼‰</option>
              <option value="high">é«˜ï¼ˆ15000å††ä»¥ä¸Šï¼‰</option>
            </select>
          </div>

          <button type="submit" id="generateBtn">âœ¨ ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
        </form>

        <!-- STEP2: è©³ç´°è¨­å®šï¼ˆä»»æ„ãƒ»ãƒˆã‚°ãƒ«ï¼‰ -->
        <div class="toggle-section">
          <div class="toggle-header" onclick="toggleStep2()">
            <h3>âš™ï¸ STEP 2: è©³ç´°è¨­å®šï¼ˆä»»æ„ï¼‰</h3>
            <span class="toggle-icon" id="toggleIcon">â–¼</span>
          </div>
      <div class="toggle-content" id="step2Content">
        <!-- ä»Šæ—¥ã®æ°—åˆ† -->
        <div class="form-group" style="margin-top: 15px;">
          <label>ä»Šæ—¥ã®æ°—åˆ†ï¼ˆ1ã¤é¸æŠï¼‰</label>
          <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" id="moodRelax" name="mood" value="relax">
                  <label for="moodRelax">ã®ã‚“ã³ã‚Šãƒªãƒ©ãƒƒã‚¯ã‚¹</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodActive" name="mood" value="active">
                  <label for="moodActive">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å‹•ããŸã„</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodRomantic" name="mood" value="romantic">
                  <label for="moodRomantic">ãƒ­ãƒãƒ³ãƒãƒƒã‚¯ã«éã”ã—ãŸã„</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodCasual" name="mood" value="casual">
                  <label for="moodCasual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«æ¥½ã—ã¿ãŸã„</label>
            </div>
          </div>
        </div>

        <!-- NGæ¡ä»¶ -->
            <div class="form-group">
              <label>NGæ¡ä»¶ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="ngOutdoor" value="outdoor">
                  <label for="ngOutdoor">å±‹å¤–ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngIndoor" value="indoor">
                  <label for="ngIndoor">å±‹å†…ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngCrowd" value="crowd">
                  <label for="ngCrowd">æ··é›‘ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngQuiet" value="quiet">
                  <label for="ngQuiet">é™ã‹ã™ãã‚‹å ´æ‰€ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngWalk" value="walk">
                  <label for="ngWalk">é•·è·é›¢ã®ç§»å‹•ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngRain" value="rain">
              <label for="ngRain">é›¨ã«å¼±ã„å ´æ‰€ã¯é¿ã‘ãŸã„</label>
            </div>
          </div>
        </div>

        <!-- è‡ªç”±å…¥åŠ› -->
        <div class="form-group">
          <label for="customRequest">è‡ªç”±å…¥åŠ›ï¼ˆè¡ŒããŸã„å ´æ‰€ãƒ»æ™‚é–“å¸¯ãƒ»ã‚„ã‚ŠãŸã„ã“ã¨ï¼‰</label>
          <textarea id="customRequest" placeholder="ä¾‹: 16æ™‚é ƒã«ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ã§å¤•ç„¼ã‘ã‚’è¦‹ãŸã„ / å¤œæ™¯ãŒè¦‹ãˆã‚‹ãƒãƒ¼ã§è»½ãé£²ã¿ãŸã„"></textarea>
          <div style="margin-top: 6px; color: #777; font-size: 0.85em;">
            å…·ä½“çš„ãªå ´æ‰€åã‚„æ™‚é–“å¸¯ã€ãã“ã§ã‚„ã‚ŠãŸã„ã“ã¨ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ—ãƒ©ãƒ³ã«å„ªå…ˆçš„ã«çµ„ã¿è¾¼ã¿ã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´ãƒœã‚¿ãƒ³ -->
        <div class="quick-adjust" id="quickAdjust" style="display: none;">
          <button type="button" onclick="quickAdjust('cheaper')">ğŸ’° ã‚‚ã£ã¨å®‰ã</button>
          <button type="button" onclick="quickAdjust('expensive')">âœ¨ ã‚‚ã£ã¨è±ªè¯ã«</button>
          <button type="button" onclick="quickAdjust('indoor')">ğŸ  å±‹å†…ä¸­å¿ƒã«</button>
          <button type="button" onclick="quickAdjust('outdoor')">ğŸŒ³ å±‹å¤–ä¸­å¿ƒã«</button>
          <button type="button" onclick="quickAdjust('shorter')">â±ï¸ çŸ­ã‚ã«</button>
          <button type="button" onclick="quickAdjust('longer')">ğŸ“… é•·ã‚ã«</button>
        </div>
      </div>

      <!-- ãƒ—ãƒ©ãƒ³è¡¨ç¤º -->
      <div class="card plan-section" id="planSection">
        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆä¸­...</p>
        </div>
        <div id="planContainer" style="display: none;">
          <div class="plan-summary">
            <h3 id="planTitle"></h3>
            <div class="cost-info">ğŸ’° äºˆç®—ç›®å®‰: <span id="totalCost"></span></div>
            <div id="planReasonContainer" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 12px;">
              <strong>ğŸ“ ã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸ã‚“ã ç†ç”±</strong>
              <p id="planReason" style="margin-top: 8px; line-height: 1.6;"></p>
            </div>
          </div>

          <div class="schedule">
            <h3>ğŸ“… æœ¬æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
            <div id="scheduleContainer"></div>
          </div>

          <div style="margin-top: 30px;">
            <h3 style="font-size: 1.3em; color: #333; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ—ºï¸ ãƒ‡ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
            <div id="map" style="height: 400px; border-radius:8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
          </div>

          <div class="info-section">
            <h3>ğŸ’¬ ä¼šè©±ãƒã‚¿ï¼ˆ3ã¤ï¼‰</h3>
            <ul class="info-list" id="conversationTopics"></ul>
          </div>

          <div class="next-step" id="nextStepPhrase"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:3001'
      : window.location.origin;
    let lastConditions = null;
    let GOOGLE_MAPS_API_KEY = null;

    // STEP2ãƒˆã‚°ãƒ«
    function toggleStep2() {
      const content = document.getElementById('step2Content');
      const icon = document.getElementById('toggleIcon');
      content.classList.toggle('active');
      icon.classList.toggle('expanded');
    }

    // ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´
    async function quickAdjust(type) {
      const adjustments = {
        'cheaper': 'ã‚‚ã£ã¨å®‰ãã—ãŸã„',
        'expensive': 'ã‚‚ã£ã¨è±ªè¯ã«ã—ãŸã„',
        'indoor': 'å±‹å†…ä¸­å¿ƒã«ã—ãŸã„',
        'outdoor': 'å±‹å¤–ä¸­å¿ƒã«ã—ãŸã„',
        'shorter': 'ã‚‚ã£ã¨çŸ­ã‚ã«ã—ãŸã„',
        'longer': 'ã‚‚ã£ã¨é•·ã‚ã«ã—ãŸã„'
      };
      await generatePlan(adjustments[type]);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('planForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await generatePlan();
    });

    async function generatePlan(adjustment = null) {
      const conditions = getFormConditions();

      // èª¿æ•´æ™‚ã‚‚æœ€æ–°ã®conditionsã‚’ä½¿ç”¨ï¼ˆSTEP2ã®å€¤ã‚’å«ã‚€ï¼‰
      if (!adjustment) {
        lastConditions = conditions;
      } else {
        // èª¿æ•´æ™‚ã¯lastConditionsã‚’æœ€æ–°ã®conditionsã§æ›´æ–°
        lastConditions = conditions;
      }

      const planSection = document.getElementById('planSection');
      const loadingContainer = document.getElementById('loadingContainer');
      const planContainer = document.getElementById('planContainer');
      const errorContainer = document.getElementById('errorContainer');
      const quickAdjust = document.getElementById('quickAdjust');

      planSection.classList.add('active');
      loadingContainer.style.display = 'block';
      planContainer.style.display = 'none';
      errorContainer.innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/api/generate-plan`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conditions: conditions,
            adjustment,
          }),
        });

        const data = await response.json();

        if (!data.success || !data.plan) {
          throw new Error(data.error || 'ãƒ—ãƒ©ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        console.log('ğŸ“¥ Received plan:', data.plan);
        displayPlan(data.plan);
        quickAdjust.style.display = 'grid';

      } catch (error) {
        console.error('Error:', error);
        errorContainer.innerHTML = `
          <div class="error">
            <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}<br>
            <small>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
          </div>
        `;
      } finally {
        loadingContainer.style.display = 'none';
        planContainer.style.display = 'block';
      }
    }

    function getFormConditions() {
      const mood = document.querySelector('input[name="mood"]:checked');
      const ngConditions = Array.from(document.querySelectorAll('[id^="ng"]:checked')).map(el => el.value);

      return {
        area: document.getElementById('area').value,
        date_phase: document.getElementById('phase').value,
        time_slot: document.getElementById('timeSlot').value,
        date_budget_level: document.getElementById('budget').value,
        mood: mood ? mood.value : null,
        ng_conditions: ngConditions,
        custom_request: document.getElementById('customRequest').value.trim() || null,
      };
    }

    function displayPlan(plan) {
      document.getElementById('planTitle').textContent = plan.plan_summary;
      document.getElementById('totalCost').textContent = plan.total_estimated_cost;

      if (plan.plan_reason) {
        document.getElementById('planReason').textContent = plan.plan_reason;
        document.getElementById('planReasonContainer').style.display = 'block';
      } else {
        document.getElementById('planReasonContainer').style.display = 'none';
      }

      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      const scheduleHTML = plan.schedule.map((item, index) => {
        if (item.is_meeting) {
          return `
          <div class="schedule-item${index === 0 ? ' active' : ''}">
            <div class="time">ğŸš© ${item.time}</div>
            <div class="place-name" style="font-weight: bold; color: #667eea;">é›†åˆ: ${item.place_name}</div>
            <div class="reason">ğŸ’¡ ${item.reason}</div>
          </div>`;
        }

        if (item.is_travel) {
          return `
          <div class="schedule-item" style="background: #f5f5f5; border-left: 4px solid #ffa500;">
            <div class="time">ğŸš¶ ${item.time}</div>
            <div class="place-name" style="color: #666;">ç§»å‹•ä¸­ï¼ˆå¾’æ­©${item.duration}ï¼‰</div>
            <div class="details" style="color: #888;">ğŸ“ ç´„${item.walking_distance_m}m</div>
          </div>`;
        }

        if (item.is_farewell) {
          return `
          <div class="schedule-item" style="border-left: 4px solid #764ba2;">
            <div class="time">ğŸ‘‹ ${item.time}</div>
            <div class="place-name" style="font-weight: bold; color: #764ba2;">è§£æ•£: ${item.place_name}</div>
            <div class="reason">ğŸ’¡ ${item.reason}</div>
          </div>`;
        }

        const link = item.info_url ? ` | <a href="${item.info_url}" target="_blank" rel="noopener" style="color: #667eea; font-weight: 600; text-decoration: none;">ğŸ“ Google Maps</a>` : '';
        const officialLink = item.official_url ? ` | <a href="${item.official_url}" target="_blank" rel="noopener" style="color: #ff6b6b; font-weight: 600; text-decoration: none;">ğŸ  å…¬å¼HP</a>` : '';
        const rating = item.rating ? ` | â­ ${item.rating}` : '';
        const endTime = item.end_time ? ` ã€œ ${item.end_time}` : '';

        // é¸å®šç†ç”±ã‚¿ã‚°
        const reasonTags = item.reason_tags ? `
          <div class="reason-tags">
            ${item.reason_tags.map(tag => `<span class="reason-tag">${tag}</span>`).join('')}
          </div>
        ` : '';

        return `
        <div class="schedule-item">
          <div class="time">${item.time}${endTime}</div>
          <div class="place-name">${item.place_name}${rating}</div>
          <div class="details">ğŸ“ ${item.area}${item.price_range ? ` | ğŸ’° ${item.price_range}` : ''}${item.duration ? ` | â±ï¸ ${item.duration}` : ''}${link}${officialLink}</div>
          <div class="reason">ğŸ’¡ ${item.reason}</div>
          ${reasonTags}
        </div>
      `}).join('');

      document.getElementById('scheduleContainer').innerHTML = scheduleHTML;

      // ä¼šè©±ãƒã‚¿
      if (plan.conversation_topics) {
        const topicsHTML = plan.conversation_topics.map(topic => `<li>âœ¨ ${topic}</li>`).join('');
        document.getElementById('conversationTopics').innerHTML = topicsHTML;
      }

      // æ¬¡å›ã¸ã®ã‚»ãƒªãƒ•
      if (plan.next_step_phrase) {
        document.getElementById('nextStepPhrase').textContent = `"${plan.next_step_phrase}"`;
      }

      // åœ°å›³è¡¨ç¤º
      renderMap(plan);
    }

    function renderMap(plan) {
      const mapEl = document.getElementById('map');

      try {
        if (!plan.schedule || plan.schedule.length === 0) return;

        if (typeof google === 'undefined' || !google.maps) {
          mapEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
          setTimeout(() => renderMap(plan), 1000);
          return;
        }

        const firstSpot = plan.schedule.find(item => item.lat && item.lng);
        if (!firstSpot) return;

        const mapCenter = { lat: firstSpot.lat, lng: firstSpot.lng };
        window._dateAiMap = new google.maps.Map(mapEl, {
          zoom: 14,
          center: mapCenter,
          mapId: 'DEMO_MAP_ID',
        });

        const bounds = new google.maps.LatLngBounds();
        const path = [];

        plan.schedule.forEach((item, idx) => {
          if (item.lat && item.lng && !item.is_travel) {
            const position = { lat: item.lat, lng: item.lng };
            path.push(position);
            bounds.extend(position);

            const marker = new google.maps.Marker({
              position,
              map: window._dateAiMap,
              label: {
                text: String(path.length),
                color: 'white',
                fontWeight: 'bold',
              },
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 20,
                fillColor: '#667eea',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 3,
              },
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `
                <div style="padding: 10px;">
                  <strong>${path.length}. ${item.place_name}</strong><br>
                  <span style="color: #667eea;">${item.time}</span> | ${item.duration}<br>
                  ${item.rating ? `â­ ${item.rating}<br>` : ''}
                </div>
              `,
            });

            marker.addListener('click', () => {
              infoWindow.open(window._dateAiMap, marker);
            });
          }
        });

        if (path.length > 1) {
          new google.maps.Polyline({
            path,
            geodesic: true,
            strokeColor: '#667eea',
            strokeOpacity: 0.7,
            strokeWeight: 4,
            map: window._dateAiMap,
          });
          window._dateAiMap.fitBounds(bounds);
        }
      } catch (error) {
        console.error('Map rendering error:', error);
        mapEl.innerHTML = `<div style="padding: 20px; text-align: center; color: #c33;">åœ°å›³ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
      }
    }
  </script>
</body>
</html>
