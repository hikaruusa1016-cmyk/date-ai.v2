<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³è‡ªå‹•ç”Ÿæˆ | Date AI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .form-section h2 {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 25px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    select,
    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    select:focus,
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-right: 8px;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.05em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .adjust-section {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }

    .adjust-section.active {
      display: block;
    }

    .adjust-section textarea {
      min-height: 60px;
      font-size: 0.9em;
    }

    /* ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .plan-section {
      min-height: 400px;
      display: none;
    }

    .plan-section.active {
      display: block;
    }

    .plan-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .plan-summary h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .cost-info {
      font-size: 1.1em;
      opacity: 0.95;
    }

    .schedule {
      margin: 25px 0;
    }

    .schedule h3 {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .schedule-item {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .schedule-item.active {
      background: #f0f4ff;
      border-left-color: #764ba2;
    }

    .time {
      font-size: 1.3em;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .place-name {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .details {
      font-size: 0.9em;
      color: #666;
      margin: 8px 0;
    }

    .reason {
      font-size: 0.9em;
      color: #764ba2;
      font-style: italic;
      margin-top: 8px;
      padding: 8px;
      background: rgba(118, 75, 162, 0.05);
      border-radius: 4px;
    }

    .info-section {
      margin-top: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .info-section h3 {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 10px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .info-list {
      list-style: none;
      margin-left: 0;
    }

    .info-list li {
      padding: 8px 0;
      color: #555;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .info-list strong {
      color: #764ba2;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .next-step {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-size: 1.05em;
      font-weight: 600;
    }

    .adjustable-points {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
    }

    .adjustable-points span {
      background: #667eea;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
    }

    @media (max-width: 960px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.8em;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
      padding: 12px 20px;
      background: white;
      color: #666;
      border: none;
      border-radius: 0;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      transition: all 0.3s;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
  <!-- Leaflet for map visualization -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2k3w8fKkYh1gqv9s6kM1Qb0b0Q0hZ+3v+0m0fCI=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j6mY2q+Yp6bQ6RZJv+Qe3QK9p7M5b5vY2vHfJp4=" crossorigin=""></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ’˜ ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ AI</h1>
      <p class="subtitle">æ¡ä»¶ã‚’é¸ã¶ã ã‘ã§å®Œç’§ãªãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãŒå®Œæˆï¼</p>
    </header>

    <div class="main-content">
      <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-section">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 1: æ¡ä»¶ã‚’å…¥åŠ›</h2>
        <form id="planForm">
          <!-- åŸºæœ¬æƒ…å ± -->
          <div class="form-group">
            <label for="userAge">ã‚ãªãŸã®å¹´ä»£ *</label>
            <select id="userAge" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="20s">20ä»£</option>
              <option value="30s">30ä»£</option>
              <option value="40s+">40ä»£ä»¥ä¸Š</option>
            </select>
          </div>

          <div class="form-group">
            <label for="userPersonality">ã‚ãªãŸã®æ€§æ ¼ã‚¿ã‚¤ãƒ— *</label>
            <select id="userPersonality" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="indoor">ã‚¤ãƒ³ãƒ‰ã‚¢æ´¾</option>
              <option value="balanced">ãƒãƒ©ãƒ³ã‚¹æ´¾</option>
              <option value="outdoor">ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ´¾</option>
              <option value="talkative">ãŠã—ã‚ƒã¹ã‚Šï¼ˆè©±å¥½ãï¼‰</option>
              <option value="quiet">ç©ã‚„ã‹ï¼ˆè½ã¡ç€ã„ã¦ã„ã‚‹ï¼‰</option>
              <option value="adventurous">å†’é™ºå¥½ãï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰</option>
              <option value="shy">æ§ãˆã‚ï¼ˆã‚·ãƒ£ã‚¤ï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label>ã‚ãªãŸã®èˆˆå‘³ *</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="interestGourmet" value="gourmet">
                <label for="interestGourmet">ã‚°ãƒ«ãƒ¡</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestWalk" value="walk">
                <label for="interestWalk">æ•£æ­©</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestMovie" value="movie">
                <label for="interestMovie">æ˜ ç”»</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestArt" value="art">
                <label for="interestArt">ç¾è¡“ãƒ»åšç‰©é¤¨</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestShop" value="shop">
                <label for="interestShop">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestSport" value="sport">
                <label for="interestSport">ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestCafe" value="cafe">
                <label for="interestCafe">ã‚«ãƒ•ã‚§å·¡ã‚Š</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestMusic" value="music">
                <label for="interestMusic">éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestNature" value="nature">
                <label for="interestNature">è‡ªç„¶ãƒ»å…¬åœ’</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestPhoto" value="photography">
                <label for="interestPhoto">å†™çœŸãƒ»æ’®å½±</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="budget">äºˆç®—ãƒ¬ãƒ™ãƒ« *</label>
            <select id="budget" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="low">ä½ï¼ˆ3000-5000å††ï¼‰</option>
              <option value="medium">ä¸­ï¼ˆ5000-10000å††ï¼‰</option>
              <option value="high">é«˜ï¼ˆ10000å††ä»¥ä¸Šï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label for="phase">ãƒ‡ãƒ¼ãƒˆã®æ®µéš *</label>
            <select id="phase" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="first">åˆãƒ‡ãƒ¼ãƒˆ</option>
              <option value="second">2ã€œ3å›ç›®</option>
              <option value="deepen">é–¢ä¿‚ã‚’æ·±ã‚ã‚‹</option>
            </select>
          </div>

          <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ± -->
          <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

          <div class="form-group">
            <label for="partnerAge">ç›¸æ‰‹ã®å¹´ä»£ *</label>
            <select id="partnerAge" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="20s">20ä»£</option>
              <option value="30s">30ä»£</option>
              <option value="40s+">40ä»£ä»¥ä¸Š</option>
            </select>
          </div>

          <div class="form-group">
            <label for="partnerPersonality">ç›¸æ‰‹ã®æ€§æ ¼ã‚¿ã‚¤ãƒ— *</label>
            <select id="partnerPersonality" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="indoor">ã‚¤ãƒ³ãƒ‰ã‚¢æ´¾</option>
              <option value="balanced">ãƒãƒ©ãƒ³ã‚¹æ´¾</option>
              <option value="outdoor">ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ´¾</option>
              <option value="talkative">ãŠã—ã‚ƒã¹ã‚Šï¼ˆè©±å¥½ãï¼‰</option>
              <option value="quiet">ç©ã‚„ã‹ï¼ˆè½ã¡ç€ã„ã¦ã„ã‚‹ï¼‰</option>
              <option value="adventurous">å†’é™ºå¥½ãï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰</option>
              <option value="shy">æ§ãˆã‚ï¼ˆã‚·ãƒ£ã‚¤ï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label>ç›¸æ‰‹ã®èˆˆå‘³ *</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="partnerGourmet" value="gourmet">
                <label for="partnerGourmet">ã‚°ãƒ«ãƒ¡</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerWalk" value="walk">
                <label for="partnerWalk">æ•£æ­©</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerMovie" value="movie">
                <label for="partnerMovie">æ˜ ç”»</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerArt" value="art">
                <label for="partnerArt">ç¾è¡“ãƒ»åšç‰©é¤¨</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerShop" value="shop">
                <label for="partnerShop">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerSport" value="sport">
                <label for="partnerSport">ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerCafe" value="cafe">
                <label for="partnerCafe">ã‚«ãƒ•ã‚§å·¡ã‚Š</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerMusic" value="music">
                <label for="partnerMusic">éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerNature" value="nature">
                <label for="partnerNature">è‡ªç„¶ãƒ»å…¬åœ’</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerPhoto" value="photography">
                <label for="partnerPhoto">å†™çœŸãƒ»æ’®å½±</label>
              </div>
            </div>
          </div>

          <!-- ã‚¨ãƒªã‚¢ -->
          <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

          <div class="form-group">
            <label for="area">ãƒ‡ãƒ¼ãƒˆã‚¨ãƒªã‚¢ *</label>
            <select id="area" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="shibuya">æ¸‹è°·</option>
              <option value="shinjuku">æ–°å®¿</option>
              <option value="ginza">éŠ€åº§</option>
              <option value="harajuku">åŸå®¿</option>
              <option value="odaiba">ãŠå°å ´</option>
              <option value="ueno">ä¸Šé‡</option>
              <option value="asakusa">æµ…è‰</option>
              <option value="ikebukuro">æ± è¢‹</option>
            </select>
          </div>

          <!-- ä»»æ„é …ç›® -->
          <div class="form-group">
            <label for="duration">ãƒ‡ãƒ¼ãƒˆæ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
            <select id="duration">
              <option value="">æŒ‡å®šã—ãªã„</option>
              <option value="short">çŸ­ã‚ï¼ˆåŠæ—¥ï¼‰</option>
              <option value="normal">é€šå¸¸ï¼ˆ1æ—¥ï¼‰</option>
              <option value="long">é•·ã‚ï¼ˆä¸¸1æ—¥ï¼‰</option>
            </select>
          </div>

          <button type="submit" id="generateBtn">âœ¨ ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
        </form>

        <!-- èª¿æ•´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="adjust-section" id="adjustSection">
          <h3>ãƒ—ãƒ©ãƒ³ã‚’èª¿æ•´ã™ã‚‹</h3>
          <textarea id="adjustmentInput" placeholder="ä¾‹ï¼šã‚‚ã†å°‘ã—å®‰ãã—ãŸã„ã€é›¨ã®æ—¥ç”¨ã«å¤‰æ›´ã—ãŸã„ã€å¤œã¯çŸ­ã‚ã«..."></textarea>
          <button id="adjustBtn" type="button" style="margin-top: 10px;">ğŸ”„ ãƒ—ãƒ©ãƒ³ã‚’ä¿®æ­£</button>
        </div>
      </div>

      <!-- ãƒ—ãƒ©ãƒ³è¡¨ç¤º -->
      <div class="card plan-section" id="planSection">
        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆä¸­...</p>
        </div>
        <div id="planContainer" style="display: none;">
          <div id="map" style="height: 300px; border-radius:8px; margin-bottom:16px; display:none;"></div>
          <div class="plan-summary">
            <h3 id="planTitle"></h3>
            <div class="cost-info">ğŸ’° äºˆç®—ç›®å®‰: <span id="totalCost"></span></div>
          </div>

          <div class="schedule">
            <h3>ğŸ“… æœ¬æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
            <div id="scheduleContainer"></div>
          </div>

          <div class="adjustable-points">
            <strong style="width: 100%; color: #333;">èª¿æ•´å¯èƒ½ãªãƒã‚¤ãƒ³ãƒˆ:</strong>
            <div id="adjustablePointsContainer"></div>
          </div>

          <div class="info-section">
            <h3>ğŸ’¬ ä¼šè©±ãƒã‚¿ï¼ˆ3ã¤ï¼‰</h3>
            <ul class="info-list" id="conversationTopics"></ul>
          </div>

          <div class="info-section" id="routeInfo" style="display:none;">
            <h3>ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆæƒ…å ±</h3>
            <ul class="info-list" id="routeSummary"></ul>
          </div>

          <div class="next-step" id="nextStepPhrase"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';
    let lastConditions = null;  // æœ€å¾Œã®æ¡ä»¶ã‚’ä¿æŒ

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('planForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await generatePlan();
    });

    // ãƒ—ãƒ©ãƒ³èª¿æ•´
    document.getElementById('adjustBtn').addEventListener('click', async () => {
      const adjustment = document.getElementById('adjustmentInput').value;
      if (!adjustment.trim()) {
        alert('èª¿æ•´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      await generatePlan(adjustment);
    });

    async function generatePlan(adjustment = null) {
      const conditions = getFormConditions();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!conditions.user_interests.length) {
        alert('ã‚ãªãŸã®èˆˆå‘³ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');
        return;
      }
      if (!conditions.partner_interests.length) {
        alert('ç›¸æ‰‹ã®èˆˆå‘³ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');
        return;
      }

      // æœ€åˆã®æ¡ä»¶ã‚’ä¿æŒ
      if (!adjustment) {
        lastConditions = conditions;
      }

      const planSection = document.getElementById('planSection');
      const loadingContainer = document.getElementById('loadingContainer');
      const planContainer = document.getElementById('planContainer');
      const errorContainer = document.getElementById('errorContainer');

      planSection.classList.add('active');
      loadingContainer.style.display = 'block';
      planContainer.style.display = 'none';
      errorContainer.innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/api/generate-plan`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conditions: lastConditions || conditions,  // åˆæœŸæ¡ä»¶ã‚’ä½¿ç”¨
            adjustment,
          }),
        });

        const data = await response.json();

        if (!data.success || !data.plan) {
          throw new Error(data.error || 'ãƒ—ãƒ©ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        displayPlan(data.plan);
        document.getElementById('adjustSection').classList.add('active');

        // èª¿æ•´å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('adjustmentInput').value = '';

      } catch (error) {
        console.error('Error:', error);
        errorContainer.innerHTML = `
          <div class="error">
            <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}<br>
            <small>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
          </div>
        `;
      } finally {
        loadingContainer.style.display = 'none';
        planContainer.style.display = 'block';
      }
    }

    function getFormConditions() {
      const userInterests = Array.from(document.querySelectorAll('[id^="interest"]:checked')).map(el => el.value);
      const partnerInterests = Array.from(document.querySelectorAll('[id^="partner"]:checked')).map(el => el.value);

      return {
        user_age_group: document.getElementById('userAge').value,
        user_personality: document.getElementById('userPersonality').value,
        user_interests: userInterests,
        date_budget_level: document.getElementById('budget').value,
        date_phase: document.getElementById('phase').value,
        partner_age_group: document.getElementById('partnerAge').value,
        partner_personality: document.getElementById('partnerPersonality').value,
        partner_interests: partnerInterests,
        area: document.getElementById('area').value,
        date_duration: document.getElementById('duration').value || undefined,
      };
    }

    function displayPlan(plan) {
      // ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
      document.getElementById('planTitle').textContent = plan.plan_summary;
      document.getElementById('totalCost').textContent = plan.total_estimated_cost;

      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      const scheduleHTML = plan.schedule.map((item, index) => {
        const link = item.info_url ? ` <a href="${item.info_url}" target="_blank" rel="noopener">ğŸ”— è©³ç´°</a>` : '';
        const travelInfo = item.travel_time_min ? ` | ğŸš¶ ${item.travel_time_min}åˆ†ï¼ˆ${item.walking_distance_m}mï¼‰` : '';
        return `
        <div class="schedule-item${index === 0 ? ' active' : ''}">
          <div class="time">${item.time}</div>
          <div class="place-name">${item.place_name}</div>
          <div class="details">ğŸ“ ${item.area}${item.price_range ? ` | ğŸ’° ${item.price_range}` : ''}${item.duration ? ` | â±ï¸ ${item.duration}` : ''}${travelInfo}${link}</div>
          <div class="reason">ğŸ’¡ ${item.reason}</div>
        </div>
      `}).join('');

      document.getElementById('scheduleContainer').innerHTML = scheduleHTML;

      // èª¿æ•´å¯èƒ½ãªãƒã‚¤ãƒ³ãƒˆ
      if (plan.adjustable_points) {
        const pointsHTML = plan.adjustable_points.map(point => `<span>${point}</span>`).join('');
        document.getElementById('adjustablePointsContainer').innerHTML = pointsHTML;
      }

      // ä¼šè©±ãƒã‚¿
      if (plan.conversation_topics) {
        const topicsHTML = plan.conversation_topics.map(topic => `<li>âœ¨ ${topic}</li>`).join('');
        document.getElementById('conversationTopics').innerHTML = topicsHTML;
      }

      // æ¬¡å›ã¸ã®ã‚»ãƒªãƒ•
      if (plan.next_step_phrase) {
        document.getElementById('nextStepPhrase').textContent = `"${plan.next_step_phrase}"`;
      }

      // åœ°å›³è¡¨ç¤ºï¼ˆLeafletï¼‰
      const mapEl = document.getElementById('map');
      const routeInfoEl = document.getElementById('routeInfo');
      if (plan.schedule && plan.schedule.length && typeof L !== 'undefined') {
        mapEl.style.display = 'block';
        routeInfoEl.style.display = 'block';
        // clear previous map if exists
        if (window._dateAiMap) {
          window._dateAiMap.remove();
        }
        const first = plan.schedule[0];
        window._dateAiMap = L.map('map').setView([first.lat || 35.6595, first.lng || 139.7004], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(window._dateAiMap);

        const latlngs = [];
        let totalDist = 0;
        plan.schedule.forEach((item, idx) => {
          if (item.lat && item.lng) {
            latlngs.push([item.lat, item.lng]);
            const marker = L.marker([item.lat, item.lng]).addTo(window._dateAiMap);
            marker.bindPopup(`<strong>${item.place_name}</strong><br>${item.time} â€” ${item.duration}`);
            if (idx > 0 && item.walking_distance_m) totalDist += item.walking_distance_m;
          }
        });
        if (latlngs.length) {
          L.polyline(latlngs, {color: '#667eea'}).addTo(window._dateAiMap);
          window._dateAiMap.fitBounds(latlngs);
        }

        // route summary
        const routeSummary = [];
        let cumulative = 0;
        plan.schedule.forEach((item, idx) => {
          if (idx === 0) {
            routeSummary.push(`<li>å‡ºç™º: ${item.place_name}ï¼ˆæ¨å®šç§»å‹• ${item.travel_time_min}åˆ†ï¼‰</li>`);
          } else {
            routeSummary.push(`<li>${item.time}: ${item.place_name} â€” ç§»å‹• ${item.travel_time_min}åˆ† / ${item.walking_distance_m}m</li>`);
            cumulative += item.walking_distance_m || 0;
          }
        });
        routeSummary.push(`<li><strong>åˆè¨ˆæ­©è¡Œè·é›¢:</strong> ${cumulative} mï¼ˆç´„ ${Math.round(cumulative/83.33)} åˆ†ï¼‰</li>`);
        document.getElementById('routeSummary').innerHTML = routeSummary.join('');
      }
    }
  </script>
</body>
</html>
