<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³è‡ªå‹•ç”Ÿæˆ | Date AI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .ad-section {
      background: white;
      border-radius: 12px;
      padding: 16px 20px 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
    }

    .ad-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      justify-items: center;
    }

    .ad-slot {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      max-width: 100%;
      min-height: 90px;
      padding: 12px;
      border-radius: 10px;
      background: #f6f7fb;
      border: 1px solid #e3e6f4;
      overflow: hidden;
      position: relative;
      box-sizing: border-box;
    }

    /* åºƒå‘Šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚µã‚¤ã‚ºåˆ¶é™ */
    .ad-slot iframe,
    .ad-slot img,
    .ad-slot ins {
      max-width: 100% !important;
      max-height: 250px !important;
      width: auto !important;
      height: auto !important;
      object-fit: contain;
    }

    .ad-slot.ad-empty {
      min-height: 26px;
      padding: 6px 10px;
      background: transparent;
      border-style: dashed;
      opacity: 0.6;
    }

    .ad-slot.ad-empty .ad-label {
      position: static;
      margin: 0 auto;
    }

    .ad-label {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.75em;
      color: #8a8fb3;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #e3e6f4;
      border-radius: 8px;
      padding: 2px 6px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .form-section h2 {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 25px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    select,
    input[type="text"],
    input[type="radio"],
    textarea {
      cursor: pointer;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
      resize: vertical;
      min-height: 90px;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radio-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .radio-item:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .radio-item input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    .radio-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .checkbox-item:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-right: 8px;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.05em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .toggle-section {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .toggle-header h3 {
      font-size: 1.1em;
      color: #667eea;
    }

    .toggle-icon {
      font-size: 1.2em;
      color: #667eea;
      transition: transform 0.3s;
    }

    .toggle-icon.expanded {
      transform: rotate(180deg);
    }

    .toggle-content {
      display: none;
      margin-top: 15px;
    }

    .toggle-content.active {
      display: block;
    }

    .field-note {
      margin-top: 6px;
      color: #777;
      font-size: 0.85em;
    }

    .quick-adjust {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .quick-adjust button {
      padding: 10px;
      font-size: 0.9em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .plan-section {
      min-height: 400px;
      display: none;
    }

    .plan-section.active {
      display: block;
    }

    .plan-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .plan-summary h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .cost-info {
      font-size: 1.1em;
      opacity: 0.95;
    }

    .schedule {
      margin: 25px 0;
    }

    .schedule h3 {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .schedule-item {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .schedule-item.active {
      background: #f0f4ff;
      border-left-color: #764ba2;
    }

    .time {
      font-size: 1.3em;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .place-name {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .details {
      font-size: 0.9em;
      color: #666;
      margin: 8px 0;
    }

    .reason {
      font-size: 0.9em;
      color: #764ba2;
      font-style: italic;
      margin-top: 8px;
      padding: 8px;
      background: rgba(118, 75, 162, 0.05);
      border-radius: 4px;
    }

    .reason-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .reason-tag {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .photo-grid img {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
      background: #eee;
    }

    .review-block {
      margin-top: 12px;
      padding: 10px 12px;
      background: #f7f7fb;
      border-radius: 8px;
      border: 1px solid #e7e8ff;
    }

    .review-title {
      font-weight: 700;
      color: #4b4b70;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .closed-warning-block {
      margin-top: 12px;
      padding: 10px 12px;
      background: #fef2f2;
      border-radius: 8px;
      border: 1px solid #fecaca;
      color: #991b1b;
      font-size: 0.9em;
      font-weight: 600;
    }

    .review-item {
      margin-bottom: 8px;
      color: #4b4b4b;
      font-size: 0.9em;
      line-height: 1.4;
    }

    .review-meta {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 3px;
    }

    .review-toggle {
      margin-top: 6px;
      padding: 6px 10px;
      font-size: 0.85em;
      background: #eef1ff;
      color: #4b4b70;
      border: 1px solid #d6daf6;
      border-radius: 6px;
      cursor: pointer;
    }

    .review-toggle:hover {
      background: #e1e5ff;
    }

    .alternative-btn {
      margin-top: 12px;
      padding: 8px 16px;
      background: #fff;
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s;
      width: 100%;
    }

    .alternative-btn:hover {
      background: #667eea;
      color: white;
    }

    .alternative-btn.active {
      background: #667eea;
      color: white;
    }

    .booking-section {
      margin-top: 12px;
      padding: 10px 12px;
      background: #fff7ed;
      border-radius: 8px;
      border: 1px solid #fed7aa;
    }

    .booking-title {
      font-weight: 700;
      color: #c2410c;
      margin-bottom: 8px;
      font-size: 0.9em;
    }

    .booking-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .booking-links.empty {
      color: #9a3412;
      font-weight: 600;
      font-size: 0.9em;
    }

    .booking-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #fb923c;
      color: white;
      border-radius: 999px;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.9em;
      box-shadow: 0 8px 18px rgba(251, 146, 60, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .booking-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(251, 146, 60, 0.35);
    }

    .alternatives-container {
      margin-top: 12px;
      padding: 15px;
      background: #f0f4ff;
      border-radius: 6px;
      border: 2px solid #667eea;
    }

    .alternatives-loading {
      text-align: center;
      color: #667eea;
      padding: 20px;
    }

    .alternatives-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alternative-spot {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .alternative-spot:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .alternative-spot-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 6px;
    }

    .alternative-spot-details {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 4px;
    }

    .alternative-spot-reason {
      font-size: 0.85em;
      color: #667eea;
      margin-top: 6px;
    }

    .info-section {
      margin-top: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .info-section h3 {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 10px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .info-list {
      list-style: none;
      margin-left: 0;
    }

    .info-list li {
      padding: 8px 0;
      color: #555;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .next-step {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-size: 1.05em;
      font-weight: 600;
    }

    @media (max-width: 960px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.8em;
      }

      .checkbox-group,
      .quick-adjust {
        grid-template-columns: 1fr;
      }
    }

    /* Map Wrapper & Button */
    .map-wrapper {
      position: relative;
    }

    .google-maps-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      /* Google Maps controls usually have lower z-index or we need to be higher */
      background: white;
      padding: 10px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      text-decoration: none;
      font-weight: bold;
      color: #667eea;
      display: none;
      /* Initially hidden */
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
      transition: background 0.2s;
    }

    .google-maps-btn:hover {
      background: #f8f9fa;
    }

    /* Plan Adjustment Buttons */
    .adjust-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .adjust-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .adjust-btn:active {
      transform: translateY(0);
    }

    /* Spinner Animation */
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
  <!-- Google Maps API -->
  <script>
    window.gm_authFailure = function () {
      console.error('Google Maps authentication failed');
    };

    (async function loadGoogleMaps() {
      try {
        const isLocalHost = window.location.hostname === 'localhost';
        const isFileAccess = window.location.protocol === 'file:';
        const API_BASE_URL = (isLocalHost || isFileAccess)
          ? 'http://localhost:3001'
          : window.location.origin;
        const response = await fetch(`${API_BASE_URL}/api/maps-key`);
        const data = await response.json();

        if (data.apiKey) {
          GOOGLE_MAPS_API_KEY = data.apiKey;
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&callback=Function.prototype`;
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
        }
      } catch (error) {
        console.error('Failed to fetch Maps API key:', error);
      }
    })();
  </script>
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸ’˜ ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ AI</h1>
      <p class="subtitle">30ç§’ã§å®Œç’§ãªãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãŒå®Œæˆï¼</p>
    </header>

    <div class="main-content">
      <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-section">
        <h2>ğŸ“ STEP 1: åŸºæœ¬æƒ…å ±ï¼ˆå¿…é ˆï¼‰</h2>
        <form id="planForm">
          <!-- ã‚¨ãƒªã‚¢ -->
          <div class="form-group">
            <label for="area">ãƒ‡ãƒ¼ãƒˆã‚¨ãƒªã‚¢ *</label>
            <select id="area" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="shibuya">æ¸‹è°·</option>
              <option value="shinjuku">æ–°å®¿</option>
              <option value="ginza">éŠ€åº§</option>
              <option value="harajuku">åŸå®¿</option>
              <option value="odaiba">ãŠå°å ´</option>
              <option value="ueno">ä¸Šé‡</option>
              <option value="asakusa">æµ…è‰</option>
              <option value="ikebukuro">æ± è¢‹</option>
            </select>
          </div>

          <!-- ãƒ‡ãƒ¼ãƒˆãƒ•ã‚§ãƒ¼ã‚º -->
          <div class="form-group">
            <label for="phase">ãƒ‡ãƒ¼ãƒˆãƒ•ã‚§ãƒ¼ã‚º *</label>
            <select id="phase" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="first">åˆãƒ‡ãƒ¼ãƒˆ</option>
              <option value="second">2ã€œ3å›ç›®</option>
              <option value="anniversary">è¨˜å¿µæ—¥</option>
              <option value="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
            </select>
          </div>

          <!-- ãƒ‡ãƒ¼ãƒˆæ™‚é–“å¸¯ -->
          <div class="form-group">
            <label for="timeSlot">ãƒ‡ãƒ¼ãƒˆæ™‚é–“å¸¯ *</label>
            <select id="timeSlot" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="lunch">æ˜¼ï¼ˆãƒ©ãƒ³ãƒãƒ¡ã‚¤ãƒ³ï¼‰</option>
              <option value="dinner">å¤œï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ãƒ¡ã‚¤ãƒ³ï¼‰</option>
              <option value="halfday">åŠæ—¥ï¼ˆæ˜¼ã€œå¤•æ–¹ï¼‰</option>
              <option value="fullday">1æ—¥ï¼ˆæœã€œå¤œï¼‰</option>
            </select>
          </div>

          <!-- äºˆç®— -->
          <div class="form-group">
            <label for="budget">äºˆç®—æ„Ÿ *</label>
            <select id="budget" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="low">ä½ï¼ˆ3000-5000å††ï¼‰</option>
              <option value="medium">ä¸­ï¼ˆ7000-10000å††ï¼‰</option>
              <option value="high">é«˜ï¼ˆ15000å††ä»¥ä¸Šï¼‰</option>
            </select>
          </div>

          <button type="submit" id="generateBtn">âœ¨ ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
        </form>

        <!-- STEP2: è©³ç´°è¨­å®šï¼ˆä»»æ„ãƒ»ãƒˆã‚°ãƒ«ï¼‰ -->
        <div class="toggle-section">
          <div class="toggle-header" onclick="toggleStep2()">
            <h3>âš™ï¸ STEP 2: è©³ç´°è¨­å®šï¼ˆä»»æ„ï¼‰</h3>
            <span class="toggle-icon" id="toggleIcon">â–¼</span>
          </div>
          <div class="toggle-content" id="step2Content">
            <!-- ä»Šæ—¥ã®æ°—åˆ† -->
            <div class="form-group" style="margin-top: 15px;">
              <label>ä»Šæ—¥ã®æ°—åˆ†ï¼ˆ1ã¤é¸æŠï¼‰</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" id="moodRelax" name="mood" value="relax">
                  <label for="moodRelax">ã®ã‚“ã³ã‚Šãƒªãƒ©ãƒƒã‚¯ã‚¹</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodActive" name="mood" value="active">
                  <label for="moodActive">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å‹•ããŸã„</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodRomantic" name="mood" value="romantic">
                  <label for="moodRomantic">ãƒ­ãƒãƒ³ãƒãƒƒã‚¯ã«éã”ã—ãŸã„</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodCasual" name="mood" value="casual">
                  <label for="moodCasual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«æ¥½ã—ã¿ãŸã„</label>
                </div>
              </div>
            </div>

            <!-- NGæ¡ä»¶ -->
            <div class="form-group">
              <label>NGæ¡ä»¶ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="ngOutdoor" value="outdoor">
                  <label for="ngOutdoor">å±‹å¤–ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngIndoor" value="indoor">
                  <label for="ngIndoor">å±‹å†…ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngCrowd" value="crowd">
                  <label for="ngCrowd">æ··é›‘ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngQuiet" value="quiet">
                  <label for="ngQuiet">é™ã‹ã™ãã‚‹å ´æ‰€ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngWalk" value="walk">
                  <label for="ngWalk">é•·è·é›¢ã®ç§»å‹•ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngRain" value="rain">
                  <label for="ngRain">é›¨ã«å¼±ã„å ´æ‰€ã¯é¿ã‘ãŸã„</label>
                </div>
              </div>
            </div>

            <!-- è‡ªç”±å…¥åŠ› -->
            <div class="form-group">
              <label for="customRequest">è‡ªç”±å…¥åŠ›ï¼ˆè¡ŒããŸã„å ´æ‰€ãƒ»æ™‚é–“å¸¯ãƒ»ã‚„ã‚ŠãŸã„ã“ã¨ï¼‰</label>
              <textarea id="customRequest" placeholder="ä¾‹: 16æ™‚é ƒã«ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ã§å¤•ç„¼ã‘ã‚’è¦‹ãŸã„ / å¤œæ™¯ãŒè¦‹ãˆã‚‹ãƒãƒ¼ã§è»½ãé£²ã¿ãŸã„"></textarea>
              <div class="field-note">
                å…·ä½“çš„ãªå ´æ‰€åã‚„æ™‚é–“å¸¯ã€ãã“ã§ã‚„ã‚ŠãŸã„ã“ã¨ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ—ãƒ©ãƒ³ã«å„ªå…ˆçš„ã«çµ„ã¿è¾¼ã¿ã¾ã™ã€‚
              </div>
            </div>

            <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å¸Œæœ› -->
            <div class="form-group">
              <label>ã‚„ã‚ŠãŸã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="activityMovie" name="activityPreference" value="movie">
                  <label for="activityMovie">ğŸ¬ æ˜ ç”»</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="activityExhibition" name="activityPreference" value="exhibition">
                  <label for="activityExhibition">ğŸ–¼ï¸ å±•ç¤ºä¼šãƒ»ç¾è¡“é¤¨</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="activitySportsWatch" name="activityPreference" value="sports_watch">
                  <label for="activitySportsWatch">ğŸŸï¸ ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="activitySportsPlay" name="activityPreference" value="sports_play">
                  <label for="activitySportsPlay">âš½ï¸ ã‚¹ãƒãƒ¼ãƒ„ä½“é¨“</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="activityOutdoor" name="activityPreference" value="outdoor">
                  <label for="activityOutdoor">ğŸŒ¿ ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ•£ç­–</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="activityHandsOn" name="activityPreference" value="hands_on">
                  <label for="activityHandsOn">ğŸ¨ ä½“é¨“ãƒ»ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—</label>
                </div>
              </div>
              <div class="radio-group" style="margin-top: 12px;">
                <div class="radio-item">
                  <input type="radio" id="activityPriorityPrefer" name="activityPriority" value="prefer" checked>
                  <label for="activityPriorityPrefer">ã§ãã‚Œã°å…¥ã‚Œã¦ã»ã—ã„</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="activityPriorityMust" name="activityPriority" value="must">
                  <label for="activityPriorityMust">å¿…ãšå…¥ã‚Œã¦ã»ã—ã„</label>
                </div>
              </div>
              <div class="field-note">æœªé¸æŠã®å ´åˆã¯ãŠã¾ã‹ã›ã§çµ„ã¿è¾¼ã¿ã¾ã™ã€‚</div>
            </div>
          </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´ãƒœã‚¿ãƒ³ -->
        <div class="quick-adjust" id="quickAdjust" style="display: none;">
          <button type="button" onclick="quickAdjust('cheaper')">ğŸ’° ã‚‚ã£ã¨å®‰ã</button>
          <button type="button" onclick="quickAdjust('expensive')">âœ¨ ã‚‚ã£ã¨è±ªè¯ã«</button>
          <button type="button" onclick="quickAdjust('indoor')">ğŸ  å±‹å†…ä¸­å¿ƒã«</button>
          <button type="button" onclick="quickAdjust('outdoor')">ğŸŒ³ å±‹å¤–ä¸­å¿ƒã«</button>
          <button type="button" onclick="quickAdjust('shorter')">â±ï¸ çŸ­ã‚ã«</button>
          <button type="button" onclick="quickAdjust('longer')">ğŸ“… é•·ã‚ã«</button>
        </div>
      </div>

      <div class="ad-section">
        <div class="ad-grid">
          <div class="ad-slot">
            <div class="ad-label">åºƒå‘Š</div>
            <div id="im-b977cf9b766446d58a768afc18e89c9e">
              <script async src="https://imp-adedge.i-mobile.co.jp/script/v1/spot.js?20220104"></script>
              <script>(window.adsbyimobile=window.adsbyimobile||[]).push({pid:84369,mid:589548,asid:1920606,type:"banner",display:"inline",elementid:"im-b977cf9b766446d58a768afc18e89c9e"})</script>
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒ—ãƒ©ãƒ³è¡¨ç¤º -->
      <div class="card plan-section" id="planSection">
        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆä¸­...</p>
        </div>
        <div id="planContainer" style="display: none;">
          <div class="plan-summary">
            <h3 id="planTitle"></h3>
            <div class="cost-info">ğŸ’° äºˆç®—ç›®å®‰: <span id="totalCost"></span></div>
            <div id="planReasonContainer"
              style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 12px;">
              <strong>ğŸ“ ã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸ã‚“ã ç†ç”±</strong>
              <p id="planReason" style="margin-top: 8px; line-height: 1.6;"></p>
            </div>
          </div>

          <div class="schedule">
            <h3>ğŸ“… æœ¬æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
            <div id="scheduleContainer"></div>
          </div>

          <div style="margin-top: 30px;">
            <h3
              style="font-size: 1.3em; color: #333; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
              ğŸ—ºï¸ ãƒ‡ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
            <div class="map-wrapper">
              <div id="map"
                style="height: 400px; border-radius:8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              </div>
              <a id="googleMapsLink" href="#" target="_blank" rel="noopener" class="google-maps-btn">
                ğŸ“ Google Mapsã§é–‹ã
              </a>
            </div>
          </div>

          <div class="info-section">
            <h3>ğŸ’¬ ä¼šè©±ãƒã‚¿ï¼ˆ3ã¤ï¼‰</h3>
            <ul class="info-list" id="conversationTopics"></ul>
          </div>

          <div class="next-step" id="nextStepPhrase"></div>

          <!-- ãƒ—ãƒ©ãƒ³èª¿æ•´UI -->
          <div class="plan-adjustment-section"
            style="margin: 25px 0; padding: 25px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4 style="margin: 0 0 20px 0; color: #333; font-size: 1.2em;">âœ¨ ãƒ—ãƒ©ãƒ³ã‚’èª¿æ•´ã™ã‚‹</h4>

            <!-- ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´ãƒœã‚¿ãƒ³ -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
              <button onclick="adjustPlan('ã‚‚ã£ã¨å®‰ãã—ã¦ãã ã•ã„')" class="adjust-btn" style="background: #10b981;">
                ğŸ’° ã‚‚ã£ã¨å®‰ã
              </button>
              <button onclick="adjustPlan('ã‚‚ã£ã¨è±ªè¯ã«ã—ã¦ãã ã•ã„')" class="adjust-btn" style="background: #f59e0b;">
                âœ¨ ã‚‚ã£ã¨è±ªè¯ã«
              </button>
              <button onclick="adjustPlan('æ™‚é–“ã‚’çŸ­ãã—ã¦ãã ã•ã„')" class="adjust-btn" style="background: #3b82f6;">
                â±ï¸ æ™‚é–“ã‚’çŸ­ã
              </button>
              <button onclick="adjustPlan('ã‚‚ã£ã¨ã‚†ã£ãã‚Šéã”ã›ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„')" class="adjust-btn" style="background: #8b5cf6;">
                ğŸŒ™ ã‚‚ã£ã¨ã‚†ã£ãã‚Š
              </button>
              <button onclick="showAreaChangeDialog()" class="adjust-btn" style="background: #ec4899;">
                ğŸ“ åˆ¥ã‚¨ãƒªã‚¢ã§ä½œæˆ
              </button>
            </div>

            <!-- è‡ªç”±å…¥åŠ› -->
            <div style="display: flex; gap: 10px; flex-direction: column;">
              <textarea id="customAdjustment" placeholder="ä¾‹: ãƒ©ãƒ³ãƒã‚’ã‚¤ã‚¿ãƒªã‚¢ãƒ³ã«ã—ã¦ãã ã•ã„ã€ã‚‚ã£ã¨ãƒ­ãƒãƒ³ãƒãƒƒã‚¯ãªé›°å›²æ°—ã«ã—ã¦ãã ã•ã„ã€ãªã©"
                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; min-height: 80px; resize: vertical; font-family: inherit;"
                onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); adjustPlan(document.getElementById('customAdjustment').value); }"></textarea>
              <button onclick="adjustPlan(document.getElementById('customAdjustment').value)" class="adjust-btn"
                style="background: #667eea; width: 100%; padding: 15px; font-size: 16px;">
                ğŸ”„ ã“ã®å†…å®¹ã§èª¿æ•´ã™ã‚‹
              </button>
            </div>

            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
            <div id="adjustmentLoading" style="display: none; margin-top: 15px; text-align: center; color: #666;">
              <div class="spinner"
                style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;">
              </div>
              <span style="margin-left: 10px;">èª¿æ•´ä¸­...</span>
            </div>
          </div>
        </div>
      </div>

      <div class="ad-section">
        <div class="ad-grid">
          <div class="ad-slot">
            <div class="ad-label">åºƒå‘Š</div>
            <div id="im-7c219859b08a432e9674096cbbf2d22e">
              <script>(window.adsbyimobile=window.adsbyimobile||[]).push({pid:84369,mid:589549,asid:1920600,type:"banner",display:"inline",elementid:"im-7c219859b08a432e9674096cbbf2d22e"})</script>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const isLocalhost = window.location.hostname === 'localhost';
    const isFileAccess = window.location.protocol === 'file:';
    const API_BASE = (isLocalhost || isFileAccess)
      ? 'http://localhost:3001'
      : window.location.origin;
    let lastConditions = null;
    let GOOGLE_MAPS_API_KEY = null;

    // STEP2ãƒˆã‚°ãƒ«
    function toggleStep2() {
      const content = document.getElementById('step2Content');
      const icon = document.getElementById('toggleIcon');
      content.classList.toggle('active');
      icon.classList.toggle('expanded');
    }

    function escapeHtml(str = '') {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderReviewItem(review, idx, placeKey) {
      const author = review.author || 'åŒ¿å';
      const rating = review.rating ? ` | â­ ${review.rating}` : '';
      const text = review.text || '';
      const maxLen = 120;
      const needsToggle = text.length > maxLen;
      const shortText = needsToggle ? `${text.slice(0, maxLen)}â€¦` : text;
      const targetId = `review-${placeKey}-${idx}`;

      return `
        <div class="review-item">
          <div class="review-meta">${escapeHtml(author)}${rating}</div>
          <div class="review-text" id="${targetId}">${escapeHtml(shortText)}</div>
          ${needsToggle ? `
            <button class="review-toggle"
              data-target="${targetId}"
              data-full="${escapeHtml(text)}"
              data-short="${escapeHtml(shortText)}"
              data-expanded="false"
              onclick="toggleReviewText(this)">å…¨æ–‡è¡¨ç¤º</button>
          ` : ''}
        </div>
      `;
    }

    function toggleReviewText(button) {
      const targetId = button.getAttribute('data-target');
      const target = document.getElementById(targetId);
      if (!target) return;

      const expanded = button.getAttribute('data-expanded') === 'true';
      if (expanded) {
        target.innerHTML = button.getAttribute('data-short') || '';
        button.textContent = 'å…¨æ–‡è¡¨ç¤º';
        button.setAttribute('data-expanded', 'false');
      } else {
        target.innerHTML = button.getAttribute('data-full') || '';
        button.textContent = 'çŸ­ãè¡¨ç¤º';
        button.setAttribute('data-expanded', 'true');
      }
    }

    // ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´
    async function quickAdjust(type) {
      const adjustments = {
        'cheaper': 'ã‚‚ã£ã¨å®‰ãã—ãŸã„',
        'expensive': 'ã‚‚ã£ã¨è±ªè¯ã«ã—ãŸã„',
        'indoor': 'å±‹å†…ä¸­å¿ƒã«ã—ãŸã„',
        'outdoor': 'å±‹å¤–ä¸­å¿ƒã«ã—ãŸã„',
        'shorter': 'ã‚‚ã£ã¨çŸ­ã‚ã«ã—ãŸã„',
        'longer': 'ã‚‚ã£ã¨é•·ã‚ã«ã—ãŸã„'
      };
      await generatePlan(adjustments[type]);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('planForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await generatePlan();
    });

    async function generatePlan(adjustment = null) {
      const conditions = getFormConditions();

      // èª¿æ•´æ™‚ã‚‚æœ€æ–°ã®conditionsã‚’ä½¿ç”¨ï¼ˆSTEP2ã®å€¤ã‚’å«ã‚€ï¼‰
      if (!adjustment) {
        lastConditions = conditions;
      } else {
        // èª¿æ•´æ™‚ã¯lastConditionsã‚’æœ€æ–°ã®conditionsã§æ›´æ–°
        lastConditions = conditions;
      }

      // æ¡ä»¶ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä»£æ›¿ã‚¹ãƒãƒƒãƒˆæ©Ÿèƒ½ã§ä½¿ç”¨ï¼‰
      window._currentConditions = conditions;

      const planSection = document.getElementById('planSection');
      const loadingContainer = document.getElementById('loadingContainer');
      const planContainer = document.getElementById('planContainer');
      const errorContainer = document.getElementById('errorContainer');
      const quickAdjust = document.getElementById('quickAdjust');

      planSection.classList.add('active');
      loadingContainer.style.display = 'block';
      planContainer.style.display = 'none';
      errorContainer.innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/api/generate-plan`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conditions: conditions,
            adjustment,
          }),
        });

        const data = await response.json();

        if (!data.success || !data.plan) {
          throw new Error(data.error || 'ãƒ—ãƒ©ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        console.log('ğŸ“¥ Received plan:', data.plan);
        displayPlan(data.plan);
        quickAdjust.style.display = 'grid';

      } catch (error) {
        console.error('Error:', error);
        errorContainer.innerHTML = `
          <div class="error">
            <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}<br>
            <small>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
          </div>
        `;
      } finally {
        loadingContainer.style.display = 'none';
        planContainer.style.display = 'block';
      }
    }

    function getFormConditions() {
      const mood = document.querySelector('input[name="mood"]:checked');
      const ngConditions = Array.from(document.querySelectorAll('[id^="ng"]:checked')).map(el => el.value);
      const activityPreferences = Array.from(document.querySelectorAll('input[name="activityPreference"]:checked'))
        .map(el => el.value);
      const activityPriority = activityPreferences.length
        ? (document.querySelector('input[name="activityPriority"]:checked')?.value || 'prefer')
        : null;

      return {
        area: document.getElementById('area').value,
        date_phase: document.getElementById('phase').value,
        time_slot: document.getElementById('timeSlot').value,
        date_budget_level: document.getElementById('budget').value,
        mood: mood ? mood.value : null,
        ng_conditions: ngConditions,
        custom_request: document.getElementById('customRequest').value.trim() || null,
        activity_preferences: activityPreferences,
        activity_priority: activityPriority,
      };
    }

    function isBookingTarget(item) {
      const category = (item.category || '').toLowerCase();
      const name = item.place_name || '';

      if (['restaurant', 'theater', 'museum'].includes(category)) return true;
      if (category === 'entertainment') {
        return name.includes('æ˜ ç”»') || name.toLowerCase().includes('cinema');
      }
      return name.includes('ç¾è¡“é¤¨') || name.includes('åšç‰©é¤¨') || name.includes('ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ');
    }

    function renderBookingSection(item) {
      if (!isBookingTarget(item)) return '';
      const links = Array.isArray(item.booking_links)
        ? item.booking_links.filter(link => link && link.url)
        : [];

      if (!links.length) {
        return `
          <div class="booking-section">
            <div class="booking-title">äºˆç´„</div>
            <div class="booking-links empty">äºˆç´„æƒ…å ±ãªã—</div>
          </div>
        `;
      }

      const buttons = links.map((link) => {
        const label = `${link.icon ? `${link.icon} ` : ''}${link.display_name || 'äºˆç´„ã™ã‚‹'}`;
        return `<a class="booking-btn" href="${link.url}" target="_blank" rel="noopener">${label}</a>`;
      }).join('');

      return `
        <div class="booking-section">
          <div class="booking-title">äºˆç´„</div>
          <div class="booking-links">${buttons}</div>
        </div>
      `;
    }

    function displayPlan(plan) {
      try {
        console.log('ğŸ¨ displayPlan called with:', plan);

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã€ãƒ—ãƒ©ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
        const loadingContainer = document.getElementById('loadingContainer');
        const planContainer = document.getElementById('planContainer');
        if (loadingContainer) loadingContainer.style.display = 'none';
        if (planContainer) planContainer.style.display = 'block';

        // ãƒ—ãƒ©ãƒ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä»£æ›¿ã‚¹ãƒãƒƒãƒˆæ©Ÿèƒ½ã§ä½¿ç”¨ï¼‰
        window._currentPlan = plan;

        console.log('ğŸ“ Setting plan title and cost...');
        document.getElementById('planTitle').textContent = plan.plan_summary;
        document.getElementById('totalCost').textContent = plan.total_estimated_cost;

        if (plan.plan_reason) {
          document.getElementById('planReason').textContent = plan.plan_reason;
          document.getElementById('planReasonContainer').style.display = 'block';
        } else {
          document.getElementById('planReasonContainer').style.display = 'none';
        }

        console.log('ğŸ“… Rendering schedule...');
        console.log('ğŸ“… Schedule items count:', plan.schedule?.length);

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        const scheduleHTML = plan.schedule.map((item, index) => {
          if (item.is_meeting) {
            return `
          <div class="schedule-item${index === 0 ? ' active' : ''}">
            <div class="time">ğŸš© ${item.time}</div>
            <div class="place-name" style="font-weight: bold; color: #667eea;">é›†åˆ: ${item.place_name}</div>
            <div class="reason">ğŸ’¡ ${item.reason}</div>
          </div>`;
          }

          if (item.is_travel) {
            const modeIcon = item.transport_mode === 'train'
              ? 'ğŸš‡'
              : item.transport_mode === 'bus'
                ? 'ğŸšŒ'
                : item.transport_mode === 'taxi'
                  ? 'ğŸš•'
                  : item.transport_mode === 'car'
                    ? 'ğŸš—'
                    : 'ğŸš¶';

            // è·é›¢æƒ…å ±ã®è¡¨ç¤º
            let distanceInfo = '';
            if (item.distance_km) {
              distanceInfo = `ğŸ“ ${item.distance_km}km`;
            } else if (item.walking_distance_m) {
              distanceInfo = `ğŸ“ ç´„${item.walking_distance_m}m`;
            }

            return `
          <div class="schedule-item" style="background: #f5f5f5; border-left: 4px solid #ffa500;">
            <div class="time">${modeIcon} ${item.time}</div>
            <div class="place-name" style="color: #666;">ç§»å‹•ä¸­ï¼ˆ${item.transport_label || 'ç§»å‹•'}${item.duration ? ` | ${item.duration}` : ''}ï¼‰</div>
            ${distanceInfo ? `<div class="details" style="color: #888;">${distanceInfo}</div>` : ''}
            ${item.reason ? `<div class="reason">ğŸ’¡ ${item.reason}</div>` : ''}
          </div>`;
          }

          if (item.is_farewell) {
            return `
          <div class="schedule-item" style="border-left: 4px solid #764ba2;">
            <div class="time">ğŸ‘‹ ${item.time}</div>
            <div class="place-name" style="font-weight: bold; color: #764ba2;">è§£æ•£: ${item.place_name}</div>
            <div class="reason">ğŸ’¡ ${item.reason}</div>
          </div>`;
          }

          const link = item.info_url ? ` | <a href="${item.info_url}" target="_blank" rel="noopener" style="color: #667eea; font-weight: 600; text-decoration: none;">ğŸ“ Google Maps</a>` : '';
          const officialLink = item.official_url ? ` | <a href="${item.official_url}" target="_blank" rel="noopener" style="color: #ff6b6b; font-weight: 600; text-decoration: none;">ğŸ  å…¬å¼HP</a>` : '';
          const rating = item.rating ? ` | â­ ${item.rating}` : '';
          const endTime = item.end_time ? ` ã€œ ${item.end_time}` : '';

          // é¸å®šç†ç”±ã‚¿ã‚°
          const reasonTags = item.reason_tags ? `
          <div class="reason-tags">
            ${item.reason_tags.map(tag => `<span class="reason-tag">${tag}</span>`).join('')}
          </div>
        ` : '';

          const photosHTML = (item.photos && item.photos.length && item.type !== 'walk')
            ? `
            <div class="photo-grid">
              ${item.photos.slice(0, 3).map(src => `<img src="${src}" alt="${item.place_name}ã®å†™çœŸ">`).join('')}
            </div>
          `
            : '';

          const reviewsHTML = item.reviews && item.reviews.length
            ? `
            <div class="review-block">
              <div class="review-title">å£ã‚³ãƒŸ</div>
              ${item.reviews.slice(0, 2).map((r, idx) => renderReviewItem(r, idx, `${index}`)).join('')}
            </div>
          `
            : '';

          // å–¶æ¥­æ™‚é–“å¤–è­¦å‘Šã®è¡¨ç¤º
          const closedWarningHTML = item.closed_warning
            ? `
            <div class="closed-warning-block">
              âš ï¸ ${item.closed_warning}
            </div>
          `
            : '';

          const bookingHTML = renderBookingSection(item);

          return `
        <div class="schedule-item" data-spot-index="${index}">
          <div class="time">${item.time}${endTime}</div>
          <div class="place-name">${item.place_name}${rating}</div>
          <div class="details">ğŸ“ ${item.area}${item.price_range ? ` | ğŸ’° ${item.price_range}` : ''}${item.duration ? ` | â±ï¸ ${item.duration}` : ''}${link}${officialLink}</div>
          <div class="reason">ğŸ’¡ ${item.reason}</div>
          ${reasonTags}
          ${closedWarningHTML}
          ${photosHTML}
          ${reviewsHTML}
          ${bookingHTML}
          <button class="alternative-btn" onclick="toggleAlternatives(${index})" data-spot-index="${index}">
            ğŸ”„ åˆ¥ã®å ´æ‰€ã‚’æ¢ã™
          </button>
          <div class="alternatives-container" id="alternatives-${index}" style="display: none;">
            <div class="alternatives-loading">ä»£æ›¿ã‚¹ãƒãƒƒãƒˆã‚’æ¤œç´¢ä¸­...</div>
          </div>
        </div>
      `}).join('');

        console.log('ğŸ“… Schedule HTML generated, length:', scheduleHTML.length);
        document.getElementById('scheduleContainer').innerHTML = scheduleHTML;
        console.log('âœ… Schedule HTML set');

        // ä¼šè©±ãƒã‚¿
        if (plan.conversation_topics) {
          const topicsHTML = plan.conversation_topics.map(topic => `<li>âœ¨ ${topic}</li>`).join('');
          document.getElementById('conversationTopics').innerHTML = topicsHTML;
        }

        // æ¬¡å›ã¸ã®ã‚»ãƒªãƒ•
        if (plan.next_step_phrase) {
          document.getElementById('nextStepPhrase').textContent = `"${plan.next_step_phrase}"`;
        }

        console.log('ğŸ—ºï¸ Rendering map...');
        // åœ°å›³è¡¨ç¤º
        renderMap(plan);
        console.log('âœ… displayPlan completed successfully');
      } catch (error) {
        console.error('âŒ Error in displayPlan:', error);
        console.error('âŒ Error stack:', error.stack);
        console.error('âŒ Plan data:', plan);

        // Display error message to user
        document.body.innerHTML = `
          <div style="padding: 20px; color: red; font-family: monospace;">
            <h2>ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚¨ãƒ©ãƒ¼</h2>
            <p>ãƒ—ãƒ©ãƒ³ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:</p>
            <pre>${error.message}\n\n${error.stack}</pre>
            <hr>
            <h3>ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿:</h3>
            <pre>${JSON.stringify(plan, null, 2)}</pre>
          </div>
        `;
      }
    }

    function renderMap(plan) {
      const mapEl = document.getElementById('map');

      try {
        if (!plan.schedule || plan.schedule.length === 0) return;

        if (typeof google === 'undefined' || !google.maps) {
          mapEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
          setTimeout(() => renderMap(plan), 1000);
          return;
        }

        const firstSpot = plan.schedule.find(item => item.lat && item.lng);
        if (!firstSpot) return;

        const mapCenter = { lat: firstSpot.lat, lng: firstSpot.lng };
        window._dateAiMap = new google.maps.Map(mapEl, {
          zoom: 14,
          center: mapCenter,
          mapId: 'DEMO_MAP_ID',
        });

        const bounds = new google.maps.LatLngBounds();
        const path = [];

        plan.schedule.forEach((item, idx) => {
          if (item.lat && item.lng && !item.is_travel) {
            const position = { lat: item.lat, lng: item.lng };
            path.push(position);
            bounds.extend(position);

            const marker = new google.maps.Marker({
              position,
              map: window._dateAiMap,
              label: {
                text: String(path.length),
                color: 'white',
                fontWeight: 'bold',
              },
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 20,
                fillColor: '#667eea',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 3,
              },
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `
                <div style="padding: 10px;">
                  <strong>${path.length}. ${item.place_name}</strong><br>
                  <span style="color: #667eea;">${item.time}</span> | ${item.duration}<br>
                  ${item.rating ? `â­ ${item.rating}<br>` : ''}
                </div>
              `,
            });

            marker.addListener('click', () => {
              infoWindow.open(window._dateAiMap, marker);
            });
          }
        });

        if (path.length > 1) {
          new google.maps.Polyline({
            path,
            geodesic: true,
            strokeColor: '#667eea',
            strokeOpacity: 0.7,
            strokeWeight: 4,
            map: window._dateAiMap,
          });
          window._dateAiMap.fitBounds(bounds);

          // Google Maps URLç”Ÿæˆ
          const origin = `${path[0].lat},${path[0].lng}`;
          const destination = `${path[path.length - 1].lat},${path[path.length - 1].lng}`;
          let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;

          if (path.length > 2) {
            const waypoints = path.slice(1, -1).map(p => `${p.lat},${p.lng}`).join('|');
            url += `&waypoints=${waypoints}`;
          }
          url += '&travelmode=walking';

          const btn = document.getElementById('googleMapsLink');
          if (btn) {
            btn.href = url;
            btn.style.display = 'flex';
          }
        } else {
          // ã‚¹ãƒãƒƒãƒˆãŒ1ã¤ä»¥ä¸‹ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆã‚ã‚‹ã„ã¯å˜ä¸€ã‚¹ãƒãƒƒãƒˆã¸ã®ãƒªãƒ³ã‚¯ã«ã™ã‚‹ãªã©ï¼‰
          const btn = document.getElementById('googleMapsLink');
          if (btn) btn.style.display = 'none';
        }
      } catch (error) {
        console.error('Map rendering error:', error);
        mapEl.innerHTML = `<div style="padding: 20px; text-align: center; color: #c33;">åœ°å›³ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
      }
    }

    // ã‚¹ãƒãƒƒãƒˆä»£æ›¿æ©Ÿèƒ½
    let currentAlternatives = {}; // { spotIndex: [alternatives] }

    // è·é›¢è¨ˆç®—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = (deg) => deg * Math.PI / 180;
      const R = 6371000; // meters
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function estimateWalkingMinutes(distanceMeters) {
      const walkingSpeedMPerMin = 5000 / 60; // ~83.33 m/min
      return Math.max(1, Math.round(distanceMeters / walkingSpeedMPerMin));
    }

    // ç§»å‹•æ™‚é–“ã‚’å†è¨ˆç®—
    function recalculateTravelTimes(plan) {
      const schedule = plan.schedule;

      for (let i = 0; i < schedule.length; i++) {
        const item = schedule[i];

        // ç§»å‹•é …ç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (item.is_travel || item.is_meeting || item.is_farewell) continue;

        // å‰ã®ã‚¹ãƒãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹
        let prevSpot = null;
        for (let j = i - 1; j >= 0; j--) {
          if (!schedule[j].is_travel && schedule[j].lat && schedule[j].lng) {
            prevSpot = schedule[j];
            break;
          }
        }

        // æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹
        let nextSpot = null;
        for (let j = i + 1; j < schedule.length; j++) {
          if (!schedule[j].is_travel && schedule[j].lat && schedule[j].lng) {
            nextSpot = schedule[j];
            break;
          }
        }

        // å‰ã®ã‚¹ãƒãƒƒãƒˆã‹ã‚‰ã®è·é›¢ã¨æ™‚é–“ã‚’è¨ˆç®—
        if (prevSpot && item.lat && item.lng) {
          const dist = Math.round(haversineDistance(prevSpot.lat, prevSpot.lng, item.lat, item.lng));
          const travelMin = estimateWalkingMinutes(dist);

          // å‰ã®ç§»å‹•é …ç›®ã‚’æ›´æ–°ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
          if (i > 0 && schedule[i - 1].is_travel) {
            schedule[i - 1].walking_distance_m = dist;
            schedule[i - 1].duration = `${travelMin}min`;
            schedule[i - 1].reason = `å¾’æ­©ã§æ¬¡ã®ç›®çš„åœ°ã¸ç§»å‹•ï¼ˆç´„${travelMin}åˆ†ï¼‰`;
          }
        }

        // æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸ã®ç§»å‹•é …ç›®ã‚’æ›´æ–°ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
        if (nextSpot && item.lat && item.lng && i < schedule.length - 1 && schedule[i + 1].is_travel) {
          const dist = Math.round(haversineDistance(item.lat, item.lng, nextSpot.lat, nextSpot.lng));
          const travelMin = estimateWalkingMinutes(dist);
          schedule[i + 1].walking_distance_m = dist;
          schedule[i + 1].duration = `${travelMin}min`;
          schedule[i + 1].reason = `å¾’æ­©ã§æ¬¡ã®ç›®çš„åœ°ã¸ç§»å‹•ï¼ˆç´„${travelMin}åˆ†ï¼‰`;
        }
      }

      return plan;
    }

    async function toggleAlternatives(spotIndex) {
      const container = document.getElementById(`alternatives-${spotIndex}`);
      const btn = document.querySelector(`button[data-spot-index="${spotIndex}"]`);

      if (!container || !btn) return;

      // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
      if (container.style.display !== 'none') {
        container.style.display = 'none';
        btn.classList.remove('active');
        return;
      }

      // é–‹ã
      container.style.display = 'block';
      btn.classList.add('active');

      // æ—¢ã«å–å¾—æ¸ˆã¿ã®å ´åˆã¯å†åˆ©ç”¨
      if (currentAlternatives[spotIndex]) {
        displayAlternatives(spotIndex, currentAlternatives[spotIndex]);
        return;
      }

      // ä»£æ›¿ã‚¹ãƒãƒƒãƒˆã‚’å–å¾—
      try {
        const currentSpot = window._currentPlan.schedule[spotIndex];
        const conditions = window._currentConditions || {
          area: 'shibuya',
          date_budget_level: 'medium',
          date_phase: 'casual',
          time_slot: 'lunch'
        };

        if (!currentSpot || currentSpot.is_travel || currentSpot.is_meeting || currentSpot.is_farewell) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ã“ã®ã‚¹ãƒãƒƒãƒˆã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>';
          return;
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªã®æ±ºå®š
        let category = currentSpot.category;
        if (!category) {
          if (currentSpot.type === 'lunch' || currentSpot.type === 'dinner') category = 'restaurant';
          else if (currentSpot.type === 'cafe') category = 'cafe';
          else category = 'restaurant';
        }

        // é™¤å¤–ã‚¹ãƒãƒƒãƒˆã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const excludeSpots = (window._currentPlan.schedule || [])
          .filter(item => item && !item.is_travel && !item.is_meeting && !item.is_farewell && (item.place_name || item.name))
          .map(item => item.place_name || item.name);

        console.log(`ğŸ” Fetching alternatives for: ${currentSpot.place_name || currentSpot.name}, category: ${category}`);

        const response = await fetch(`${API_BASE}/api/get-alternative-spots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            category: category,
            area: conditions.area || 'shibuya',
            budget: conditions.date_budget_level || 'medium',
            datePhase: conditions.date_phase || 'casual',
            timeSlot: conditions.time_slot || 'lunch',
            mood: conditions.mood,
            ngConditions: conditions.ng_conditions || [],
            excludeSpots,
            limit: 5
          })
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}`);
        }

        const data = await response.json();

        if (!data.success || !data.alternatives || data.alternatives.length === 0) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ä»£æ›¿ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
          return;
        }

        currentAlternatives[spotIndex] = data.alternatives;
        displayAlternatives(spotIndex, data.alternatives);

      } catch (error) {
        console.error('Error fetching alternatives:', error);
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #c33;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }

    function displayAlternatives(spotIndex, alternatives) {
      const container = document.getElementById(`alternatives-${spotIndex}`);
      if (!container) return;

      const alternativesHTML = `
        <div class="alternatives-list">
          ${alternatives.map((alt, idx) => `
            <div class="alternative-spot" onclick="replaceSpot(${spotIndex}, ${idx})">
              <div class="alternative-spot-name">${alt.place_name}${alt.rating ? ` â­ ${alt.rating}` : ''}</div>
              <div class="alternative-spot-details">
                ğŸ“ ${alt.area} | ğŸ’° ${alt.price_range || 'æœªè¨­å®š'} | â±ï¸ ${alt.duration || 'æœªè¨­å®š'}
              </div>
              <div class="alternative-spot-reason">ğŸ’¡ ${alt.reason || 'ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆã§ã™'}</div>
              ${alt.reason_tags ? `
                <div class="reason-tags" style="margin-top: 8px;">
                  ${alt.reason_tags.map(tag => `<span class="reason-tag">${tag}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `;

      container.innerHTML = alternativesHTML;
    }

    function replaceSpot(spotIndex, alternativeIndex) {
      const alternative = currentAlternatives[spotIndex][alternativeIndex];
      if (!alternative) return;

      // ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°
      const oldSpot = window._currentPlan.schedule[spotIndex];
      window._currentPlan.schedule[spotIndex] = {
        ...oldSpot,
        ...alternative,
        time: oldSpot.time, // æ™‚é–“ã¯ç¶­æŒ
        end_time: oldSpot.end_time
      };

      // ç§»å‹•æ™‚é–“ã‚’å†è¨ˆç®—
      recalculateTravelTimes(window._currentPlan);

      // è¡¨ç¤ºã‚’æ›´æ–°
      displayPlan(window._currentPlan);

      // åœ°å›³ã‚’æ›´æ–°
      renderMap(window._currentPlan);

      // ä»£æ›¿ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      delete currentAlternatives[spotIndex];

      console.log(`ğŸ”„ Replaced spot at index ${spotIndex} with ${alternative.place_name}`);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–å‡¦ç†
    (function initializePage() {
      try {
        console.log('ğŸ”§ Page initialization started');

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
        const urlParams = new URLSearchParams(window.location.search);
        const fromWizard = urlParams.get('from') === 'wizard';

        console.log('ğŸ“ URL: ' + window.location.search);
        console.log('ğŸ“ fromWizard: ' + fromWizard);

        if (fromWizard) {
          console.log('ğŸ§™ Wizard mode detected');

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          const header = document.querySelector('header');
          const formSection = document.querySelector('.form-section');
          const mainContent = document.querySelector('.main-content');

          if (header) {
            header.style.display = 'none';
          }
          if (formSection) {
            formSection.style.display = 'none';
          }
          // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’1ã‚«ãƒ©ãƒ ã«
          if (mainContent) {
            mainContent.style.gridTemplateColumns = '1fr';
            mainContent.style.maxWidth = '100%';
          }

          // localStorageã‹ã‚‰ãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã‚€
          const savedPlan = localStorage.getItem('generatedPlan');

          if (savedPlan) {
            try {
              const plan = JSON.parse(savedPlan);
              window._currentPlan = plan;

              // localStorageã‹ã‚‰æ¡ä»¶ã‚’èª­ã¿è¾¼ã‚€ï¼ˆä»£æ›¿ã‚¹ãƒãƒƒãƒˆæ¤œç´¢ã«å¿…è¦ï¼‰
              const savedConditions = localStorage.getItem('currentConditions');
              if (savedConditions) {
                window._currentConditions = JSON.parse(savedConditions);
                console.log('âœ… Loaded currentConditions from localStorage');
              }

              // ãƒ—ãƒ©ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆé€šå¸¸ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ï¼‰
              const planSection = document.querySelector('.plan-section');

              if (planSection) {
                planSection.classList.add('active');
                planSection.style.display = 'block';
              }

              // ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º
              displayPlan(plan);

            } catch (error) {
              console.error('âŒ Error:', error);
              console.error('âŒ Stack:', error.stack);
              document.body.innerHTML = `<div style="padding: 20px; color: red;">
                <h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                <pre>${error.message}\n\n${error.stack}</pre>
              </div>`;
            }
          } else {
            console.warn('âš ï¸ No plan in localStorage');
            document.body.innerHTML = '<div style="padding: 20px;">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          }
        } else {
          console.log('â„¹ï¸ Normal mode');
        }
      } catch (error) {
        console.error('âŒ Fatal:', error);
        document.body.innerHTML = `<div style="padding: 20px; color: red;">
          <h2>è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼</h2>
          <pre>${error.message}\n\n${error.stack}</pre>
        </div>`;
      }
    })();

    // ãƒ—ãƒ©ãƒ³èª¿æ•´æ©Ÿèƒ½
    async function adjustPlan(adjustmentText) {
      if (!adjustmentText || !adjustmentText.trim()) {
        alert('èª¿æ•´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const loadingDiv = document.getElementById('adjustmentLoading');
      loadingDiv.style.display = 'block';

      try {
        // ç¾åœ¨ã®æ¡ä»¶ã‚’å–å¾—ï¼ˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯localStorageã‹ã‚‰ï¼‰
        const wizardData = localStorage.getItem('wizardData');
        let currentConditions;

        if (wizardData) {
          currentConditions = JSON.parse(wizardData);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‹ã‚‰æ¡ä»¶ã‚’æ¨æ¸¬
          currentConditions = {
            area: window._currentPlan?.area || 'shibuya',
            budget: 'medium',
            phase: 'casual'
          };
        }

        console.log('ğŸ”„ Adjusting plan with:', adjustmentText);
        console.log('ğŸ“‹ Current conditions:', currentConditions);

        const response = await fetch('/api/generate-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wizard_data: currentConditions,
            adjustment: adjustmentText
          })
        });

        const result = await response.json();

        if (result.success) {
          console.log('âœ… Plan adjusted successfully');
          window._currentPlan = result.plan;
          displayPlan(result.plan);

          // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
          const inputField = document.getElementById('customAdjustment');
          if (inputField) {
            inputField.value = '';
          }
        } else {
          alert('èª¿æ•´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
        }
      } catch (error) {
        console.error('Adjustment error:', error);
        alert('èª¿æ•´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // ã‚¨ãƒªã‚¢å¤‰æ›´ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showAreaChangeDialog() {
      const areas = [
        { value: 'shibuya', label: 'æ¸‹è°·' },
        { value: 'shinjuku', label: 'æ–°å®¿' },
        { value: 'ginza', label: 'éŠ€åº§' },
        { value: 'roppongi', label: 'å…­æœ¬æœ¨' },
        { value: 'harajuku', label: 'åŸå®¿' },
        { value: 'asakusa', label: 'æµ…è‰' },
        { value: 'ikebukuro', label: 'æ± è¢‹' },
        { value: 'ebisu', label: 'æµæ¯”å¯¿' }
      ];

      const areaOptions = areas.map(area =>
        `<option value="${area.value}">${area.label}</option>`
      ).join('');

      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      dialog.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
          <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ“ ã‚¨ãƒªã‚¢ã‚’é¸æŠ</h3>
          <select id="newAreaSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 20px;">
            ${areaOptions}
          </select>
          <div style="display: flex; gap: 10px;">
            <button onclick="confirmAreaChange()" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              å¤‰æ›´ã™ã‚‹
            </button>
            <button onclick="closeAreaDialog()" style="flex: 1; padding: 12px; background: #ccc; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
      `;

      dialog.id = 'areaChangeDialog';
      document.body.appendChild(dialog);
    }

    function closeAreaDialog() {
      const dialog = document.getElementById('areaChangeDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    async function confirmAreaChange() {
      const select = document.getElementById('newAreaSelect');
      const newArea = select.value;

      closeAreaDialog();

      // ã‚¨ãƒªã‚¢å¤‰æ›´ã§ãƒ—ãƒ©ãƒ³ã‚’å†ç”Ÿæˆ
      const wizardData = localStorage.getItem('wizardData');
      let currentConditions = wizardData ? JSON.parse(wizardData) : {};
      currentConditions.area = newArea;

      // ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      localStorage.setItem('wizardData', JSON.stringify(currentConditions));

      // ãƒ—ãƒ©ãƒ³ã‚’å†ç”Ÿæˆ
      const loadingDiv = document.getElementById('adjustmentLoading');
      loadingDiv.style.display = 'block';

      try {
        const response = await fetch('/api/generate-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wizard_data: currentConditions
          })
        });

        const result = await response.json();

        if (result.success) {
          window._currentPlan = result.plan;
          displayPlan(result.plan);
        } else {
          alert('ã‚¨ãƒªã‚¢å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
        }
      } catch (error) {
        console.error('Area change error:', error);
        alert('ã‚¨ãƒªã‚¢å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    function updateAdSlotState(slot) {
      const hasAd = !!slot.querySelector('iframe, img, ins');
      slot.classList.toggle('ad-empty', !hasAd);
    }

    function initializeAdSlots() {
      const slots = document.querySelectorAll('.ad-slot');
      if (!slots.length) return;

      slots.forEach((slot) => {
        updateAdSlotState(slot);
        const observer = new MutationObserver(() => updateAdSlotState(slot));
        observer.observe(slot, { childList: true, subtree: true });
      });

      setTimeout(() => slots.forEach(updateAdSlotState), 2000);
      setTimeout(() => slots.forEach(updateAdSlotState), 5000);
    }

    window.addEventListener('load', initializeAdSlots);
  </script>
</body>

</html>
