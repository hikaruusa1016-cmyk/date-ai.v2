<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³è‡ªå‹•ç”Ÿæˆ | Date AI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .form-section h2 {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 25px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    select,
    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    select:focus,
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-right: 8px;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.05em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .adjust-section {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }

    .adjust-section.active {
      display: block;
    }

    .adjust-section textarea {
      min-height: 60px;
      font-size: 0.9em;
    }

    /* ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .plan-section {
      min-height: 400px;
      display: none;
    }

    .plan-section.active {
      display: block;
    }

    .plan-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .plan-summary h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .cost-info {
      font-size: 1.1em;
      opacity: 0.95;
    }

    .schedule {
      margin: 25px 0;
    }

    .schedule h3 {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .schedule-item {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .schedule-item.active {
      background: #f0f4ff;
      border-left-color: #764ba2;
    }

    .time {
      font-size: 1.3em;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .place-name {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .details {
      font-size: 0.9em;
      color: #666;
      margin: 8px 0;
    }

    .reason {
      font-size: 0.9em;
      color: #764ba2;
      font-style: italic;
      margin-top: 8px;
      padding: 8px;
      background: rgba(118, 75, 162, 0.05);
      border-radius: 4px;
    }

    .affiliate-links {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .affiliate-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .affiliate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .affiliate-btn.tabelog {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
    }

    .info-section {
      margin-top: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .info-section h3 {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 10px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .info-list {
      list-style: none;
      margin-left: 0;
    }

    .info-list li {
      padding: 8px 0;
      color: #555;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .info-list strong {
      color: #764ba2;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .next-step {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-size: 1.05em;
      font-weight: 600;
    }

    .adjustable-points {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
    }

    .adjustable-points span {
      background: #667eea;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
    }

    @media (max-width: 960px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.8em;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
      padding: 12px 20px;
      background: white;
      color: #666;
      border: none;
      border-radius: 0;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      transition: all 0.3s;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
  <!-- Google Maps API -->
  <script>
    // Google Maps API ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.gm_authFailure = function() {
      console.error('Google Maps authentication failed');
      const mapEl = document.getElementById('map');
      if (mapEl) {
        mapEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #c33; background: #fee; border-radius: 8px;"><strong>Google Maps APIã‚¨ãƒ©ãƒ¼</strong><br><br><strong>ç¢ºèªäº‹é …:</strong><br>1. <a href="https://console.cloud.google.com/google/maps-apis/api-list" target="_blank" style="color: #667eea;">Maps JavaScript API</a> ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹<br>2. APIã‚­ãƒ¼ã®ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ¶é™ã€ãŒã€Œãªã—ã€ã¾ãŸã¯ã€ŒHTTPãƒªãƒ•ã‚¡ãƒ©ãƒ¼: localhostã€ã‚’å«ã‚€ã‹<br>3. APIã‚­ãƒ¼ã®ã€ŒAPIã®åˆ¶é™ã€ã§ã€ŒMaps JavaScript APIã€ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹<br><br><a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #667eea; font-weight: bold;">ğŸ“ èªè¨¼æƒ…å ±ãƒšãƒ¼ã‚¸ã§ç¢ºèª</a></div>';
      }
    };

    // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
    window.addEventListener('error', function(e) {
      if (e.message && e.message.includes('Google Maps')) {
        console.error('Google Maps Error Details:', e);
      }
    });

    // Google Maps APIã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ï¼ˆAPIã‚­ãƒ¼ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—ï¼‰
    (async function loadGoogleMaps() {
      try {
        const API_BASE_URL = window.location.hostname === 'localhost'
          ? 'http://localhost:3001'
          : window.location.origin;
        const response = await fetch(`${API_BASE_URL}/api/maps-key`);
        const data = await response.json();

        if (data.apiKey) {
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆPlaces APIç”¨ï¼‰
          GOOGLE_MAPS_API_KEY = data.apiKey;

          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&callback=Function.prototype`;
          script.async = true;
          script.defer = true;
          script.onerror = () => console.error('Failed to load Google Maps script');
          document.head.appendChild(script);
        } else {
          console.warn('Google Maps API key not available');
        }
      } catch (error) {
        console.error('Failed to fetch Maps API key:', error);
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ’˜ ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ AI</h1>
      <p class="subtitle">æ¡ä»¶ã‚’é¸ã¶ã ã‘ã§å®Œç’§ãªãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãŒå®Œæˆï¼</p>
    </header>

    <div class="main-content">
      <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-section">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 1: æ¡ä»¶ã‚’å…¥åŠ›</h2>
        <form id="planForm">
          <!-- åŸºæœ¬æƒ…å ± -->
          <div class="form-group">
            <label for="userAge">ã‚ãªãŸã®å¹´ä»£ *</label>
            <select id="userAge" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="20s">20ä»£</option>
              <option value="30s">30ä»£</option>
              <option value="40s+">40ä»£ä»¥ä¸Š</option>
            </select>
          </div>

          <div class="form-group">
            <label for="userPersonality">ã‚ãªãŸã®æ€§æ ¼ã‚¿ã‚¤ãƒ— *</label>
            <select id="userPersonality" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="indoor">ã‚¤ãƒ³ãƒ‰ã‚¢æ´¾</option>
              <option value="balanced">ãƒãƒ©ãƒ³ã‚¹æ´¾</option>
              <option value="outdoor">ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ´¾</option>
              <option value="talkative">ãŠã—ã‚ƒã¹ã‚Šï¼ˆè©±å¥½ãï¼‰</option>
              <option value="quiet">ç©ã‚„ã‹ï¼ˆè½ã¡ç€ã„ã¦ã„ã‚‹ï¼‰</option>
              <option value="adventurous">å†’é™ºå¥½ãï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰</option>
              <option value="shy">æ§ãˆã‚ï¼ˆã‚·ãƒ£ã‚¤ï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label>ã‚ãªãŸã®èˆˆå‘³ *</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="interestGourmet" value="gourmet">
                <label for="interestGourmet">ã‚°ãƒ«ãƒ¡</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestWalk" value="walk">
                <label for="interestWalk">æ•£æ­©</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestMovie" value="movie">
                <label for="interestMovie">æ˜ ç”»</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestArt" value="art">
                <label for="interestArt">ç¾è¡“ãƒ»åšç‰©é¤¨</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestShop" value="shop">
                <label for="interestShop">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestSport" value="sport">
                <label for="interestSport">ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestCafe" value="cafe">
                <label for="interestCafe">ã‚«ãƒ•ã‚§å·¡ã‚Š</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestMusic" value="music">
                <label for="interestMusic">éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestNature" value="nature">
                <label for="interestNature">è‡ªç„¶ãƒ»å…¬åœ’</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="interestPhoto" value="photography">
                <label for="interestPhoto">å†™çœŸãƒ»æ’®å½±</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="budget">äºˆç®—ãƒ¬ãƒ™ãƒ« *</label>
            <select id="budget" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="low">ä½ï¼ˆ3000-5000å††ï¼‰</option>
              <option value="medium">ä¸­ï¼ˆ5000-10000å††ï¼‰</option>
              <option value="high">é«˜ï¼ˆ10000å††ä»¥ä¸Šï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label for="phase">ãƒ‡ãƒ¼ãƒˆã®æ®µéš *</label>
            <select id="phase" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="first">åˆãƒ‡ãƒ¼ãƒˆ</option>
              <option value="second">2ã€œ3å›ç›®</option>
              <option value="deepen">é–¢ä¿‚ã‚’æ·±ã‚ã‚‹</option>
            </select>
          </div>

          <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ± -->
          <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

          <div class="form-group">
            <label for="partnerAge">ç›¸æ‰‹ã®å¹´ä»£ *</label>
            <select id="partnerAge" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="20s">20ä»£</option>
              <option value="30s">30ä»£</option>
              <option value="40s+">40ä»£ä»¥ä¸Š</option>
            </select>
          </div>

          <div class="form-group">
            <label for="partnerPersonality">ç›¸æ‰‹ã®æ€§æ ¼ã‚¿ã‚¤ãƒ— *</label>
            <select id="partnerPersonality" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="indoor">ã‚¤ãƒ³ãƒ‰ã‚¢æ´¾</option>
              <option value="balanced">ãƒãƒ©ãƒ³ã‚¹æ´¾</option>
              <option value="outdoor">ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ´¾</option>
              <option value="talkative">ãŠã—ã‚ƒã¹ã‚Šï¼ˆè©±å¥½ãï¼‰</option>
              <option value="quiet">ç©ã‚„ã‹ï¼ˆè½ã¡ç€ã„ã¦ã„ã‚‹ï¼‰</option>
              <option value="adventurous">å†’é™ºå¥½ãï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰</option>
              <option value="shy">æ§ãˆã‚ï¼ˆã‚·ãƒ£ã‚¤ï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label>ç›¸æ‰‹ã®èˆˆå‘³ *</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="partnerGourmet" value="gourmet">
                <label for="partnerGourmet">ã‚°ãƒ«ãƒ¡</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerWalk" value="walk">
                <label for="partnerWalk">æ•£æ­©</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerMovie" value="movie">
                <label for="partnerMovie">æ˜ ç”»</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerArt" value="art">
                <label for="partnerArt">ç¾è¡“ãƒ»åšç‰©é¤¨</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerShop" value="shop">
                <label for="partnerShop">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerSport" value="sport">
                <label for="partnerSport">ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerCafe" value="cafe">
                <label for="partnerCafe">ã‚«ãƒ•ã‚§å·¡ã‚Š</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerMusic" value="music">
                <label for="partnerMusic">éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerNature" value="nature">
                <label for="partnerNature">è‡ªç„¶ãƒ»å…¬åœ’</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="partnerPhoto" value="photography">
                <label for="partnerPhoto">å†™çœŸãƒ»æ’®å½±</label>
              </div>
            </div>
          </div>

          <!-- ã‚¨ãƒªã‚¢ -->
          <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

          <div class="form-group">
            <label for="area">ãƒ‡ãƒ¼ãƒˆã‚¨ãƒªã‚¢ *</label>
            <select id="area" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="shibuya">æ¸‹è°·</option>
              <option value="shinjuku">æ–°å®¿</option>
              <option value="ginza">éŠ€åº§</option>
              <option value="harajuku">åŸå®¿</option>
              <option value="odaiba">ãŠå°å ´</option>
              <option value="ueno">ä¸Šé‡</option>
              <option value="asakusa">æµ…è‰</option>
              <option value="ikebukuro">æ± è¢‹</option>
            </select>
          </div>

          <!-- ä»»æ„é …ç›® -->
          <div class="form-group">
            <label for="duration">ãƒ‡ãƒ¼ãƒˆæ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
            <select id="duration">
              <option value="">æŒ‡å®šã—ãªã„</option>
              <option value="short">çŸ­ã‚ï¼ˆåŠæ—¥ï¼‰</option>
              <option value="normal">é€šå¸¸ï¼ˆ1æ—¥ï¼‰</option>
              <option value="long">é•·ã‚ï¼ˆä¸¸1æ—¥ï¼‰</option>
            </select>
          </div>

          <button type="submit" id="generateBtn">âœ¨ ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
        </form>

        <!-- èª¿æ•´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="adjust-section" id="adjustSection">
          <h3>ãƒ—ãƒ©ãƒ³ã‚’èª¿æ•´ã™ã‚‹</h3>
          <textarea id="adjustmentInput" placeholder="ä¾‹ï¼šã‚‚ã†å°‘ã—å®‰ãã—ãŸã„ã€é›¨ã®æ—¥ç”¨ã«å¤‰æ›´ã—ãŸã„ã€å¤œã¯çŸ­ã‚ã«..."></textarea>
          <button id="adjustBtn" type="button" style="margin-top: 10px;">ğŸ”„ ãƒ—ãƒ©ãƒ³ã‚’ä¿®æ­£</button>
        </div>
      </div>

      <!-- ãƒ—ãƒ©ãƒ³è¡¨ç¤º -->
      <div class="card plan-section" id="planSection">
        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆä¸­...</p>
        </div>
        <div id="planContainer" style="display: none;">
          <div class="plan-summary">
            <h3 id="planTitle"></h3>
            <div class="cost-info">ğŸ’° äºˆç®—ç›®å®‰: <span id="totalCost"></span></div>
            <div id="planReasonContainer" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); border-radius: 12px; border-left: 4px solid #667eea;">
              <strong style="color: #667eea;">ğŸ“ ã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸ã‚“ã ç†ç”±</strong>
              <p id="planReason" style="margin-top: 8px; color: #4a5568; line-height: 1.6;"></p>
            </div>
          </div>

          <div class="schedule">
            <h3>ğŸ“… æœ¬æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
            <div id="scheduleContainer"></div>
          </div>

          <div style="margin-top: 30px;">
            <h3 style="font-size: 1.3em; color: #333; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ—ºï¸ ãƒ‡ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
            <div id="map" style="height: 400px; border-radius:8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
          </div>

          <div class="adjustable-points">
            <strong style="width: 100%; color: #333;">èª¿æ•´å¯èƒ½ãªãƒã‚¤ãƒ³ãƒˆ:</strong>
            <div id="adjustablePointsContainer"></div>
          </div>

          <div class="info-section">
            <h3>ğŸ’¬ ä¼šè©±ãƒã‚¿ï¼ˆ3ã¤ï¼‰</h3>
            <ul class="info-list" id="conversationTopics"></ul>
          </div>

          <div class="info-section" id="routeInfo" style="display:none;">
            <h3>ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆæƒ…å ±</h3>
            <ul class="info-list" id="routeSummary"></ul>
          </div>

          <div class="next-step" id="nextStepPhrase"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç’°å¢ƒã«å¿œã˜ã¦APIãƒ™ãƒ¼ã‚¹URLã‚’è¨­å®š
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:3001'
      : window.location.origin;
    let lastConditions = null;  // æœ€å¾Œã®æ¡ä»¶ã‚’ä¿æŒ
    let GOOGLE_MAPS_API_KEY = null;  // Google Maps API Key

    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨Places APIæ¤œç´¢é–¢æ•°
    async function searchPlacesFromFrontend(query, location, options = {}) {
      if (!GOOGLE_MAPS_API_KEY) {
        console.warn('Google Maps API key not available');
        return null;
      }

      const AREA_CENTERS = {
        'shibuya': { lat: 35.6595, lng: 139.7004 },
        'shinjuku': { lat: 35.6938, lng: 139.7034 },
        'ginza': { lat: 35.6715, lng: 139.7656 },
        'harajuku': { lat: 35.6657, lng: 139.7125 },
        'odaiba': { lat: 35.6270, lng: 139.7769 },
        'ueno': { lat: 35.7138, lng: 139.7770 },
        'asakusa': { lat: 35.7148, lng: 139.7967 },
        'ikebukuro': { lat: 35.7296, lng: 139.7160 },
      };

      const areaNameMap = {
        'shibuya': 'æ¸‹è°·',
        'shinjuku': 'æ–°å®¿',
        'ginza': 'éŠ€åº§',
        'harajuku': 'åŸå®¿',
        'odaiba': 'ãŠå°å ´',
        'ueno': 'ä¸Šé‡',
        'asakusa': 'æµ…è‰',
        'ikebukuro': 'æ± è¢‹',
      };

      const locationJa = areaNameMap[location] || location;
      const center = AREA_CENTERS[location] || AREA_CENTERS['shibuya'];

      try {
        const url = 'https://places.googleapis.com/v1/places:searchText';
        const body = {
          textQuery: `${query} ${locationJa}`,
          languageCode: 'ja',
          maxResultCount: 10,
          locationBias: {
            circle: {
              center: { latitude: center.lat, longitude: center.lng },
              radius: 2500.0
            }
          }
        };

        if (options.category) {
          body.includedType = options.category;
        }

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Goog-Api-Key': GOOGLE_MAPS_API_KEY,
            'X-Goog-FieldMask': 'places.displayName,places.formattedAddress,places.location,places.rating,places.name,places.googleMapsUri'
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`Places API error: ${response.status}`);
        }

        const data = await response.json();
        const places = data.places || [];

        if (places.length === 0) return null;

        // ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆä¸Šä½5ä»¶ã‹ã‚‰ï¼‰
        const maxResults = Math.min(places.length, 5);
        const randomIndex = Math.floor(Math.random() * maxResults);
        const p = places[randomIndex];

        const lat = p.location?.latitude || null;
        const lng = p.location?.longitude || null;
        const placeName = p.displayName?.text || p.name || query;

        let mapUrl = p.googleMapsUri || null;
        if (!mapUrl && lat && lng) {
          mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        } else if (!mapUrl) {
          mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(placeName + ' ' + locationJa)}`;
        }

        return {
          name: placeName,
          address: p.formattedAddress || null,
          lat,
          lng,
          rating: p.rating || null,
          place_id: p.name || null,
          url: mapUrl
        };
      } catch (err) {
        console.error('Frontend Places API error:', err);
        return null;
      }
    }

    // ãƒ—ãƒ©ãƒ³ã‚’ãƒªã‚¢ãƒ«ãªPlaces APIãƒ‡ãƒ¼ã‚¿ã§å¼·åŒ–
    async function enrichPlanWithRealPlaces(plan, conditions) {
      if (!GOOGLE_MAPS_API_KEY) {
        console.warn('Places API not available, using fallback data');
        return plan;
      }

      console.log('ğŸ” Enriching plan with real Places API data...');

      // èˆˆå‘³ã«åŸºã¥ã„ãŸã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ”ãƒ³ã‚°
      function getActivityCategory(interests) {
        if (interests.includes('art')) return 'museum';
        if (interests.includes('movie')) return 'movie_theater';
        if (interests.includes('shop')) return 'shopping_mall';
        if (interests.includes('sport')) return 'sporting_goods_store';
        if (interests.includes('music')) return 'night_club';
        if (interests.includes('nature')) return 'park';
        if (interests.includes('photography')) return 'tourist_attraction';
        if (interests.includes('cafe')) return 'cafe';
        if (interests.includes('gourmet')) return 'restaurant';
        return null;
      }

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆç°¡ç•¥ç‰ˆï¼‰
      const budget = conditions.date_budget_level;
      const area = conditions.area;
      const interests = [...conditions.user_interests, ...conditions.partner_interests];
      const uniqueInterests = [...new Set(interests)];

      const lunchKeywords = {
        low: ['ã‚«ãƒ•ã‚§ãƒ©ãƒ³ãƒäººæ°—', 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«å’Œé£ŸãŠã™ã™ã‚', 'ãƒ‘ã‚¹ã‚¿ãƒ©ãƒ³ãƒ'],
        medium: ['ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ©ãƒ³ãƒæœ‰å', 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ©ãƒ³ãƒãŠã™ã™ã‚', 'ãƒ“ã‚¹ãƒˆãƒ­ãƒ©ãƒ³ãƒ'],
        high: ['é«˜ç´šãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ©ãƒ³ãƒ', 'ãƒ•ãƒ¬ãƒ³ãƒãƒ©ãƒ³ãƒæœ‰å', 'å¯¿å¸ãƒ©ãƒ³ãƒé«˜ç´š'],
      };

      const dinnerKeywords = {
        low: ['å±…é…’å±‹ãŠã—ã‚ƒã‚Œäººæ°—', 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°', 'ãƒãƒ«äººæ°—'],
        medium: ['ãŠã—ã‚ƒã‚Œãƒ‡ã‚£ãƒŠãƒ¼ãŠã™ã™ã‚', 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³äººæ°—', 'ãƒ•ãƒ¬ãƒ³ãƒãƒ“ã‚¹ãƒˆãƒ­'],
        high: ['é«˜ç´šãƒ‡ã‚£ãƒŠãƒ¼æœ‰å', 'ãƒ•ãƒ¬ãƒ³ãƒãƒ¬ã‚¹ãƒˆãƒ©ãƒ³é«˜ç´š', 'é«˜ç´šå¯¿å¸'],
      };

      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸¦åˆ—ã§æ›´æ–°
      const updatedSchedule = await Promise.all(plan.schedule.map(async (item) => {
        try {
          let keyword = null;
          let category = null;

          if (item.type === 'lunch') {
            const options = lunchKeywords[budget] || lunchKeywords.medium;
            keyword = options[Math.floor(Math.random() * options.length)];
            category = 'restaurant';
          } else if (item.type === 'dinner') {
            const options = dinnerKeywords[budget] || dinnerKeywords.medium;
            keyword = options[Math.floor(Math.random() * options.length)];
            category = 'restaurant';
          } else if (item.type === 'cafe') {
            keyword = 'ãŠã—ã‚ƒã‚Œã‚«ãƒ•ã‚§äººæ°—';
            category = 'cafe';
          } else if (item.type === 'activity') {
            keyword = 'äººæ°—ã‚¹ãƒãƒƒãƒˆ';
            category = getActivityCategory(uniqueInterests);
          }

          if (!keyword) {
            return item; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ãã®ã¾ã¾
          }

          const placeData = await searchPlacesFromFrontend(keyword, area, { category });

          if (placeData) {
            console.log(`âœ… Updated ${item.type}: ${placeData.name}`);
            return {
              ...item,
              place_name: placeData.name,
              lat: placeData.lat,
              lng: placeData.lng,
              rating: placeData.rating,
              info_url: placeData.url,
              address: placeData.address,
            };
          }
        } catch (err) {
          console.error(`Failed to enrich ${item.type}:`, err);
        }

        return item; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãã®ã¾ã¾
      }));

      return {
        ...plan,
        schedule: updatedSchedule,
      };
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('planForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await generatePlan();
    });

    // ãƒ—ãƒ©ãƒ³èª¿æ•´
    document.getElementById('adjustBtn').addEventListener('click', async () => {
      const adjustment = document.getElementById('adjustmentInput').value;
      if (!adjustment.trim()) {
        alert('èª¿æ•´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      await generatePlan(adjustment);
    });

    async function generatePlan(adjustment = null) {
      const conditions = getFormConditions();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!conditions.user_interests.length) {
        alert('ã‚ãªãŸã®èˆˆå‘³ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');
        return;
      }
      if (!conditions.partner_interests.length) {
        alert('ç›¸æ‰‹ã®èˆˆå‘³ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');
        return;
      }

      // æœ€åˆã®æ¡ä»¶ã‚’ä¿æŒ
      if (!adjustment) {
        lastConditions = conditions;
      }

      const planSection = document.getElementById('planSection');
      const loadingContainer = document.getElementById('loadingContainer');
      const planContainer = document.getElementById('planContainer');
      const errorContainer = document.getElementById('errorContainer');

      planSection.classList.add('active');
      loadingContainer.style.display = 'block';
      planContainer.style.display = 'none';
      errorContainer.innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/api/generate-plan`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conditions: lastConditions || conditions,  // åˆæœŸæ¡ä»¶ã‚’ä½¿ç”¨
            adjustment,
          }),
        });

        const data = await response.json();

        if (!data.success || !data.plan) {
          throw new Error(data.error || 'ãƒ—ãƒ©ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        console.log('ğŸ“¥ Received plan from backend:', data.plan);
        console.log('ğŸ”‘ Google Maps API Key available:', !!GOOGLE_MAPS_API_KEY);

        // Places APIã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ã‚¹ãƒãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ãƒ»æ›´æ–°
        const enrichedPlan = await enrichPlanWithRealPlaces(data.plan, lastConditions || conditions);

        console.log('âœ¨ Enriched plan:', enrichedPlan);
        displayPlan(enrichedPlan);
        document.getElementById('adjustSection').classList.add('active');

        // èª¿æ•´å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('adjustmentInput').value = '';

      } catch (error) {
        console.error('Error:', error);
        errorContainer.innerHTML = `
          <div class="error">
            <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}<br>
            <small>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
          </div>
        `;
      } finally {
        loadingContainer.style.display = 'none';
        planContainer.style.display = 'block';
      }
    }

    function getFormConditions() {
      const userInterests = Array.from(document.querySelectorAll('[id^="interest"]:checked')).map(el => el.value);
      const partnerInterests = Array.from(document.querySelectorAll('[id^="partner"]:checked')).map(el => el.value);

      return {
        user_age_group: document.getElementById('userAge').value,
        user_personality: document.getElementById('userPersonality').value,
        user_interests: userInterests,
        date_budget_level: document.getElementById('budget').value,
        date_phase: document.getElementById('phase').value,
        partner_age_group: document.getElementById('partnerAge').value,
        partner_personality: document.getElementById('partnerPersonality').value,
        partner_interests: partnerInterests,
        area: document.getElementById('area').value,
        date_duration: document.getElementById('duration').value || undefined,
      };
    }

    function displayPlan(plan) {
      // ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
      document.getElementById('planTitle').textContent = plan.plan_summary;
      document.getElementById('totalCost').textContent = plan.total_estimated_cost;

      // ãƒ—ãƒ©ãƒ³å…¨ä½“ã®ç†ç”±
      if (plan.plan_reason) {
        document.getElementById('planReason').textContent = plan.plan_reason;
        document.getElementById('planReasonContainer').style.display = 'block';
      } else {
        document.getElementById('planReasonContainer').style.display = 'none';
      }

      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      const scheduleHTML = plan.schedule.map((item, index) => {
        const link = item.info_url ? ` | <a href="${item.info_url}" target="_blank" rel="noopener" style="color: #667eea; font-weight: 600; text-decoration: none;">ğŸ“ Google Maps</a>` : '';
        const travelInfo = item.travel_time_min ? ` | ğŸš¶ ${item.travel_time_min}åˆ†ï¼ˆ${item.walking_distance_m}mï¼‰` : '';
        const rating = item.rating ? ` | â­ ${item.rating}` : '';

        // ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
        let affiliateLinksHTML = '';
        if (item.affiliateLinks && item.affiliateLinks.length > 0) {
          const buttonsHTML = item.affiliateLinks.map(link => {
            const platformClass = link.platform === 'é£Ÿã¹ãƒ­ã‚°' ? 'tabelog' : 'other';
            return `<a href="${link.url}" target="_blank" rel="nofollow noopener" class="affiliate-btn ${platformClass}" title="${link.searchHint ? 'æ¤œç´¢: ' + link.searchHint : ''}">${link.icon} ${link.displayName}</a>`;
          }).join('');
          const searchHint = item.affiliateLinks[0]?.searchHint ? `<div style="font-size: 0.85em; color: #888; margin-top: 6px;">ğŸ’¡ ã€Œ${item.place_name}ã€ã®æ¤œç´¢çµæœã‚’è¡¨ç¤ºã—ã¾ã™</div>` : '';
          affiliateLinksHTML = `<div class="affiliate-links">${buttonsHTML}${searchHint}</div>`;
        }

        return `
        <div class="schedule-item${index === 0 ? ' active' : ''}">
          <div class="time">${item.time}</div>
          <div class="place-name">${item.place_name}${rating}</div>
          <div class="details">ğŸ“ ${item.area}${item.price_range ? ` | ğŸ’° ${item.price_range}` : ''}${item.duration ? ` | â±ï¸ ${item.duration}` : ''}${travelInfo}${link}</div>
          <div class="reason">ğŸ’¡ ${item.reason}</div>
          ${affiliateLinksHTML}
        </div>
      `}).join('');

      document.getElementById('scheduleContainer').innerHTML = scheduleHTML;

      // èª¿æ•´å¯èƒ½ãªãƒã‚¤ãƒ³ãƒˆ
      if (plan.adjustable_points) {
        const pointsHTML = plan.adjustable_points.map(point => `<span>${point}</span>`).join('');
        document.getElementById('adjustablePointsContainer').innerHTML = pointsHTML;
      }

      // ä¼šè©±ãƒã‚¿
      if (plan.conversation_topics) {
        const topicsHTML = plan.conversation_topics.map(topic => `<li>âœ¨ ${topic}</li>`).join('');
        document.getElementById('conversationTopics').innerHTML = topicsHTML;
      }

      // æ¬¡å›ã¸ã®ã‚»ãƒªãƒ•
      if (plan.next_step_phrase) {
        document.getElementById('nextStepPhrase').textContent = `"${plan.next_step_phrase}"`;
      }

      // åœ°å›³è¡¨ç¤ºï¼ˆGoogle Mapsï¼‰
      const mapEl = document.getElementById('map');
      const routeInfoEl = document.getElementById('routeInfo');

      try {
        if (plan.schedule && plan.schedule.length) {
          if (typeof google === 'undefined' || !google.maps) {
            console.error('Google Maps API not loaded');
            mapEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            // Retry after a delay
            setTimeout(() => displayPlan(plan), 1000);
            return;
          }

          const first = plan.schedule[0];
          console.log('Initializing Google Map with coordinates:', first.lat, first.lng);

          // Google Mapã®åˆæœŸåŒ–
          const mapCenter = { lat: first.lat || 35.6595, lng: first.lng || 139.7004 };
          window._dateAiMap = new google.maps.Map(mapEl, {
            zoom: 14,
            center: mapCenter,
            mapId: 'DEMO_MAP_ID', // Advanced Markersç”¨
          });

          const bounds = new google.maps.LatLngBounds();
          const typeColors = {'lunch': '#ff6b6b', 'dinner': '#ff1744', 'activity': '#667eea', 'cafe': '#ffa500', 'walk': '#4caf50', 'shop': '#e91e63'};
          const typeLabels = {'lunch': 'ãƒ©ãƒ³ãƒ', 'dinner': 'ãƒ‡ã‚£ãƒŠãƒ¼', 'activity': 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£', 'cafe': 'ã‚«ãƒ•ã‚§', 'walk': 'æ•£æ­©', 'shop': 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°'};
          const path = [];
          let totalDist = 0;

          plan.schedule.forEach((item, idx) => {
            if (item.lat && item.lng) {
              const position = { lat: item.lat, lng: item.lng };
              path.push(position);
              bounds.extend(position);

              const color = typeColors[item.type] || '#667eea';

              // ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
              const marker = new google.maps.Marker({
                position,
                map: window._dateAiMap,
                label: {
                  text: String(idx + 1),
                  color: 'white',
                  fontWeight: 'bold',
                },
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 20,
                  fillColor: color,
                  fillOpacity: 1,
                  strokeColor: 'white',
                  strokeWeight: 3,
                },
              });

              // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
              const googleMapsLink = item.info_url || `https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}`;
              const infoContent = `
                <div style="min-width: 200px; padding: 10px;">
                  <strong style="font-size: 16px;">${idx + 1}. ${item.place_name}</strong><br>
                  <span style="color: #666; font-size: 13px;">${typeLabels[item.type] || item.type}</span><br>
                  <span style="color: #667eea; font-weight: bold;">${item.time}</span> | ${item.duration}<br>
                  ${item.rating ? `â­ ${item.rating}<br>` : ''}
                  ${item.travel_time_min ? `ğŸš¶ ç§»å‹•: ${item.travel_time_min}åˆ† (${item.walking_distance_m}m)<br>` : ''}
                  <a href="${googleMapsLink}" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none; font-weight: bold;">ğŸ“ Google Mapsã§é–‹ã</a>
                </div>
              `;

              const infoWindow = new google.maps.InfoWindow({
                content: infoContent,
              });

              marker.addListener('click', () => {
                infoWindow.open(window._dateAiMap, marker);
              });

              if (idx > 0 && item.walking_distance_m) totalDist += item.walking_distance_m;
            }
          });

          // çµŒè·¯ã‚’ç·šã§çµã¶
          if (path.length > 1) {
            new google.maps.Polyline({
              path,
              geodesic: true,
              strokeColor: '#667eea',
              strokeOpacity: 0.7,
              strokeWeight: 4,
              map: window._dateAiMap,
            });

            window._dateAiMap.fitBounds(bounds);
          }

          // åœ°å›³å…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«å…¨ãƒ«ãƒ¼ãƒˆã‚’Google Mapsã§é–‹ã
          const locationsWithCoords = plan.schedule.filter(item => item.lat && item.lng);
          if (locationsWithCoords.length > 0) {
            // Google Maps Directions URLï¼ˆè¤‡æ•°åœ°ç‚¹ã®ãƒ«ãƒ¼ãƒˆï¼‰ã‚’ç”Ÿæˆ
            const origin = locationsWithCoords[0];
            const destination = locationsWithCoords[locationsWithCoords.length - 1];
            const waypoints = locationsWithCoords.slice(1, -1).map(item => `${item.lat},${item.lng}`).join('|');

            let fullRouteUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lng}&destination=${destination.lat},${destination.lng}&travelmode=walking`;
            if (waypoints) {
              fullRouteUrl += `&waypoints=${waypoints}`;
            }

            // åœ°å›³ã®ä¸Šã«ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¿½åŠ 
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: absolute; top: 10px; right: 10px; background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; font-weight: 600; color: #667eea; z-index: 1000; transition: all 0.2s;';
            overlay.innerHTML = 'ğŸ—ºï¸ Google Mapsã§ãƒ«ãƒ¼ãƒˆå…¨ä½“ã‚’è¦‹ã‚‹';
            overlay.onmouseover = () => {
              overlay.style.background = '#667eea';
              overlay.style.color = 'white';
              overlay.style.transform = 'translateY(-2px)';
              overlay.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
            };
            overlay.onmouseout = () => {
              overlay.style.background = 'white';
              overlay.style.color = '#667eea';
              overlay.style.transform = 'translateY(0)';
              overlay.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            };
            overlay.onclick = (e) => {
              e.stopPropagation();
              window.open(fullRouteUrl, '_blank', 'noopener,noreferrer');
            };

            mapEl.style.position = 'relative';
            mapEl.appendChild(overlay);
          }

        // route summary
        const routeSummary = [];
        let cumulative = 0;
        plan.schedule.forEach((item, idx) => {
          if (idx === 0) {
            routeSummary.push(`<li>å‡ºç™º: ${item.place_name}ï¼ˆæ¨å®šç§»å‹• ${item.travel_time_min}åˆ†ï¼‰</li>`);
          } else {
            routeSummary.push(`<li>${item.time}: ${item.place_name} â€” ç§»å‹• ${item.travel_time_min}åˆ† / ${item.walking_distance_m}m</li>`);
            cumulative += item.walking_distance_m || 0;
          }
        });
        routeSummary.push(`<li><strong>åˆè¨ˆæ­©è¡Œè·é›¢:</strong> ${cumulative} mï¼ˆç´„ ${Math.round(cumulative/83.33)} åˆ†ï¼‰</li>`);
        document.getElementById('routeSummary').innerHTML = routeSummary.join('');
        }
      } catch (error) {
        console.error('Map rendering error:', error);
        mapEl.innerHTML = `<div style="padding: 20px; text-align: center; color: #c33;">åœ°å›³ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
