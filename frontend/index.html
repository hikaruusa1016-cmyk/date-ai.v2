<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³è‡ªå‹•ç”Ÿæˆ | Date AI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .form-section h2 {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 25px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    select,
    input[type="text"],
    input[type="radio"],
    textarea {
      cursor: pointer;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.3s;
      resize: vertical;
      min-height: 90px;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radio-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .radio-item:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .radio-item input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    .radio-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .checkbox-item:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-right: 8px;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.05em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .toggle-section {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .toggle-header h3 {
      font-size: 1.1em;
      color: #667eea;
    }

    .toggle-icon {
      font-size: 1.2em;
      color: #667eea;
      transition: transform 0.3s;
    }

    .toggle-icon.expanded {
      transform: rotate(180deg);
    }

    .toggle-content {
      display: none;
      margin-top: 15px;
    }

    .toggle-content.active {
      display: block;
    }

    .quick-adjust {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .quick-adjust button {
      padding: 10px;
      font-size: 0.9em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .plan-section {
      min-height: 400px;
      display: none;
    }

    .plan-section.active {
      display: block;
    }

    .plan-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .plan-summary h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .cost-info {
      font-size: 1.1em;
      opacity: 0.95;
    }

    .schedule {
      margin: 25px 0;
    }

    .schedule h3 {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .schedule-item {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .schedule-item.active {
      background: #f0f4ff;
      border-left-color: #764ba2;
    }

    .time {
      font-size: 1.3em;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .place-name {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .details {
      font-size: 0.9em;
      color: #666;
      margin: 8px 0;
    }

    .reason {
      font-size: 0.9em;
      color: #764ba2;
      font-style: italic;
      margin-top: 8px;
      padding: 8px;
      background: rgba(118, 75, 162, 0.05);
      border-radius: 4px;
    }

    .reason-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .reason-tag {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .photo-grid img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
      background: #eee;
    }

    .review-block {
      margin-top: 12px;
      padding: 10px 12px;
      background: #f7f7fb;
      border-radius: 8px;
      border: 1px solid #e7e8ff;
    }

    .review-title {
      font-weight: 700;
      color: #4b4b70;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .review-item {
      margin-bottom: 8px;
      color: #4b4b4b;
      font-size: 0.9em;
      line-height: 1.4;
    }

    .review-meta {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 3px;
    }

    .review-toggle {
      margin-top: 6px;
      padding: 6px 10px;
      font-size: 0.85em;
      background: #eef1ff;
      color: #4b4b70;
      border: 1px solid #d6daf6;
      border-radius: 6px;
      cursor: pointer;
    }

    .review-toggle:hover {
      background: #e1e5ff;
    }

    .alternative-btn {
      margin-top: 12px;
      padding: 8px 16px;
      background: #fff;
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s;
      width: 100%;
    }

    .alternative-btn:hover {
      background: #667eea;
      color: white;
    }

    .alternative-btn.active {
      background: #667eea;
      color: white;
    }

    .alternatives-container {
      margin-top: 12px;
      padding: 15px;
      background: #f0f4ff;
      border-radius: 6px;
      border: 2px solid #667eea;
    }

    .alternatives-loading {
      text-align: center;
      color: #667eea;
      padding: 20px;
    }

    .alternatives-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alternative-spot {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .alternative-spot:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .alternative-spot-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 6px;
    }

    .alternative-spot-details {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 4px;
    }

    .alternative-spot-reason {
      font-size: 0.85em;
      color: #667eea;
      margin-top: 6px;
    }

    .info-section {
      margin-top: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .info-section h3 {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 10px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .info-list {
      list-style: none;
      margin-left: 0;
    }

    .info-list li {
      padding: 8px 0;
      color: #555;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .next-step {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-size: 1.05em;
      font-weight: 600;
    }

    @media (max-width: 960px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.8em;
      }

      .checkbox-group,
      .quick-adjust {
        grid-template-columns: 1fr;
      }
    }

    /* Map Wrapper & Button */
    .map-wrapper {
      position: relative;
    }

    .google-maps-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      /* Google Maps controls usually have lower z-index or we need to be higher */
      background: white;
      padding: 10px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      text-decoration: none;
      font-weight: bold;
      color: #667eea;
      display: none;
      /* Initially hidden */
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
      transition: background 0.2s;
    }

    .google-maps-btn:hover {
      background: #f8f9fa;
    }
  </style>
  <!-- Google Maps API -->
  <script>
    window.gm_authFailure = function () {
      console.error('Google Maps authentication failed');
    };

    (async function loadGoogleMaps() {
      try {
        const isLocalHost = window.location.hostname === 'localhost';
        const isFileAccess = window.location.protocol === 'file:';
        const API_BASE_URL = (isLocalHost || isFileAccess)
          ? 'http://localhost:3001'
          : window.location.origin;
        const response = await fetch(`${API_BASE_URL}/api/maps-key`);
        const data = await response.json();

        if (data.apiKey) {
          GOOGLE_MAPS_API_KEY = data.apiKey;
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&callback=Function.prototype`;
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
        }
      } catch (error) {
        console.error('Failed to fetch Maps API key:', error);
      }
    })();
  </script>
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸ’˜ ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ AI</h1>
      <p class="subtitle">30ç§’ã§å®Œç’§ãªãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãŒå®Œæˆï¼</p>
    </header>

    <div class="main-content">
      <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-section">
        <h2>ğŸ“ STEP 1: åŸºæœ¬æƒ…å ±ï¼ˆå¿…é ˆï¼‰</h2>
        <form id="planForm">
          <!-- ã‚¨ãƒªã‚¢ -->
          <div class="form-group">
            <label for="area">ãƒ‡ãƒ¼ãƒˆã‚¨ãƒªã‚¢ *</label>
            <select id="area" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="shibuya">æ¸‹è°·</option>
              <option value="shinjuku">æ–°å®¿</option>
              <option value="ginza">éŠ€åº§</option>
              <option value="harajuku">åŸå®¿</option>
              <option value="odaiba">ãŠå°å ´</option>
              <option value="ueno">ä¸Šé‡</option>
              <option value="asakusa">æµ…è‰</option>
              <option value="ikebukuro">æ± è¢‹</option>
            </select>
          </div>

          <!-- ãƒ‡ãƒ¼ãƒˆãƒ•ã‚§ãƒ¼ã‚º -->
          <div class="form-group">
            <label for="phase">ãƒ‡ãƒ¼ãƒˆãƒ•ã‚§ãƒ¼ã‚º *</label>
            <select id="phase" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="first">åˆãƒ‡ãƒ¼ãƒˆ</option>
              <option value="second">2ã€œ3å›ç›®</option>
              <option value="anniversary">è¨˜å¿µæ—¥</option>
              <option value="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
            </select>
          </div>

          <!-- ãƒ‡ãƒ¼ãƒˆæ™‚é–“å¸¯ -->
          <div class="form-group">
            <label for="timeSlot">ãƒ‡ãƒ¼ãƒˆæ™‚é–“å¸¯ *</label>
            <select id="timeSlot" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="lunch">æ˜¼ï¼ˆãƒ©ãƒ³ãƒãƒ¡ã‚¤ãƒ³ï¼‰</option>
              <option value="dinner">å¤œï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ãƒ¡ã‚¤ãƒ³ï¼‰</option>
              <option value="halfday">åŠæ—¥ï¼ˆæ˜¼ã€œå¤•æ–¹ï¼‰</option>
              <option value="fullday">1æ—¥ï¼ˆæœã€œå¤œï¼‰</option>
            </select>
          </div>

          <!-- äºˆç®— -->
          <div class="form-group">
            <label for="budget">äºˆç®—æ„Ÿ *</label>
            <select id="budget" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="low">ä½ï¼ˆ3000-5000å††ï¼‰</option>
              <option value="medium">ä¸­ï¼ˆ7000-10000å††ï¼‰</option>
              <option value="high">é«˜ï¼ˆ15000å††ä»¥ä¸Šï¼‰</option>
            </select>
          </div>

          <button type="submit" id="generateBtn">âœ¨ ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
        </form>

        <!-- STEP2: è©³ç´°è¨­å®šï¼ˆä»»æ„ãƒ»ãƒˆã‚°ãƒ«ï¼‰ -->
        <div class="toggle-section">
          <div class="toggle-header" onclick="toggleStep2()">
            <h3>âš™ï¸ STEP 2: è©³ç´°è¨­å®šï¼ˆä»»æ„ï¼‰</h3>
            <span class="toggle-icon" id="toggleIcon">â–¼</span>
          </div>
          <div class="toggle-content" id="step2Content">
            <!-- ä»Šæ—¥ã®æ°—åˆ† -->
            <div class="form-group" style="margin-top: 15px;">
              <label>ä»Šæ—¥ã®æ°—åˆ†ï¼ˆ1ã¤é¸æŠï¼‰</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" id="moodRelax" name="mood" value="relax">
                  <label for="moodRelax">ã®ã‚“ã³ã‚Šãƒªãƒ©ãƒƒã‚¯ã‚¹</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodActive" name="mood" value="active">
                  <label for="moodActive">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å‹•ããŸã„</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodRomantic" name="mood" value="romantic">
                  <label for="moodRomantic">ãƒ­ãƒãƒ³ãƒãƒƒã‚¯ã«éã”ã—ãŸã„</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moodCasual" name="mood" value="casual">
                  <label for="moodCasual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«æ¥½ã—ã¿ãŸã„</label>
                </div>
              </div>
            </div>

            <!-- NGæ¡ä»¶ -->
            <div class="form-group">
              <label>NGæ¡ä»¶ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="ngOutdoor" value="outdoor">
                  <label for="ngOutdoor">å±‹å¤–ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngIndoor" value="indoor">
                  <label for="ngIndoor">å±‹å†…ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngCrowd" value="crowd">
                  <label for="ngCrowd">æ··é›‘ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngQuiet" value="quiet">
                  <label for="ngQuiet">é™ã‹ã™ãã‚‹å ´æ‰€ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngWalk" value="walk">
                  <label for="ngWalk">é•·è·é›¢ã®ç§»å‹•ã¯é¿ã‘ãŸã„</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="ngRain" value="rain">
                  <label for="ngRain">é›¨ã«å¼±ã„å ´æ‰€ã¯é¿ã‘ãŸã„</label>
                </div>
              </div>
            </div>

            <!-- è‡ªç”±å…¥åŠ› -->
            <div class="form-group">
              <label for="customRequest">è‡ªç”±å…¥åŠ›ï¼ˆè¡ŒããŸã„å ´æ‰€ãƒ»æ™‚é–“å¸¯ãƒ»ã‚„ã‚ŠãŸã„ã“ã¨ï¼‰</label>
              <textarea id="customRequest" placeholder="ä¾‹: 16æ™‚é ƒã«ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ã§å¤•ç„¼ã‘ã‚’è¦‹ãŸã„ / å¤œæ™¯ãŒè¦‹ãˆã‚‹ãƒãƒ¼ã§è»½ãé£²ã¿ãŸã„"></textarea>
              <div style="margin-top: 6px; color: #777; font-size: 0.85em;">
                å…·ä½“çš„ãªå ´æ‰€åã‚„æ™‚é–“å¸¯ã€ãã“ã§ã‚„ã‚ŠãŸã„ã“ã¨ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ—ãƒ©ãƒ³ã«å„ªå…ˆçš„ã«çµ„ã¿è¾¼ã¿ã¾ã™ã€‚
              </div>
            </div>
          </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´ãƒœã‚¿ãƒ³ -->
        <div class="quick-adjust" id="quickAdjust" style="display: none;">
          <button type="button" onclick="quickAdjust('cheaper')">ğŸ’° ã‚‚ã£ã¨å®‰ã</button>
          <button type="button" onclick="quickAdjust('expensive')">âœ¨ ã‚‚ã£ã¨è±ªè¯ã«</button>
          <button type="button" onclick="quickAdjust('indoor')">ğŸ  å±‹å†…ä¸­å¿ƒã«</button>
          <button type="button" onclick="quickAdjust('outdoor')">ğŸŒ³ å±‹å¤–ä¸­å¿ƒã«</button>
          <button type="button" onclick="quickAdjust('shorter')">â±ï¸ çŸ­ã‚ã«</button>
          <button type="button" onclick="quickAdjust('longer')">ğŸ“… é•·ã‚ã«</button>
        </div>
      </div>

      <!-- ãƒ—ãƒ©ãƒ³è¡¨ç¤º -->
      <div class="card plan-section" id="planSection">
        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆä¸­...</p>
        </div>
        <div id="planContainer" style="display: none;">
          <div class="plan-summary">
            <h3 id="planTitle"></h3>
            <div class="cost-info">ğŸ’° äºˆç®—ç›®å®‰: <span id="totalCost"></span></div>
            <div id="planReasonContainer"
              style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 12px;">
              <strong>ğŸ“ ã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸ã‚“ã ç†ç”±</strong>
              <p id="planReason" style="margin-top: 8px; line-height: 1.6;"></p>
            </div>
          </div>

          <div class="schedule">
            <h3>ğŸ“… æœ¬æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
            <div id="scheduleContainer"></div>
          </div>

          <div style="margin-top: 30px;">
            <h3
              style="font-size: 1.3em; color: #333; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
              ğŸ—ºï¸ ãƒ‡ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
            <div class="map-wrapper">
              <div id="map"
                style="height: 400px; border-radius:8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              </div>
              <a id="googleMapsLink" href="#" target="_blank" rel="noopener" class="google-maps-btn">
                ğŸ“ Google Mapsã§é–‹ã
              </a>
            </div>
          </div>

          <div class="info-section">
            <h3>ğŸ’¬ ä¼šè©±ãƒã‚¿ï¼ˆ3ã¤ï¼‰</h3>
            <ul class="info-list" id="conversationTopics"></ul>
          </div>

          <div class="next-step" id="nextStepPhrase"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const isLocalhost = window.location.hostname === 'localhost';
    const isFileAccess = window.location.protocol === 'file:';
    const API_BASE = (isLocalhost || isFileAccess)
      ? 'http://localhost:3001'
      : window.location.origin;
    let lastConditions = null;
    let GOOGLE_MAPS_API_KEY = null;

    // STEP2ãƒˆã‚°ãƒ«
    function toggleStep2() {
      const content = document.getElementById('step2Content');
      const icon = document.getElementById('toggleIcon');
      content.classList.toggle('active');
      icon.classList.toggle('expanded');
    }

    function escapeHtml(str = '') {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderReviewItem(review, idx, placeKey) {
      const author = review.author || 'åŒ¿å';
      const rating = review.rating ? ` | â­ ${review.rating}` : '';
      const text = review.text || '';
      const maxLen = 120;
      const needsToggle = text.length > maxLen;
      const shortText = needsToggle ? `${text.slice(0, maxLen)}â€¦` : text;
      const targetId = `review-${placeKey}-${idx}`;

      return `
        <div class="review-item">
          <div class="review-meta">${escapeHtml(author)}${rating}</div>
          <div class="review-text" id="${targetId}">${escapeHtml(shortText)}</div>
          ${needsToggle ? `
            <button class="review-toggle"
              data-target="${targetId}"
              data-full="${escapeHtml(text)}"
              data-short="${escapeHtml(shortText)}"
              data-expanded="false"
              onclick="toggleReviewText(this)">å…¨æ–‡è¡¨ç¤º</button>
          ` : ''}
        </div>
      `;
    }

    function toggleReviewText(button) {
      const targetId = button.getAttribute('data-target');
      const target = document.getElementById(targetId);
      if (!target) return;

      const expanded = button.getAttribute('data-expanded') === 'true';
      if (expanded) {
        target.innerHTML = button.getAttribute('data-short') || '';
        button.textContent = 'å…¨æ–‡è¡¨ç¤º';
        button.setAttribute('data-expanded', 'false');
      } else {
        target.innerHTML = button.getAttribute('data-full') || '';
        button.textContent = 'çŸ­ãè¡¨ç¤º';
        button.setAttribute('data-expanded', 'true');
      }
    }

    // ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´
    async function quickAdjust(type) {
      const adjustments = {
        'cheaper': 'ã‚‚ã£ã¨å®‰ãã—ãŸã„',
        'expensive': 'ã‚‚ã£ã¨è±ªè¯ã«ã—ãŸã„',
        'indoor': 'å±‹å†…ä¸­å¿ƒã«ã—ãŸã„',
        'outdoor': 'å±‹å¤–ä¸­å¿ƒã«ã—ãŸã„',
        'shorter': 'ã‚‚ã£ã¨çŸ­ã‚ã«ã—ãŸã„',
        'longer': 'ã‚‚ã£ã¨é•·ã‚ã«ã—ãŸã„'
      };
      await generatePlan(adjustments[type]);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('planForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await generatePlan();
    });

    async function generatePlan(adjustment = null) {
      const conditions = getFormConditions();

      // èª¿æ•´æ™‚ã‚‚æœ€æ–°ã®conditionsã‚’ä½¿ç”¨ï¼ˆSTEP2ã®å€¤ã‚’å«ã‚€ï¼‰
      if (!adjustment) {
        lastConditions = conditions;
      } else {
        // èª¿æ•´æ™‚ã¯lastConditionsã‚’æœ€æ–°ã®conditionsã§æ›´æ–°
        lastConditions = conditions;
      }

      // æ¡ä»¶ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä»£æ›¿ã‚¹ãƒãƒƒãƒˆæ©Ÿèƒ½ã§ä½¿ç”¨ï¼‰
      window._currentConditions = conditions;

      const planSection = document.getElementById('planSection');
      const loadingContainer = document.getElementById('loadingContainer');
      const planContainer = document.getElementById('planContainer');
      const errorContainer = document.getElementById('errorContainer');
      const quickAdjust = document.getElementById('quickAdjust');

      planSection.classList.add('active');
      loadingContainer.style.display = 'block';
      planContainer.style.display = 'none';
      errorContainer.innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/api/generate-plan`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conditions: conditions,
            adjustment,
          }),
        });

        const data = await response.json();

        if (!data.success || !data.plan) {
          throw new Error(data.error || 'ãƒ—ãƒ©ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        console.log('ğŸ“¥ Received plan:', data.plan);
        displayPlan(data.plan);
        quickAdjust.style.display = 'grid';

      } catch (error) {
        console.error('Error:', error);
        errorContainer.innerHTML = `
          <div class="error">
            <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}<br>
            <small>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
          </div>
        `;
      } finally {
        loadingContainer.style.display = 'none';
        planContainer.style.display = 'block';
      }
    }

    function getFormConditions() {
      const mood = document.querySelector('input[name="mood"]:checked');
      const ngConditions = Array.from(document.querySelectorAll('[id^="ng"]:checked')).map(el => el.value);

      return {
        area: document.getElementById('area').value,
        date_phase: document.getElementById('phase').value,
        time_slot: document.getElementById('timeSlot').value,
        date_budget_level: document.getElementById('budget').value,
        mood: mood ? mood.value : null,
        ng_conditions: ngConditions,
        custom_request: document.getElementById('customRequest').value.trim() || null,
      };
    }

    function displayPlan(plan) {
      // ãƒ—ãƒ©ãƒ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä»£æ›¿ã‚¹ãƒãƒƒãƒˆæ©Ÿèƒ½ã§ä½¿ç”¨ï¼‰
      window._currentPlan = plan;

      document.getElementById('planTitle').textContent = plan.plan_summary;
      document.getElementById('totalCost').textContent = plan.total_estimated_cost;

      if (plan.plan_reason) {
        document.getElementById('planReason').textContent = plan.plan_reason;
        document.getElementById('planReasonContainer').style.display = 'block';
      } else {
        document.getElementById('planReasonContainer').style.display = 'none';
      }

      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      const scheduleHTML = plan.schedule.map((item, index) => {
        if (item.is_meeting) {
          return `
          <div class="schedule-item${index === 0 ? ' active' : ''}">
            <div class="time">ğŸš© ${item.time}</div>
            <div class="place-name" style="font-weight: bold; color: #667eea;">é›†åˆ: ${item.place_name}</div>
            <div class="reason">ğŸ’¡ ${item.reason}</div>
          </div>`;
        }

        if (item.is_travel) {
          const modeIcon = item.transport_mode === 'train'
            ? 'ğŸš‡'
            : item.transport_mode === 'bus'
              ? 'ğŸšŒ'
              : item.transport_mode === 'taxi'
                ? 'ğŸš•'
                : 'ğŸš¶';
          return `
          <div class="schedule-item" style="background: #f5f5f5; border-left: 4px solid #ffa500;">
            <div class="time">${modeIcon} ${item.time}</div>
            <div class="place-name" style="color: #666;">ç§»å‹•ä¸­ï¼ˆ${item.transport_label || 'ç§»å‹•'}${item.duration ? ` | ${item.duration}` : ''}ï¼‰</div>
            <div class="details" style="color: #888;">ğŸ“ ç´„${item.walking_distance_m}m</div>
            ${item.reason ? `<div class="reason">ğŸ’¡ ${item.reason}</div>` : ''}
          </div>`;
        }

        if (item.is_farewell) {
          return `
          <div class="schedule-item" style="border-left: 4px solid #764ba2;">
            <div class="time">ğŸ‘‹ ${item.time}</div>
            <div class="place-name" style="font-weight: bold; color: #764ba2;">è§£æ•£: ${item.place_name}</div>
            <div class="reason">ğŸ’¡ ${item.reason}</div>
          </div>`;
        }

        const link = item.info_url ? ` | <a href="${item.info_url}" target="_blank" rel="noopener" style="color: #667eea; font-weight: 600; text-decoration: none;">ğŸ“ Google Maps</a>` : '';
        const officialLink = item.official_url ? ` | <a href="${item.official_url}" target="_blank" rel="noopener" style="color: #ff6b6b; font-weight: 600; text-decoration: none;">ğŸ  å…¬å¼HP</a>` : '';
        const rating = item.rating ? ` | â­ ${item.rating}` : '';
        const endTime = item.end_time ? ` ã€œ ${item.end_time}` : '';

        // é¸å®šç†ç”±ã‚¿ã‚°
        const reasonTags = item.reason_tags ? `
          <div class="reason-tags">
            ${item.reason_tags.map(tag => `<span class="reason-tag">${tag}</span>`).join('')}
          </div>
        ` : '';

        const photosHTML = item.photos && item.photos.length
          ? `
            <div class="photo-grid">
              ${item.photos.slice(0, 3).map(src => `<img src="${src}" alt="${item.place_name}ã®å†™çœŸ">`).join('')}
            </div>
          `
          : '';

        const reviewsHTML = item.reviews && item.reviews.length
          ? `
            <div class="review-block">
              <div class="review-title">å£ã‚³ãƒŸ</div>
              ${item.reviews.slice(0, 2).map((r, idx) => renderReviewItem(r, idx, `${index}`)).join('')}
            </div>
          `
          : '';

        return `
        <div class="schedule-item" data-spot-index="${index}">
          <div class="time">${item.time}${endTime}</div>
          <div class="place-name">${item.place_name}${rating}</div>
          <div class="details">ğŸ“ ${item.area}${item.price_range ? ` | ğŸ’° ${item.price_range}` : ''}${item.duration ? ` | â±ï¸ ${item.duration}` : ''}${link}${officialLink}</div>
          <div class="reason">ğŸ’¡ ${item.reason}</div>
          ${reasonTags}
          ${photosHTML}
          ${reviewsHTML}
          <button class="alternative-btn" onclick="toggleAlternatives(${index})" data-spot-index="${index}">
            ğŸ”„ åˆ¥ã®å ´æ‰€ã‚’æ¢ã™
          </button>
          <div class="alternatives-container" id="alternatives-${index}" style="display: none;">
            <div class="alternatives-loading">ä»£æ›¿ã‚¹ãƒãƒƒãƒˆã‚’æ¤œç´¢ä¸­...</div>
          </div>
        </div>
      `}).join('');

      document.getElementById('scheduleContainer').innerHTML = scheduleHTML;

      // ä¼šè©±ãƒã‚¿
      if (plan.conversation_topics) {
        const topicsHTML = plan.conversation_topics.map(topic => `<li>âœ¨ ${topic}</li>`).join('');
        document.getElementById('conversationTopics').innerHTML = topicsHTML;
      }

      // æ¬¡å›ã¸ã®ã‚»ãƒªãƒ•
      if (plan.next_step_phrase) {
        document.getElementById('nextStepPhrase').textContent = `"${plan.next_step_phrase}"`;
      }

      // åœ°å›³è¡¨ç¤º
      renderMap(plan);
    }

    function renderMap(plan) {
      const mapEl = document.getElementById('map');

      try {
        if (!plan.schedule || plan.schedule.length === 0) return;

        if (typeof google === 'undefined' || !google.maps) {
          mapEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
          setTimeout(() => renderMap(plan), 1000);
          return;
        }

        const firstSpot = plan.schedule.find(item => item.lat && item.lng);
        if (!firstSpot) return;

        const mapCenter = { lat: firstSpot.lat, lng: firstSpot.lng };
        window._dateAiMap = new google.maps.Map(mapEl, {
          zoom: 14,
          center: mapCenter,
          mapId: 'DEMO_MAP_ID',
        });

        const bounds = new google.maps.LatLngBounds();
        const path = [];

        plan.schedule.forEach((item, idx) => {
          if (item.lat && item.lng && !item.is_travel) {
            const position = { lat: item.lat, lng: item.lng };
            path.push(position);
            bounds.extend(position);

            const marker = new google.maps.Marker({
              position,
              map: window._dateAiMap,
              label: {
                text: String(path.length),
                color: 'white',
                fontWeight: 'bold',
              },
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 20,
                fillColor: '#667eea',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 3,
              },
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `
                <div style="padding: 10px;">
                  <strong>${path.length}. ${item.place_name}</strong><br>
                  <span style="color: #667eea;">${item.time}</span> | ${item.duration}<br>
                  ${item.rating ? `â­ ${item.rating}<br>` : ''}
                </div>
              `,
            });

            marker.addListener('click', () => {
              infoWindow.open(window._dateAiMap, marker);
            });
          }
        });

        if (path.length > 1) {
          new google.maps.Polyline({
            path,
            geodesic: true,
            strokeColor: '#667eea',
            strokeOpacity: 0.7,
            strokeWeight: 4,
            map: window._dateAiMap,
          });
          window._dateAiMap.fitBounds(bounds);

          // Google Maps URLç”Ÿæˆ
          const origin = `${path[0].lat},${path[0].lng}`;
          const destination = `${path[path.length - 1].lat},${path[path.length - 1].lng}`;
          let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;

          if (path.length > 2) {
            const waypoints = path.slice(1, -1).map(p => `${p.lat},${p.lng}`).join('|');
            url += `&waypoints=${waypoints}`;
          }
          url += '&travelmode=walking';

          const btn = document.getElementById('googleMapsLink');
          if (btn) {
            btn.href = url;
            btn.style.display = 'flex';
          }
        } else {
          // ã‚¹ãƒãƒƒãƒˆãŒ1ã¤ä»¥ä¸‹ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆã‚ã‚‹ã„ã¯å˜ä¸€ã‚¹ãƒãƒƒãƒˆã¸ã®ãƒªãƒ³ã‚¯ã«ã™ã‚‹ãªã©ï¼‰
          const btn = document.getElementById('googleMapsLink');
          if (btn) btn.style.display = 'none';
        }
      } catch (error) {
        console.error('Map rendering error:', error);
        mapEl.innerHTML = `<div style="padding: 20px; text-align: center; color: #c33;">åœ°å›³ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
      }
    }

    // ã‚¹ãƒãƒƒãƒˆä»£æ›¿æ©Ÿèƒ½
    let currentAlternatives = {}; // { spotIndex: [alternatives] }

    // è·é›¢è¨ˆç®—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = (deg) => deg * Math.PI / 180;
      const R = 6371000; // meters
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function estimateWalkingMinutes(distanceMeters) {
      const walkingSpeedMPerMin = 5000 / 60; // ~83.33 m/min
      return Math.max(1, Math.round(distanceMeters / walkingSpeedMPerMin));
    }

    // ç§»å‹•æ™‚é–“ã‚’å†è¨ˆç®—
    function recalculateTravelTimes(plan) {
      const schedule = plan.schedule;

      for (let i = 0; i < schedule.length; i++) {
        const item = schedule[i];

        // ç§»å‹•é …ç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (item.is_travel || item.is_meeting || item.is_farewell) continue;

        // å‰ã®ã‚¹ãƒãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹
        let prevSpot = null;
        for (let j = i - 1; j >= 0; j--) {
          if (!schedule[j].is_travel && schedule[j].lat && schedule[j].lng) {
            prevSpot = schedule[j];
            break;
          }
        }

        // æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹
        let nextSpot = null;
        for (let j = i + 1; j < schedule.length; j++) {
          if (!schedule[j].is_travel && schedule[j].lat && schedule[j].lng) {
            nextSpot = schedule[j];
            break;
          }
        }

        // å‰ã®ã‚¹ãƒãƒƒãƒˆã‹ã‚‰ã®è·é›¢ã¨æ™‚é–“ã‚’è¨ˆç®—
        if (prevSpot && item.lat && item.lng) {
          const dist = Math.round(haversineDistance(prevSpot.lat, prevSpot.lng, item.lat, item.lng));
          const travelMin = estimateWalkingMinutes(dist);

          // å‰ã®ç§»å‹•é …ç›®ã‚’æ›´æ–°ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
          if (i > 0 && schedule[i - 1].is_travel) {
            schedule[i - 1].walking_distance_m = dist;
            schedule[i - 1].duration = `${travelMin}min`;
            schedule[i - 1].reason = `å¾’æ­©ã§æ¬¡ã®ç›®çš„åœ°ã¸ç§»å‹•ï¼ˆç´„${travelMin}åˆ†ï¼‰`;
          }
        }

        // æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸ã®ç§»å‹•é …ç›®ã‚’æ›´æ–°ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
        if (nextSpot && item.lat && item.lng && i < schedule.length - 1 && schedule[i + 1].is_travel) {
          const dist = Math.round(haversineDistance(item.lat, item.lng, nextSpot.lat, nextSpot.lng));
          const travelMin = estimateWalkingMinutes(dist);
          schedule[i + 1].walking_distance_m = dist;
          schedule[i + 1].duration = `${travelMin}min`;
          schedule[i + 1].reason = `å¾’æ­©ã§æ¬¡ã®ç›®çš„åœ°ã¸ç§»å‹•ï¼ˆç´„${travelMin}åˆ†ï¼‰`;
        }
      }

      return plan;
    }

    async function toggleAlternatives(spotIndex) {
      const container = document.getElementById(`alternatives-${spotIndex}`);
      const btn = document.querySelector(`button[data-spot-index="${spotIndex}"]`);

      if (!container || !btn) return;

      // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
      if (container.style.display !== 'none') {
        container.style.display = 'none';
        btn.classList.remove('active');
        return;
      }

      // é–‹ã
      container.style.display = 'block';
      btn.classList.add('active');

      // æ—¢ã«å–å¾—æ¸ˆã¿ã®å ´åˆã¯å†åˆ©ç”¨
      if (currentAlternatives[spotIndex]) {
        displayAlternatives(spotIndex, currentAlternatives[spotIndex]);
        return;
      }

      // ä»£æ›¿ã‚¹ãƒãƒƒãƒˆã‚’å–å¾—
      try {
        const currentSpot = window._currentPlan.schedule[spotIndex];
        const conditions = window._currentConditions;

        if (!currentSpot || currentSpot.is_travel || currentSpot.is_meeting || currentSpot.is_farewell) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ã“ã®ã‚¹ãƒãƒƒãƒˆã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>';
          return;
        }

        // é™¤å¤–ã‚¹ãƒãƒƒãƒˆã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const excludeSpots = window._currentPlan.schedule
          .filter(item => !item.is_travel && !item.is_meeting && !item.is_farewell && item.place_name)
          .map(item => item.place_name);

        const response = await fetch('http://localhost:3001/api/get-alternative-spots', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            category: currentSpot.category,
            area: conditions.area,
            budget: conditions.date_budget_level,
            datePhase: conditions.date_phase,
            timeSlot: conditions.time_slot,
            mood: conditions.mood,
            ngConditions: conditions.ng_conditions || [],
            excludeSpots,
            limit: 5
          })
        });

        const data = await response.json();

        if (!data.success || !data.alternatives || data.alternatives.length === 0) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ä»£æ›¿ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
          return;
        }

        currentAlternatives[spotIndex] = data.alternatives;
        displayAlternatives(spotIndex, data.alternatives);

      } catch (error) {
        console.error('Error fetching alternatives:', error);
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #c33;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }

    function displayAlternatives(spotIndex, alternatives) {
      const container = document.getElementById(`alternatives-${spotIndex}`);
      if (!container) return;

      const alternativesHTML = `
        <div class="alternatives-list">
          ${alternatives.map((alt, idx) => `
            <div class="alternative-spot" onclick="replaceSpot(${spotIndex}, ${idx})">
              <div class="alternative-spot-name">${alt.place_name}${alt.rating ? ` â­ ${alt.rating}` : ''}</div>
              <div class="alternative-spot-details">
                ğŸ“ ${alt.area} | ğŸ’° ${alt.price_range || 'æœªè¨­å®š'} | â±ï¸ ${alt.duration || 'æœªè¨­å®š'}
              </div>
              <div class="alternative-spot-reason">ğŸ’¡ ${alt.reason || 'ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆã§ã™'}</div>
              ${alt.reason_tags ? `
                <div class="reason-tags" style="margin-top: 8px;">
                  ${alt.reason_tags.map(tag => `<span class="reason-tag">${tag}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `;

      container.innerHTML = alternativesHTML;
    }

    function replaceSpot(spotIndex, alternativeIndex) {
      const alternative = currentAlternatives[spotIndex][alternativeIndex];
      if (!alternative) return;

      // ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°
      const oldSpot = window._currentPlan.schedule[spotIndex];
      window._currentPlan.schedule[spotIndex] = {
        ...oldSpot,
        ...alternative,
        time: oldSpot.time, // æ™‚é–“ã¯ç¶­æŒ
        end_time: oldSpot.end_time
      };

      // ç§»å‹•æ™‚é–“ã‚’å†è¨ˆç®—
      recalculateTravelTimes(window._currentPlan);

      // è¡¨ç¤ºã‚’æ›´æ–°
      displayPlan(window._currentPlan);

      // åœ°å›³ã‚’æ›´æ–°
      renderMap(window._currentPlan);

      // ä»£æ›¿ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      delete currentAlternatives[spotIndex];

      console.log(`ğŸ”„ Replaced spot at index ${spotIndex} with ${alternative.place_name}`);
    }
  </script>
</body>

</html>