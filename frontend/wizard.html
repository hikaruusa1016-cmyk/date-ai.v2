<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³è‡ªå‹•ç”Ÿæˆ | Date AI</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wizard-container {
      max-width: 600px;
      width: 100%;
    }

    /* Progress Indicator */
    .progress-container {
      margin-bottom: 30px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: white;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .progress-text {
      color: white;
      text-align: center;
      margin-top: 10px;
      font-size: 0.9em;
      opacity: 0.9;
    }

    /* Card */
    .card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      min-height: 500px;
      display: flex;
      flex-direction: column;
    }

    /* Step Content */
    .step {
      display: none;
      flex-direction: column;
      flex: 1;
    }

    .step.active {
      display: flex;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .step-content {
      flex: 1;
    }

    .step-title {
      font-size: 1.8em;
      color: #333;
      margin-bottom: 15px;
      font-weight: 700;
      line-height: 1.3;
    }

    .step-subtitle {
      font-size: 1em;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    /* Introduction Screen */
    .intro-content {
      text-align: center;
    }

    .intro-title {
      font-size: 2.2em;
      color: #333;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .intro-subtitle {
      font-size: 1.1em;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.7;
    }

    .intro-features {
      background: #f8f9ff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      text-align: left;
    }

    .feature-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      font-size: 1em;
      color: #555;
    }

    .feature-item:last-child {
      margin-bottom: 0;
    }

    .feature-icon {
      font-size: 1.5em;
      margin-right: 12px;
    }

    .time-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.95em;
      font-weight: 600;
      margin-bottom: 30px;
    }

    /* Selection Options */
    .options-grid {
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
    }

    .option-card {
      background: #f8f9ff;
      border: 3px solid #e0e4ff;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .option-card:hover {
      border-color: #667eea;
      background: #f0f4ff;
      transform: translateY(-2px);
    }

    .option-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .option-card.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 15px;
      right: 15px;
      width: 28px;
      height: 28px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
    }

    .option-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .option-description {
      font-size: 0.9em;
      color: #666;
      line-height: 1.5;
    }

    .option-icon {
      font-size: 1.8em;
      margin-bottom: 10px;
      display: block;
    }

    /* Chip Selection */
    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .chip {
      background: #f8f9ff;
      border: 2px solid #e0e4ff;
      border-radius: 25px;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1em;
      font-weight: 500;
      color: #333;
    }

    .chip:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .chip.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .chip.multi-select.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* Search Input */
    .search-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e4ff;
      border-radius: 10px;
      font-size: 1em;
      font-family: inherit;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-suggestions {
      display: none;
      background: white;
      border: 2px solid #e0e4ff;
      border-radius: 10px;
      margin-top: -10px;
      margin-bottom: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .search-suggestions.active {
      display: block;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover {
      background: #f8f9ff;
    }

    /* Region Tabs */
    .region-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 5px;
      scrollbar-width: thin;
    }

    .region-tab {
      padding: 10px 20px;
      background: #f8f9ff;
      border: 2px solid #e0e4ff;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .region-tab:hover {
      border-color: #667eea;
      background: #f0f4ff;
      transform: translateY(-1px);
    }

    .region-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .location-category {
      margin-bottom: 25px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .category-title {
      font-size: 1em;
      font-weight: 700;
      color: #333;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-left: 4px solid #667eea;
      border-radius: 6px;
    }

    /* é¸æŠã•ã‚ŒãŸåœ°åŸŸã®è¡¨ç¤º */
    .selected-location-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 25px;
      font-weight: 600;
      margin-bottom: 15px;
      animation: bounceIn 0.4s ease;
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .selected-location-badge .icon {
      font-size: 1.2em;
    }

    .selected-location-badge .close-btn {
      cursor: pointer;
      font-size: 1.2em;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .selected-location-badge .close-btn:hover {
      opacity: 1;
    }

    /* ä½ç½®æƒ…å ±ãƒœã‚¿ãƒ³ */
    .location-detect-btn {
      width: 100%;
      padding: 15px;
      background: #f8f9ff;
      border: 2px dashed #667eea;
      border-radius: 10px;
      color: #667eea;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .location-detect-btn:hover {
      background: #667eea;
      color: white;
      border-style: solid;
    }

    .location-detect-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* å±¥æ­´ã‚¨ãƒªã‚¢ */
    .history-section {
      margin-bottom: 20px;
    }

    .history-title {
      font-size: 0.85em;
      font-weight: 600;
      color: #888;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .history-chip {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #e0e4ff;
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-chip:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-1px);
    }

    .history-chip .time {
      font-size: 0.75em;
      opacity: 0.6;
    }

    /* Confirmation Screen */
    .confirmation-list {
      background: #f8f9ff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .confirmation-item {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e4ff;
    }

    .confirmation-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .confirmation-label {
      font-size: 0.85em;
      color: #888;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .confirmation-value {
      font-size: 1.1em;
      color: #333;
      font-weight: 600;
    }

    /* Buttons */
    .button-container {
      display: flex;
      gap: 12px;
      margin-top: auto;
      padding-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 10px;
      font-size: 1.05em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover {
      background: #f8f9ff;
    }

    .btn-full {
      width: 100%;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      font-size: 1.1em;
      color: #666;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .card {
        padding: 30px 25px;
      }

      .step-title {
        font-size: 1.5em;
      }

      .intro-title {
        font-size: 1.8em;
      }
    }
  </style>
</head>

<body>
  <div class="wizard-container">
    <!-- Progress Indicator -->
    <div class="progress-container" id="progressContainer" style="display: none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">1 / 6</div>
    </div>

    <div class="card">
      <!-- STEP 0: Introduction -->
      <div class="step active" id="step0">
        <div class="step-content intro-content">
          <h1 class="intro-title">ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã‚’<br>è‡ªå‹•ã§ä½œæˆã—ã¾ã™</h1>
          <p class="intro-subtitle">
            ã„ãã¤ã‹ã®è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§<br>
            AIãŒã‚ãªãŸã«ã´ã£ãŸã‚Šã®ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¾ã™
          </p>
          <div class="time-badge">â±ï¸ æ‰€è¦æ™‚é–“ï¼šç´„30ã€œ60ç§’</div>
          <div class="intro-features">
            <div class="feature-item">
              <span class="feature-icon">âœ¨</span>
              <span>è€ƒãˆã™ããšã€ç›´æ„Ÿã§é¸ã¶ã ã‘</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ğŸ¯</span>
              <span>é–¢ä¿‚æ€§ã«åˆã‚ã›ãŸæœ€é©ãªãƒ—ãƒ©ãƒ³</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ğŸ—ºï¸</span>
              <span>ç§»å‹•æ™‚é–“ã‚‚è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªãƒ«ãƒ¼ãƒˆ</span>
            </div>
          </div>
        </div>
        <div class="button-container">
          <button class="btn btn-primary btn-full" onclick="nextStep()">ãƒ—ãƒ©ãƒ³ä½œæˆã‚’å§‹ã‚ã‚‹</button>
        </div>
      </div>

      <!-- STEP 1: Start Location -->
      <div class="step" id="step1">
        <div class="step-content">
          <h2 class="step-title">ã©ã“ã‹ã‚‰ãƒ‡ãƒ¼ãƒˆã‚’<br>å§‹ã‚ã¾ã™ã‹ï¼Ÿ</h2>
          <p class="step-subtitle">å‡ºç™ºåœ°ç‚¹ã‚„ã‚ˆãè¡Œãã‚¨ãƒªã‚¢ã‚’é¸ã‚“ã§ãã ã•ã„</p>

          <!-- é¸æŠã•ã‚ŒãŸåœ°åŸŸã®è¡¨ç¤º -->
          <div id="selectedLocationDisplay"></div>

          <!-- ä½ç½®æƒ…å ±å–å¾—ãƒœã‚¿ãƒ³ -->
          <button class="location-detect-btn" id="detectLocationBtn" onclick="detectCurrentLocation()">
            <span>ğŸ“</span>
            <span>ç¾åœ¨åœ°ã‹ã‚‰è¿‘ãã®ã‚¨ãƒªã‚¢ã‚’æ¢ã™</span>
          </button>

          <!-- æ¤œç´¢çª“ -->
          <input type="text" class="search-input" id="locationSearch" placeholder="é§…åãƒ»ã‚¨ãƒªã‚¢åã§æ¤œç´¢ï¼ˆä¾‹ï¼šæ¸‹è°·ã€æ–°å®¿ï¼‰"
            oninput="handleLocationSearch(event)"
            onfocus="showSearchHistory()">

          <!-- ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º -->
          <div class="search-suggestions" id="locationSuggestions"></div>

          <!-- å±¥æ­´è¡¨ç¤º -->
          <div class="history-section" id="historySection" style="display: none;">
            <div class="history-title">
              <span>ğŸ•’</span>
              <span>æœ€è¿‘é¸ã‚“ã ã‚¨ãƒªã‚¢</span>
            </div>
            <div class="history-chips" id="historyChips"></div>
          </div>

          <!-- Region Tabs -->
          <div class="region-tabs" id="regionTabs"></div>

          <!-- Location Chips Container -->
          <div id="locationChipsContainer"></div>
        </div>
        <div class="button-container">
          <button class="btn btn-secondary" onclick="prevStep()">æˆ»ã‚‹</button>
          <button class="btn btn-primary" id="step1Next" onclick="nextStep()" disabled>æ¬¡ã¸</button>
        </div>
      </div>

      <!-- STEP 2: Date Phase -->
      <div class="step" id="step2">
        <div class="step-content">
          <h2 class="step-title">ä»Šå›ã®ãƒ‡ãƒ¼ãƒˆã¯<br>ã©ã‚“ãªé–¢ä¿‚ã§ã™ã‹ï¼Ÿ</h2>
          <p class="step-subtitle">é–¢ä¿‚æ€§ã«åˆã‚ã›ã¦æœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¾ã™</p>

          <div class="options-grid">
            <div class="option-card" onclick="selectDatePhase('first')">
              <span class="option-icon">ğŸ’«</span>
              <div class="option-title">åˆãƒ‡ãƒ¼ãƒˆ</div>
              <div class="option-description">ã¾ã è·é›¢ã‚’ç¸®ã‚ãŸã„æ®µéš</div>
            </div>
            <div class="option-card" onclick="selectDatePhase('second')">
              <span class="option-icon">ğŸŒ¸</span>
              <div class="option-title">2ã€œ3å›ç›®</div>
              <div class="option-description">å°‘ã—æ‰“ã¡è§£ã‘ã¦ããŸé–¢ä¿‚</div>
            </div>
            <div class="option-card" onclick="selectDatePhase('casual')">
              <span class="option-icon">â¤ï¸</span>
              <div class="option-title">ä»˜ãåˆã£ã¦ã„ã‚‹</div>
              <div class="option-description">ã„ã¤ã‚‚ã®ãƒ‡ãƒ¼ãƒˆ</div>
            </div>
            <div class="option-card" onclick="selectDatePhase('anniversary')">
              <span class="option-icon">ğŸ‰</span>
              <div class="option-title">è¨˜å¿µæ—¥ãƒ»ç‰¹åˆ¥ãªæ—¥</div>
              <div class="option-description">èª•ç”Ÿæ—¥ã‚„è¨˜å¿µæ—¥ãªã©</div>
            </div>
          </div>
        </div>
        <div class="button-container">
          <button class="btn btn-secondary" onclick="prevStep()">æˆ»ã‚‹</button>
          <button class="btn btn-primary" id="step2Next" onclick="nextStep()" disabled>æ¬¡ã¸</button>
        </div>
      </div>

      <!-- STEP 3: Time Slot -->
      <div class="step" id="step3">
        <div class="step-content">
          <h2 class="step-title">ã„ã¤é ƒã®<br>ãƒ‡ãƒ¼ãƒˆã§ã™ã‹ï¼Ÿ</h2>
          <p class="step-subtitle">æ™‚é–“å¸¯ã«åˆã‚ã›ãŸã‚¹ãƒãƒƒãƒˆã‚’ææ¡ˆã—ã¾ã™</p>

          <div class="chips-container">
            <div class="chip" onclick="selectTimeSlot('lunch')">â˜€ï¸ æ˜¼</div>
            <div class="chip" onclick="selectTimeSlot('evening')">ğŸŒ™ å¤œ</div>
            <div class="chip" onclick="selectTimeSlot('half_day')">ğŸŒ… åŠæ—¥</div>
            <div class="chip" onclick="selectTimeSlot('undecided')">â“ æœªå®šï¼ˆãŠã™ã™ã‚ï¼‰</div>
          </div>
        </div>
        <div class="button-container">
          <button class="btn btn-secondary" onclick="prevStep()">æˆ»ã‚‹</button>
          <button class="btn btn-primary" id="step3Next" onclick="nextStep()" disabled>æ¬¡ã¸</button>
        </div>
      </div>

      <!-- STEP 4: Budget Level -->
      <div class="step" id="step4">
        <div class="step-content">
          <h2 class="step-title">ã ã„ãŸã„ã©ã‚Œãã‚‰ã„ã®<br>äºˆç®—ã§ã™ã‹ï¼Ÿ</h2>
          <p class="step-subtitle">ã‚ãã¾ã§ç›®å®‰ã§ã™ã€‚æ°—è»½ã«é¸ã‚“ã§ãã ã•ã„</p>

          <div class="options-grid">
            <div class="option-card" onclick="selectBudget('low')">
              <span class="option-icon">ğŸ’°</span>
              <div class="option-title">æŠ‘ãˆã‚</div>
              <div class="option-description">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«æ¥½ã—ã¿ãŸã„</div>
            </div>
            <div class="option-card" onclick="selectBudget('medium')">
              <span class="option-icon">ğŸ’°ğŸ’°</span>
              <div class="option-title">ãµã¤ã†</div>
              <div class="option-description">ä¸€èˆ¬çš„ãªäºˆç®—æ„Ÿã§</div>
            </div>
            <div class="option-card" onclick="selectBudget('high')">
              <span class="option-icon">ğŸ’°ğŸ’°ğŸ’°</span>
              <div class="option-title">ã¡ã‚‡ã£ã¨è‰¯ã„</div>
              <div class="option-description">å°‘ã—ç‰¹åˆ¥æ„Ÿã‚’å‡ºã—ãŸã„</div>
            </div>
            <div class="option-card" onclick="selectBudget('no_limit')">
              <span class="option-icon">âœ¨</span>
              <div class="option-title">æ°—ã«ã—ãªã„</div>
              <div class="option-description">è‰¯ã„ãŠåº—ãŒã‚ã‚Œã°</div>
            </div>
          </div>
        </div>
        <div class="button-container">
          <button class="btn btn-secondary" onclick="prevStep()">æˆ»ã‚‹</button>
          <button class="btn btn-primary" id="step4Next" onclick="nextStep()" disabled>æ¬¡ã¸</button>
        </div>
      </div>

      <!-- STEP 5: Movement Style -->
      <div class="step" id="step5">
        <div class="step-content">
          <h2 class="step-title">ä»Šæ—¥ã®ãƒ‡ãƒ¼ãƒˆã¯<br>ã©ã‚“ãªæ„Ÿã˜ã§å‹•ããŸã„ã§ã™ã‹ï¼Ÿ</h2>
          <p class="step-subtitle">ç§»å‹•ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã¦ãƒ«ãƒ¼ãƒˆã‚’èª¿æ•´ã—ã¾ã™</p>

          <div class="options-grid">
            <div class="option-card" onclick="selectMovement('single_area')">
              <span class="option-icon">ğŸ˜ï¸</span>
              <div class="option-title">ã²ã¨ã¤ã®è¡—ã§ã‚†ã£ãã‚Š</div>
              <div class="option-description">ç§»å‹•ã¯å°‘ãªã‚ã§è½ã¡ç€ã„ã¦éã”ã™</div>
            </div>
            <div class="option-card" onclick="selectMovement('nearby_areas')">
              <span class="option-icon">ğŸš¶</span>
              <div class="option-title">è¿‘ãã®ã‚¨ãƒªã‚¢ã‚’å°‘ã—å›ã‚‹</div>
              <div class="option-description">å¾’æ­©åœå†…ã§2ã€œ3ã‚¨ãƒªã‚¢</div>
            </div>
            <div class="option-card" onclick="selectMovement('multiple_areas')">
              <span class="option-icon">ğŸšƒ</span>
              <div class="option-title">ã„ãã¤ã‹ã®è¡—ã‚’å·¡ã‚ŠãŸã„</div>
              <div class="option-description">é›»è»Šç§»å‹•ã‚‚å«ã‚ã¦è¤‡æ•°ã‚¨ãƒªã‚¢</div>
            </div>
            <div class="option-card" onclick="selectMovement('day_trip')">
              <span class="option-icon">ğŸš…</span>
              <div class="option-title">é å‡ºã—ãŸã„ï¼ˆæ—¥å¸°ã‚Šï¼‰</div>
              <div class="option-description">å°‘ã—é ãã¾ã§è¶³ã‚’ä¼¸ã°ã™</div>
            </div>
          </div>
        </div>
        <div class="button-container">
          <button class="btn btn-secondary" onclick="prevStep()">æˆ»ã‚‹</button>
          <button class="btn btn-primary" id="step5Next" onclick="nextStep()" disabled>æ¬¡ã¸</button>
        </div>
      </div>

      <!-- STEP 6: Preferred Areas (Conditional) -->
      <div class="step" id="step6">
        <div class="step-content">
          <h2 class="step-title">é€”ä¸­ã§è¡ŒããŸã„<br>ã‚¨ãƒªã‚¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</h2>
          <p class="step-subtitle">ã‚ã‚Œã°é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</p>

          <input type="text" class="search-input" id="areaSearch" placeholder="ã‚¨ãƒªã‚¢åã§æ¤œç´¢"
            oninput="handleAreaSearch(event)">

          <div class="search-suggestions" id="areaSuggestions"></div>

          <div class="chips-container" id="areaChips">
            <div class="chip multi-select" onclick="toggleArea('è¡¨å‚é“')">è¡¨å‚é“</div>
            <div class="chip multi-select" onclick="toggleArea('åŸå®¿')">åŸå®¿</div>
            <div class="chip multi-select" onclick="toggleArea('ä»£å®˜å±±')">ä»£å®˜å±±</div>
            <div class="chip multi-select" onclick="toggleArea('æµæ¯”å¯¿')">æµæ¯”å¯¿</div>
            <div class="chip multi-select" onclick="toggleArea('ä¸­ç›®é»’')">ä¸­ç›®é»’</div>
            <div class="chip" onclick="skipAreas()">ç‰¹ã«ãªã„ï¼ˆãŠã¾ã‹ã›ï¼‰</div>
          </div>
        </div>
        <div class="button-container">
          <button class="btn btn-secondary" onclick="prevStep()">æˆ»ã‚‹</button>
          <button class="btn btn-primary" id="step6Next" onclick="nextStep()">æ¬¡ã¸</button>
        </div>
      </div>

      <!-- STEP 7: Confirmation -->
      <div class="step" id="step7">
        <div class="step-content">
          <h2 class="step-title">å…¥åŠ›å†…å®¹ã®ç¢ºèª</h2>
          <p class="step-subtitle">ã“ã®æ¡ä»¶ã§ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã™</p>

          <div class="confirmation-list" id="confirmationList">
            <!-- Populated by JavaScript -->
          </div>
        </div>
        <div class="button-container">
          <button class="btn btn-secondary" onclick="prevStep()">æˆ»ã£ã¦ä¿®æ­£</button>
          <button class="btn btn-primary" onclick="submitPlan()">ã“ã®æ¡ä»¶ã§ãƒ—ãƒ©ãƒ³ã‚’ä½œã‚‹</button>
        </div>
      </div>

      <!-- Loading State -->
      <div class="step" id="stepLoading">
        <div class="step-content loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Wizard State
    let currentStep = 0;
    let wizardData = {
      start_location: null,
      date_phase: null,
      time_slot: null,
      budget_level: null,
      movement_style: null,
      preferred_areas: []
    };

    // Locations Data
    let locationsData = null;
    let allAreas = [];
    let currentRegion = 'popular';

    // Load locations data
    async function loadLocationsData() {
      try {
        const response = await fetch('/data/locations.json');
        locationsData = await response.json();

        // Build flat list of all areas for search
        allAreas = [];
        locationsData.regions.forEach(region => {
          region.prefectures.forEach(pref => {
            pref.cities.forEach(city => {
              city.areas.forEach(area => {
                allAreas.push({
                  name: area,
                  city: city.name,
                  prefecture: pref.name,
                  region: region.name
                });
              });
            });
          });
        });

        // Initialize location UI
        initializeLocationUI();
      } catch (error) {
        console.error('Failed to load locations:', error);
        // Fallback to common areas
        allAreas = [
          'æ¸‹è°·', 'æ–°å®¿', 'è¡¨å‚é“', 'åŸå®¿', 'æµæ¯”å¯¿', 'ä»£å®˜å±±', 'ä¸­ç›®é»’',
          'å…­æœ¬æœ¨', 'éŠ€åº§', 'ä¸¸ã®å†…', 'æ±äº¬', 'å“å·', 'æ± è¢‹', 'ä¸Šé‡',
          'æµ…è‰', 'ç§‹è‘‰åŸ', 'ãŠå°å ´', 'å‰ç¥¥å¯º', 'ä¸‹åŒ—æ²¢', 'è‡ªç”±ãŒä¸˜'
        ].map(name => ({ name }));
        initializeLocationUI();
      }
    }

    // Initialize location selection UI
    function initializeLocationUI() {
      if (!locationsData || !locationsData.regions) {
        console.error('Locations data not loaded properly');
        // Fallback: show simple list
        const container = document.getElementById('locationChipsContainer');
        container.innerHTML = `
          <div class="chips-container">
            <div class="chip" onclick="selectLocation('æ¸‹è°·')">æ¸‹è°·</div>
            <div class="chip" onclick="selectLocation('æ–°å®¿')">æ–°å®¿</div>
            <div class="chip" onclick="selectLocation('æ± è¢‹')">æ± è¢‹</div>
            <div class="chip" onclick="selectLocation('æ¨ªæµœ')">æ¨ªæµœ</div>
            <div class="chip" onclick="selectLocation('å¤§é˜ª')">å¤§é˜ª</div>
            <div class="chip" onclick="selectLocation(null)">æœªå®šï¼ˆãŠã™ã™ã‚ï¼‰</div>
          </div>
        `;
        return;
      }

      // Create region tabs
      const regionTabs = document.getElementById('regionTabs');
      const regions = ['äººæ°—', ...locationsData.regions.map(r => r.name)];

      regionTabs.innerHTML = regions.map((region, index) => {
        const regionKey = index === 0 ? 'popular' : region;
        const isActive = index === 0 ? 'active' : '';
        return `<div class="region-tab ${isActive}" onclick="switchRegion('${regionKey}')">${region}</div>`;
      }).join('');

      // Show popular locations by default
      showLocationsByRegion('popular');
    }

    // Switch region tab
    function switchRegion(regionKey) {
      currentRegion = regionKey;

      // Update active tab
      document.querySelectorAll('.region-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show locations
      showLocationsByRegion(regionKey);
    }

    // Show locations for selected region
    function showLocationsByRegion(regionKey) {
      const container = document.getElementById('locationChipsContainer');

      if (regionKey === 'popular') {
        // Show popular areas
        const popularAreas = locationsData.popular;
        container.innerHTML = `
          <div class="chips-container">
            ${popularAreas.map(area =>
              `<div class="chip" onclick="selectLocation('${area}')">${area}</div>`
            ).join('')}
            <div class="chip" onclick="selectLocation(null)">æœªå®šï¼ˆãŠã™ã™ã‚ï¼‰</div>
          </div>
        `;
      } else {
        // Show areas by prefecture
        const region = locationsData.regions.find(r => r.name === regionKey);
        if (!region) return;

        container.innerHTML = region.prefectures.map(pref => {
          const allAreas = pref.cities.flatMap(city => city.areas);
          return `
            <div class="location-category">
              <div class="category-title">${pref.name}</div>
              <div class="chips-container">
                ${allAreas.map(area =>
                  `<div class="chip" onclick="selectLocation('${area}')">${area}</div>`
                ).join('')}
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // Navigation
    function nextStep() {
      // Hide current step
      document.getElementById(`step${currentStep}`).classList.remove('active');

      // Determine next step
      currentStep++;

      // Skip step 6 if movement style is single_area or nearby_areas
      if (currentStep === 6 &&
        (wizardData.movement_style === 'single_area' ||
          wizardData.movement_style === 'nearby_areas')) {
        currentStep = 7;
      }

      // Show progress indicator after step 0
      if (currentStep === 1) {
        document.getElementById('progressContainer').style.display = 'block';
      }

      // Update progress
      updateProgress();

      // Show confirmation if step 7
      if (currentStep === 7) {
        populateConfirmation();
      }

      // Show next step
      document.getElementById(`step${currentStep}`).classList.add('active');

      // Scroll to top
      window.scrollTo(0, 0);
    }

    function prevStep() {
      // Hide current step
      document.getElementById(`step${currentStep}`).classList.remove('active');

      // Determine previous step
      currentStep--;

      // Skip step 6 if movement style is single_area or nearby_areas
      if (currentStep === 6 &&
        (wizardData.movement_style === 'single_area' ||
          wizardData.movement_style === 'nearby_areas')) {
        currentStep = 5;
      }

      // Hide progress indicator if back to step 0
      if (currentStep === 0) {
        document.getElementById('progressContainer').style.display = 'none';
      }

      // Update progress
      updateProgress();

      // Show previous step
      document.getElementById(`step${currentStep}`).classList.add('active');

      // Scroll to top
      window.scrollTo(0, 0);
    }

    function updateProgress() {
      const totalSteps = wizardData.movement_style === 'multiple_areas' ||
        wizardData.movement_style === 'day_trip' ? 6 : 5;
      const progress = ((currentStep) / totalSteps) * 100;

      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('progressText').textContent = `${currentStep} / ${totalSteps}`;
    }

    // LocalStorage key for location history
    const LOCATION_HISTORY_KEY = 'dateai_location_history';

    // STEP 1: Location Selection
    function selectLocation(location) {
      wizardData.start_location = location;

      // Update UI - é¸æŠã•ã‚ŒãŸåœ°åŸŸã®ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
      const displayDiv = document.getElementById('selectedLocationDisplay');
      displayDiv.innerHTML = `
        <div class="selected-location-badge">
          <span class="icon">ğŸ“</span>
          <span>${location || 'æœªå®šï¼ˆãŠã™ã™ã‚ï¼‰'}</span>
          <span class="close-btn" onclick="clearLocationSelection()">Ã—</span>
        </div>
      `;

      // Update all chips
      const chips = document.querySelectorAll('#locationChipsContainer .chip');
      chips.forEach(chip => chip.classList.remove('selected'));
      if (event && event.target) {
        event.target.classList.add('selected');
      }

      // Clear search input
      document.getElementById('locationSearch').value = '';
      document.getElementById('locationSuggestions').classList.remove('active');

      // Save to history
      if (location) {
        saveLocationToHistory(location);
      }

      // Enable next button
      document.getElementById('step1Next').disabled = false;
    }

    function clearLocationSelection() {
      wizardData.start_location = null;
      document.getElementById('selectedLocationDisplay').innerHTML = '';
      document.getElementById('step1Next').disabled = true;

      // Clear all selections
      const chips = document.querySelectorAll('#locationChipsContainer .chip');
      chips.forEach(chip => chip.classList.remove('selected'));
    }

    function handleLocationSearch(event) {
      const query = event.target.value.toLowerCase();
      const suggestions = document.getElementById('locationSuggestions');
      const historySection = document.getElementById('historySection');

      if (query.length < 1) {
        suggestions.classList.remove('active');
        // Show history when search is empty
        showSearchHistory();
        return;
      }

      // Hide history when searching
      historySection.style.display = 'none';

      // Search in all areas
      const matches = allAreas.filter(area =>
        area.name.toLowerCase().includes(query)
      ).slice(0, 10); // Limit to 10 results

      if (matches.length > 0) {
        suggestions.innerHTML = matches.map(area => {
          const label = area.prefecture
            ? `${area.name} <span style="color: #888; font-size: 0.9em;">(${area.prefecture})</span>`
            : area.name;
          return `<div class="suggestion-item" onclick="selectLocationFromSearch('${area.name.replace(/'/g, "\\'")}')"><strong>${label}</strong></div>`;
        }).join('');
        suggestions.classList.add('active');
      } else {
        suggestions.innerHTML = `<div class="suggestion-item" style="color: #999; cursor: default;">è©²å½“ã™ã‚‹ã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>`;
        suggestions.classList.add('active');
      }
    }

    function selectLocationFromSearch(location) {
      // Create a fake event object for selectLocation
      window.event = { target: null };
      selectLocation(location);
      document.getElementById('locationSuggestions').classList.remove('active');
      document.getElementById('historySection').style.display = 'none';
    }

    // å±¥æ­´ç®¡ç†æ©Ÿèƒ½
    function saveLocationToHistory(location) {
      let history = JSON.parse(localStorage.getItem(LOCATION_HISTORY_KEY) || '[]');

      // Remove if already exists
      history = history.filter(item => item.location !== location);

      // Add to beginning with timestamp
      history.unshift({
        location: location,
        timestamp: Date.now()
      });

      // Keep only last 5 items
      history = history.slice(0, 5);

      localStorage.setItem(LOCATION_HISTORY_KEY, JSON.stringify(history));
    }

    function showSearchHistory() {
      const query = document.getElementById('locationSearch').value;
      if (query.length > 0) return; // Don't show history if searching

      const historySection = document.getElementById('historySection');
      const historyChips = document.getElementById('historyChips');
      const history = JSON.parse(localStorage.getItem(LOCATION_HISTORY_KEY) || '[]');

      if (history.length === 0) {
        historySection.style.display = 'none';
        return;
      }

      historyChips.innerHTML = history.map(item => {
        const timeAgo = getTimeAgo(item.timestamp);
        return `
          <div class="history-chip" onclick="selectLocationFromSearch('${item.location.replace(/'/g, "\\'")}')">
            <span>${item.location}</span>
            <span class="time">${timeAgo}</span>
          </div>
        `;
      }).join('');

      historySection.style.display = 'block';
    }

    function getTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'ãŸã£ãŸä»Š';
      if (minutes < 60) return `${minutes}åˆ†å‰`;
      if (hours < 24) return `${hours}æ™‚é–“å‰`;
      if (days < 7) return `${days}æ—¥å‰`;
      return '1é€±é–“ä»¥ä¸Šå‰';
    }

    // ä½ç½®æƒ…å ±å–å¾—æ©Ÿèƒ½
    async function detectCurrentLocation() {
      const btn = document.getElementById('detectLocationBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>ğŸ“</span><span>ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</span>';

      if (!navigator.geolocation) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸ“</span><span>ç¾åœ¨åœ°ã‹ã‚‰è¿‘ãã®ã‚¨ãƒªã‚¢ã‚’æ¢ã™</span>';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;
          console.log('Current position:', latitude, longitude);

          // Find nearest location from our data
          const nearestLocation = findNearestLocation(latitude, longitude);

          if (nearestLocation) {
            btn.innerHTML = `<span>âœ…</span><span>è¿‘ãã®ã‚¨ãƒªã‚¢: ${nearestLocation}</span>`;
            setTimeout(() => {
              selectLocationFromSearch(nearestLocation);
              btn.disabled = false;
              btn.innerHTML = '<span>ğŸ“</span><span>ç¾åœ¨åœ°ã‹ã‚‰è¿‘ãã®ã‚¨ãƒªã‚¢ã‚’æ¢ã™</span>';
            }, 1500);
          } else {
            alert('è¿‘ãã®ã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            btn.disabled = false;
            btn.innerHTML = '<span>ğŸ“</span><span>ç¾åœ¨åœ°ã‹ã‚‰è¿‘ãã®ã‚¨ãƒªã‚¢ã‚’æ¢ã™</span>';
          }
        },
        (error) => {
          console.error('Geolocation error:', error);
          alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
          btn.disabled = false;
          btn.innerHTML = '<span>ğŸ“</span><span>ç¾åœ¨åœ°ã‹ã‚‰è¿‘ãã®ã‚¨ãƒªã‚¢ã‚’æ¢ã™</span>';
        }
      );
    }

    function findNearestLocation(lat, lng) {
      // å…¨å›½ã®ä¸»è¦éƒ½å¸‚ãƒ»ã‚¨ãƒªã‚¢ã®åº§æ¨™ãƒ‡ãƒ¼ã‚¿
      const cityCoordinates = {
        // åŒ—æµ·é“
        'æœ­å¹Œé§…': { lat: 43.0686, lng: 141.3507 },
        'å°æ¨½': { lat: 43.1907, lng: 140.9947 },
        'å‡½é¤¨': { lat: 41.7688, lng: 140.7289 },
        'æ—­å·': { lat: 43.7706, lng: 142.3650 },
        // æ±åŒ—
        'ä»™å°é§…': { lat: 38.2604, lng: 140.8819 },
        'é’æ£®é§…': { lat: 40.8244, lng: 140.7401 },
        'ç››å²¡é§…': { lat: 39.7017, lng: 141.1527 },
        'ç§‹ç”°é§…': { lat: 39.7186, lng: 140.1028 },
        'å±±å½¢é§…': { lat: 38.2405, lng: 140.3280 },
        'ç¦å³¶é§…': { lat: 37.7544, lng: 140.4611 },
        // é–¢æ±
        'æ¸‹è°·': { lat: 35.6595, lng: 139.7004 },
        'æ–°å®¿': { lat: 35.6938, lng: 139.7034 },
        'æ± è¢‹': { lat: 35.7295, lng: 139.7109 },
        'æ¨ªæµœ': { lat: 35.4437, lng: 139.6380 },
        'éŠ€åº§': { lat: 35.6715, lng: 139.7656 },
        'å…­æœ¬æœ¨': { lat: 35.6627, lng: 139.7291 },
        'å“å·': { lat: 35.6284, lng: 139.7387 },
        'ä¸Šé‡': { lat: 35.7141, lng: 139.7774 },
        'æµ…è‰': { lat: 35.7148, lng: 139.7967 },
        'å‰ç¥¥å¯º': { lat: 35.7033, lng: 139.5797 },
        'å·è¶Š': { lat: 35.9251, lng: 139.4857 },
        'å¤§å®®': { lat: 35.9063, lng: 139.6287 },
        'åƒè‘‰': { lat: 35.6074, lng: 140.1065 },
        'èˆ¹æ©‹': { lat: 35.6950, lng: 139.9838 },
        'å®‡éƒ½å®®': { lat: 36.5658, lng: 139.8836 },
        'å‰æ©‹': { lat: 36.3911, lng: 139.0608 },
        'é«˜å´': { lat: 36.3229, lng: 139.0026 },
        'æ°´æˆ¸': { lat: 36.3418, lng: 140.4468 },
        // ä¸­éƒ¨
        'åå¤å±‹': { lat: 35.1815, lng: 136.9066 },
        'é™å²¡': { lat: 34.9769, lng: 138.3831 },
        'æµœæ¾': { lat: 34.7108, lng: 137.7261 },
        'æ–°æ½Ÿ': { lat: 37.9161, lng: 139.0364 },
        'å¯Œå±±': { lat: 36.6953, lng: 137.2113 },
        'é‡‘æ²¢': { lat: 36.5944, lng: 136.6256 },
        'ç¦äº•': { lat: 36.0651, lng: 136.2216 },
        'é•·é‡': { lat: 36.6485, lng: 138.1881 },
        'æ¾æœ¬': { lat: 36.2380, lng: 137.9723 },
        'å²é˜œ': { lat: 35.4231, lng: 136.7606 },
        'ç”²åºœ': { lat: 35.6636, lng: 138.5684 },
        // é–¢è¥¿
        'å¤§é˜ª': { lat: 34.6937, lng: 135.5023 },
        'æ¢…ç”°': { lat: 34.7024, lng: 135.4959 },
        'é›£æ³¢': { lat: 34.6661, lng: 135.5000 },
        'äº¬éƒ½': { lat: 35.0116, lng: 135.7681 },
        'ç¥æˆ¸': { lat: 34.6901, lng: 135.1955 },
        'å¥ˆè‰¯': { lat: 34.6851, lng: 135.8050 },
        'å’Œæ­Œå±±': { lat: 34.2261, lng: 135.1675 },
        'å¤§æ´¥': { lat: 35.0045, lng: 135.8686 },
        // ä¸­å›½
        'åºƒå³¶': { lat: 34.3853, lng: 132.4553 },
        'å²¡å±±': { lat: 34.6617, lng: 133.9350 },
        'å€‰æ•·': { lat: 34.5958, lng: 133.7721 },
        'é³¥å–': { lat: 35.5014, lng: 134.2381 },
        'æ¾æ±Ÿ': { lat: 35.4723, lng: 133.0506 },
        'å±±å£': { lat: 34.1859, lng: 131.4706 },
        'ä¸‹é–¢': { lat: 33.9558, lng: 130.9408 },
        // å››å›½
        'é«˜æ¾': { lat: 34.3402, lng: 134.0434 },
        'æ¾å±±': { lat: 33.8393, lng: 132.7657 },
        'é«˜çŸ¥': { lat: 33.5597, lng: 133.5311 },
        'å¾³å³¶': { lat: 34.0658, lng: 134.5594 },
        // ä¹å·ãƒ»æ²–ç¸„
        'ç¦å²¡': { lat: 33.5904, lng: 130.4017 },
        'åšå¤š': { lat: 33.5897, lng: 130.4206 },
        'å¤©ç¥': { lat: 33.5904, lng: 130.4017 },
        'åŒ—ä¹å·': { lat: 33.8834, lng: 130.8751 },
        'ä¹…ç•™ç±³': { lat: 33.3192, lng: 130.5083 },
        'ä½è³€': { lat: 33.2498, lng: 130.2988 },
        'é•·å´': { lat: 32.7503, lng: 129.8779 },
        'ç†Šæœ¬': { lat: 32.7898, lng: 130.7417 },
        'å¤§åˆ†': { lat: 33.2382, lng: 131.6126 },
        'å®®å´': { lat: 31.9077, lng: 131.4202 },
        'é¹¿å…å³¶': { lat: 31.5966, lng: 130.5571 },
        'é‚£è¦‡': { lat: 26.2124, lng: 127.6809 }
      };

      let nearestCity = null;
      let minDistance = Infinity;

      for (const [city, coords] of Object.entries(cityCoordinates)) {
        const distance = calculateDistance(lat, lng, coords.lat, coords.lng);
        if (distance < minDistance) {
          minDistance = distance;
          nearestCity = city;
        }
      }

      // 100kmä»¥å†…ãªã‚‰æ¡ç”¨ï¼ˆåœ°æ–¹éƒ½å¸‚ã‚‚è€ƒæ…®ã—ã¦ç¯„å›²æ‹¡å¤§ï¼‰
      return minDistance < 100 ? nearestCity : null;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // STEP 2: Date Phase Selection
    function selectDatePhase(phase) {
      wizardData.date_phase = phase;

      // Update UI
      const cards = document.querySelectorAll('#step2 .option-card');
      cards.forEach(card => card.classList.remove('selected'));
      event.target.closest('.option-card').classList.add('selected');

      // Enable next button
      document.getElementById('step2Next').disabled = false;
    }

    // STEP 3: Time Slot Selection
    function selectTimeSlot(slot) {
      wizardData.time_slot = slot;

      // Update UI
      const chips = document.querySelectorAll('#step3 .chip');
      chips.forEach(chip => chip.classList.remove('selected'));
      event.target.classList.add('selected');

      // Enable next button
      document.getElementById('step3Next').disabled = false;
    }

    // STEP 4: Budget Selection
    function selectBudget(budget) {
      wizardData.budget_level = budget;

      // Update UI
      const cards = document.querySelectorAll('#step4 .option-card');
      cards.forEach(card => card.classList.remove('selected'));
      event.target.closest('.option-card').classList.add('selected');

      // Enable next button
      document.getElementById('step4Next').disabled = false;
    }

    // STEP 5: Movement Style Selection
    function selectMovement(style) {
      wizardData.movement_style = style;

      // Update UI
      const cards = document.querySelectorAll('#step5 .option-card');
      cards.forEach(card => card.classList.remove('selected'));
      event.target.closest('.option-card').classList.add('selected');

      // Enable next button
      document.getElementById('step5Next').disabled = false;
    }

    // STEP 6: Preferred Areas (Multi-select)
    function toggleArea(area) {
      const index = wizardData.preferred_areas.indexOf(area);

      if (index > -1) {
        wizardData.preferred_areas.splice(index, 1);
        event.target.classList.remove('selected');
      } else {
        wizardData.preferred_areas.push(area);
        event.target.classList.add('selected');
      }
    }

    function skipAreas() {
      wizardData.preferred_areas = [];

      // Clear selections
      const chips = document.querySelectorAll('#areaChips .chip.multi-select');
      chips.forEach(chip => chip.classList.remove('selected'));

      // Proceed to next step
      nextStep();
    }

    function handleAreaSearch(event) {
      const query = event.target.value.toLowerCase();
      const suggestions = document.getElementById('areaSuggestions');

      if (query.length < 1) {
        suggestions.classList.remove('active');
        return;
      }

      const matches = commonAreas.filter(area =>
        area.toLowerCase().includes(query) &&
        !wizardData.preferred_areas.includes(area)
      );

      if (matches.length > 0) {
        suggestions.innerHTML = matches.map(area =>
          `<div class="suggestion-item" onclick="addAreaFromSearch('${area}')">${area}</div>`
        ).join('');
        suggestions.classList.add('active');
      } else {
        suggestions.classList.remove('active');
      }
    }

    function addAreaFromSearch(area) {
      wizardData.preferred_areas.push(area);
      document.getElementById('areaSearch').value = '';
      document.getElementById('areaSuggestions').classList.remove('active');

      // Add visual feedback (you could dynamically add chip here)
      alert(`ã€Œ${area}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }

    // STEP 7: Confirmation
    function populateConfirmation() {
      const labels = {
        start_location: 'ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹',
        date_phase: 'é–¢ä¿‚æ€§',
        time_slot: 'æ™‚é–“å¸¯',
        budget_level: 'äºˆç®—',
        movement_style: 'å‹•ãæ–¹',
        preferred_areas: 'é€”ä¸­ã§è¡ŒããŸã„ã‚¨ãƒªã‚¢'
      };

      const values = {
        start_location: wizardData.start_location || 'ãŠã¾ã‹ã›',
        date_phase: getDatePhaseLabel(wizardData.date_phase),
        time_slot: getTimeSlotLabel(wizardData.time_slot),
        budget_level: getBudgetLabel(wizardData.budget_level),
        movement_style: getMovementLabel(wizardData.movement_style),
        preferred_areas: wizardData.preferred_areas.length > 0
          ? wizardData.preferred_areas.join('ã€')
          : 'ãŠã¾ã‹ã›'
      };

      let html = '';
      for (const [key, label] of Object.entries(labels)) {
        // Skip preferred_areas if movement style doesn't require it
        if (key === 'preferred_areas' &&
          (wizardData.movement_style === 'single_area' ||
            wizardData.movement_style === 'nearby_areas')) {
          continue;
        }

        html += `
          <div class="confirmation-item">
            <div class="confirmation-label">${label}</div>
            <div class="confirmation-value">${values[key]}</div>
          </div>
        `;
      }

      document.getElementById('confirmationList').innerHTML = html;
    }

    function getDatePhaseLabel(phase) {
      const labels = {
        'first': 'åˆãƒ‡ãƒ¼ãƒˆ',
        'second': '2ã€œ3å›ç›®',
        'casual': 'ä»˜ãåˆã£ã¦ã„ã‚‹',
        'anniversary': 'è¨˜å¿µæ—¥ãƒ»ç‰¹åˆ¥ãªæ—¥'
      };
      return labels[phase] || phase;
    }

    function getTimeSlotLabel(slot) {
      const labels = {
        'lunch': 'æ˜¼',
        'evening': 'å¤œ',
        'half_day': 'åŠæ—¥',
        'undecided': 'ãŠã¾ã‹ã›'
      };
      return labels[slot] || slot;
    }

    function getBudgetLabel(budget) {
      const labels = {
        'low': 'æŠ‘ãˆã‚',
        'medium': 'ãµã¤ã†',
        'high': 'ã¡ã‚‡ã£ã¨è‰¯ã„',
        'no_limit': 'æ°—ã«ã—ãªã„'
      };
      return labels[budget] || budget;
    }

    function getMovementLabel(style) {
      const labels = {
        'single_area': 'ã²ã¨ã¤ã®è¡—ã§ã‚†ã£ãã‚Š',
        'nearby_areas': 'è¿‘ãã®ã‚¨ãƒªã‚¢ã‚’å°‘ã—å›ã‚‹',
        'multiple_areas': 'ã„ãã¤ã‹ã®è¡—ã‚’å·¡ã‚ŠãŸã„',
        'day_trip': 'é å‡ºã—ãŸã„ï¼ˆæ—¥å¸°ã‚Šï¼‰'
      };
      return labels[style] || style;
    }

    // Submit
    async function submitPlan() {
      // Show loading
      document.getElementById('step7').classList.remove('active');
      document.getElementById('stepLoading').classList.add('active');

      try {
        console.log('[Wizard] App Version: v2.1 (Debug)');
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const port = window.location.port;
        console.log(`[Wizard] Env Check: Host=${hostname}, Proto=${protocol}, Port=${port}`);

        console.log('Submitting plan data:', wizardData);

        // ç’°å¢ƒåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1';
        const isFile = protocol === 'file:';

        // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ã€æ˜ç¤ºçš„ã«localhost:3001ã‚’æŒ‡å®š
        // ãã‚Œä»¥å¤–ï¼ˆVercelç­‰ã®æœ¬ç•ªç’°å¢ƒï¼‰ã¯ç›¸å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨ï¼ˆåŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®/api/generate-planã‚’å©ãï¼‰
        const API_BASE = (isLocal || isFile) ? 'http://localhost:3001' : '';

        console.log(`[Wizard] Target API URL: ${API_BASE}/api/generate-plan`);

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        const response = await fetch(`${API_BASE}/api/generate-plan`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            wizard_data: wizardData
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`[Wizard] API Error: ${response.status} ${response.statusText}`, errorText);
          throw new Error(response.status === 504 ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' : `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${response.status})`);
        }

        const result = await response.json();

        if (result.success) {
          // ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜
          localStorage.setItem('generatedPlan', JSON.stringify(result.plan));
          localStorage.setItem('wizardData', JSON.stringify(wizardData));

          // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰è¿”ã•ã‚ŒãŸæ¡ä»¶ãŒã‚ã‚Œã°ä¿å­˜ï¼ˆä»£æ›¿ã‚¹ãƒãƒƒãƒˆæ¤œç´¢ã«å¿…è¦ï¼‰
          if (result.conditions) {
            localStorage.setItem('currentConditions', JSON.stringify(result.conditions));
          }

          // æ—¢å­˜ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤ºãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          // Vercelç’°å¢ƒã§ã¯ /index.html ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
          const redirectPath = (isLocal || isFile)
            ? `${API_BASE}/frontend/index.html?from=wizard`
            : `${window.location.origin}/index.html?from=wizard`;
          window.location.href = redirectPath;
        } else {
          throw new Error(result.error || 'ãƒ—ãƒ©ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Error submitting plan:', error);

        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å‰ã®ç”»é¢ã«æˆ»ã‚‹
        document.getElementById('stepLoading').classList.remove('active');
        document.getElementById('step7').classList.add('active');

        alert(`ãƒ—ãƒ©ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š${error.message}\nã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`);
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadLocationsData();
    });
  </script>
</body>

</html>